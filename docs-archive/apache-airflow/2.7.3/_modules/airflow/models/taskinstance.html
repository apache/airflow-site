



<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
    <html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
        <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>airflow.models.taskinstance &mdash; Airflow Documentation</title>
    <link rel="stylesheet" href="../../../_static/_gen/css/main.min.css" type="text/css" />
            <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
            <link rel="stylesheet" type="text/css" href="../../../_static/_gen/css/main.min.css" />
            <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
            <link rel="stylesheet" type="text/css" href="../../../_static/_gen/css/main-custom.min.css" />
            <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
            <link rel="shortcut icon" href="../../../_static/pin_32.png"/>
            <link rel="index" title="Index" href="../../../genindex.html" />
            <link rel="search" title="Search" href="../../../search.html" />

    <link rel="canonical" href="https://airflow.apache.org/docs/apache-airflow/stable/_modules/airflow/models/taskinstance.html" />

    <!-- Matomo -->
    <script>
        var _paq = window._paq = window._paq || [];
        /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
        /* We explicitly disable cookie tracking to avoid privacy issues */
        _paq.push(['disableCookies']);
        _paq.push(['trackPageView']);
        _paq.push(['enableLinkTracking']);
        (function() {
        var u="https://analytics.apache.org/";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '13']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
        })();
    </script>
    <!-- End Matomo Code -->

    
</head><body class="td-section">
    

<header>
    <nav class="js-navbar-scroll navbar">
        <div class="navbar__icon-container">
            <a href="/">
                <svg xmlns="http://www.w3.org/2000/svg" width="155.314" height="60" viewBox="0 0 155.314 60">
                    <defs>
                        <clipPath id="clip-path">
                            <path id="Rectangle_1" d="M0 0h155.314v60H0z" fill="none" data-name="Rectangle 1"></path>
                        </clipPath>
                    </defs>
                    <g id="logo" transform="translate(-1305 -780.355)">
                        <g id="Group_2" clip-path="url(#clip-path)" data-name="Group 2" transform="translate(1305 780.355)">
                            <g id="Group_1" data-name="Group 1" transform="translate(.486 .486)">
                                <path id="Path_1" d="M1307.562 880.867l28.187-28.893a.521.521 0 0 0 .063-.666c-1.714-2.393-4.877-2.808-6.049-4.416-3.472-4.763-4.353-7.459-5.845-7.292a.456.456 0 0 0-.271.143l-10.182 10.438c-5.858 6-6.7 19.225-6.852 30.3a.552.552 0 0 0 .949.386z" fill="#017cee" data-name="Path 1" transform="translate(-1306.613 -822.232)"></path>
                                <path id="Path_2" d="M1405.512 908.489l-28.893-28.189a.521.521 0 0 0-.667-.063c-2.393 1.715-2.808 4.877-4.416 6.049-4.763 3.472-7.459 4.353-7.292 5.845a.456.456 0 0 0 .143.27l10.438 10.182c6 5.858 19.225 6.7 30.3 6.852a.552.552 0 0 0 .387-.946z" fill="#00ad46" data-name="Path 2" transform="translate(-1346.876 -850.567)"></path>
                                <path id="Path_3" d="M1373.909 902.252c-3.28-3.2-4.8-9.53 1.486-22.583-10.219 4.567-13.8 10.57-12.039 12.289z" fill="#04d659" data-name="Path 3" transform="translate(-1345.96 -850.233)"></path>
                                <path id="Path_4" d="M1433.132 782.359l-28.186 28.893a.52.52 0 0 0-.063.666c1.715 2.393 4.876 2.808 6.049 4.416 3.472 4.763 4.354 7.459 5.845 7.292a.454.454 0 0 0 .271-.143l10.182-10.438c5.858-6 6.7-19.225 6.852-30.3a.553.553 0 0 0-.95-.386z" fill="#00c7d4" data-name="Path 4" transform="translate(-1375.21 -782.123)"></path>
                                <path id="Path_5" d="M1426.9 881.155c-3.2 3.28-9.53 4.8-22.584-1.486 4.567 10.219 10.57 13.8 12.289 12.039z" fill="#11e1ee" data-name="Path 5" transform="translate(-1374.875 -850.233)"></path>
                                <path id="Path_6" d="M1307 782.919l28.893 28.186a.521.521 0 0 0 .666.063c2.393-1.715 2.808-4.877 4.416-6.049 4.763-3.472 7.459-4.353 7.292-5.845a.459.459 0 0 0-.143-.271l-10.438-10.182c-6-5.858-19.225-6.7-30.3-6.852a.552.552 0 0 0-.386.95z" fill="#e43921" data-name="Path 6" transform="translate(-1306.766 -781.97)"></path>
                                <path id="Path_7" d="M1405.8 804.711c3.28 3.2 4.8 9.53-1.486 22.584 10.219-4.567 13.8-10.571 12.039-12.289z" fill-rule="evenodd" fill="#ff7557" data-name="Path 7" transform="translate(-1374.875 -797.859)"></path>
                                <path id="Path_8" d="M1329.355 849.266c3.2-3.28 9.53-4.8 22.584 1.486-4.567-10.219-10.57-13.8-12.289-12.039z" fill="#0cb6ff" data-name="Path 8" transform="translate(-1322.503 -821.316)"></path>
                                <circle id="Ellipse_1" cx="1.26" cy="1.26" r="1.26" fill="#4a4848" data-name="Ellipse 1" transform="translate(28.18 28.171)"></circle>
                                <path id="Path_9" d="M1527.558 827.347a.229.229 0 0 1-.223-.223.458.458 0 0 1 .011-.123l2.766-7.214a.346.346 0 0 1 .357-.245h.758a.348.348 0 0 1 .357.245l2.754 7.214.022.123a.228.228 0 0 1-.223.223h-.568a.288.288 0 0 1-.19-.056.352.352 0 0 1-.089-.134l-.613-1.583h-3.657l-.613 1.583a.317.317 0 0 1-.1.134.269.269 0 0 1-.178.056zm4.795-2.732l-1.505-3.958-1.505 3.958zm3.322 4.85a.258.258 0 0 1-.189-.078.241.241 0 0 1-.067-.178v-7.4a.241.241 0 0 1 .067-.178.258.258 0 0 1 .189-.078h.513a.268.268 0 0 1 .256.256v.49a2.118 2.118 0 0 1 1.828-.858 2.092 2.092 0 0 1 1.751.736 3.135 3.135 0 0 1 .636 1.9q.011.122.011.379t-.011.379a3.168 3.168 0 0 1-.636 1.9 2.111 2.111 0 0 1-1.751.736 2.154 2.154 0 0 1-1.806-.836v2.587a.241.241 0 0 1-.067.178.223.223 0 0 1-.179.078zm2.364-2.91a1.324 1.324 0 0 0 1.149-.491 2.266 2.266 0 0 0 .4-1.293q.011-.111.011-.323 0-2.107-1.562-2.107a1.365 1.365 0 0 0-1.159.513 2.111 2.111 0 0 0-.412 1.2l-.012.424.012.435a1.862 1.862 0 0 0 .424 1.149 1.4 1.4 0 0 0 1.148.493zm5.628.9a2.329 2.329 0 0 1-1.015-.223 1.94 1.94 0 0 1-.747-.6 1.487 1.487 0 0 1-.268-.859 1.459 1.459 0 0 1 .6-1.2 3.4 3.4 0 0 1 1.65-.624l1.661-.234v-.323q0-1.137-1.3-1.137a1.4 1.4 0 0 0-.8.212 1.376 1.376 0 0 0-.468.48.305.305 0 0 1-.089.145.18.18 0 0 1-.134.045h-.48a.23.23 0 0 1-.245-.245 1.17 1.17 0 0 1 .245-.6 1.931 1.931 0 0 1 .747-.591 2.7 2.7 0 0 1 1.238-.256 2.351 2.351 0 0 1 1.8.591 2.032 2.032 0 0 1 .547 1.45v3.613a.257.257 0 0 1-.078.19.24.24 0 0 1-.178.067h-.513a.233.233 0 0 1-.257-.256v-.479a1.923 1.923 0 0 1-.714.6 2.557 2.557 0 0 1-1.203.237zm.234-.836a1.579 1.579 0 0 0 1.182-.469 1.881 1.881 0 0 0 .468-1.371v-.312l-1.293.19a2.918 2.918 0 0 0-1.193.379.761.761 0 0 0-.4.658.784.784 0 0 0 .368.691 1.585 1.585 0 0 0 .867.237zm6.643.836a2.556 2.556 0 0 1-1.873-.669 2.738 2.738 0 0 1-.714-1.9l-.011-.446.011-.446a2.7 2.7 0 0 1 .714-1.885 2.531 2.531 0 0 1 1.873-.68 2.917 2.917 0 0 1 1.36.29 2.077 2.077 0 0 1 .825.714 1.7 1.7 0 0 1 .3.848.2.2 0 0 1-.067.178.281.281 0 0 1-.19.067h-.535a.265.265 0 0 1-.168-.045.458.458 0 0 1-.111-.178 1.428 1.428 0 0 0-.535-.758 1.516 1.516 0 0 0-.87-.234 1.45 1.45 0 0 0-1.1.435 1.952 1.952 0 0 0-.435 1.3l-.011.4.011.379a1.969 1.969 0 0 0 .435 1.316 1.446 1.446 0 0 0 1.1.424 1.577 1.577 0 0 0 .87-.223 1.493 1.493 0 0 0 .535-.769.458.458 0 0 1 .111-.178.228.228 0 0 1 .168-.056h.535a.258.258 0 0 1 .19.078.2.2 0 0 1 .067.178 1.75 1.75 0 0 1-.3.847 2.078 2.078 0 0 1-.825.714 2.876 2.876 0 0 1-1.361.302zm4.078-.112a.233.233 0 0 1-.257-.256v-7.4a.241.241 0 0 1 .067-.178.259.259 0 0 1 .19-.078h.557a.267.267 0 0 1 .257.256v2.6a2.167 2.167 0 0 1 .758-.624 2.353 2.353 0 0 1 1.082-.223 2.067 2.067 0 0 1 1.661.691 2.642 2.642 0 0 1 .6 1.818v3.144a.257.257 0 0 1-.078.19.24.24 0 0 1-.178.067h-.557a.233.233 0 0 1-.256-.256V824a1.775 1.775 0 0 0-.39-1.227 1.387 1.387 0 0 0-1.1-.435 1.481 1.481 0 0 0-1.126.446 1.7 1.7 0 0 0-.412 1.215v3.088a.257.257 0 0 1-.078.19.24.24 0 0 1-.178.067zm8.846.112a2.466 2.466 0 0 1-1.84-.7 2.938 2.938 0 0 1-.747-1.94l-.011-.379.011-.368a2.953 2.953 0 0 1 .758-1.918 2.7 2.7 0 0 1 3.735.078 3.114 3.114 0 0 1 .68 2.119v.19a.257.257 0 0 1-.078.189.241.241 0 0 1-.178.067h-3.858v.1a2.11 2.11 0 0 0 .435 1.238 1.332 1.332 0 0 0 1.081.5 1.563 1.563 0 0 0 .836-.2 1.7 1.7 0 0 0 .491-.435.6.6 0 0 1 .145-.156.391.391 0 0 1 .19-.033h.547a.252.252 0 0 1 .167.056.192.192 0 0 1 .067.156.975.975 0 0 1-.312.591 2.51 2.51 0 0 1-.859.6 3.049 3.049 0 0 1-1.26.248zm1.527-3.434v-.033a1.817 1.817 0 0 0-.424-1.249 1.512 1.512 0 0 0-2.23 0 1.883 1.883 0 0 0-.4 1.249v.033z" fill="#51504f" data-name="Path 9" transform="translate(-1460.834 -808.144)"></path>
                                <path id="Path_10" d="M1527.2 827.081l-.061.061zm-.056-.279l-.08-.031zm2.766-7.214l.08.031zm1.472 0l-.081.029zm2.754 7.214l.084-.015a.064.064 0 0 0 0-.015zm.022.123h.086v-.015zm-.067.156l.06.061zm-.914.011l-.061.061.006.005zm-.089-.134l.081-.027zm-.613-1.583l.08-.031a.086.086 0 0 0-.08-.055zm-3.657 0v-.086a.086.086 0 0 0-.08.055zm-.613 1.583l-.08-.031zm-.1.134l.055.066zm4.047-2.676v.086a.086.086 0 0 0 .08-.116zm-1.505-3.958l.08-.03a.086.086 0 0 0-.16 0zm-1.505 3.958l-.08-.03a.086.086 0 0 0 .08.116zm-1.784 2.646a.128.128 0 0 1-.1-.042l-.122.121a.3.3 0 0 0 .217.092zm-.1-.042a.129.129 0 0 1-.042-.1h-.171a.3.3 0 0 0 .092.217zm-.042-.1a.38.38 0 0 1 .007-.1l-.163-.054a.514.514 0 0 0-.016.15zm.005-.092l2.765-7.214-.16-.061-2.765 7.214zm2.766-7.216a.283.283 0 0 1 .1-.143.3.3 0 0 1 .174-.046v-.172a.47.47 0 0 0-.271.076.453.453 0 0 0-.166.226zm.276-.189h.758v-.172h-.758zm.758 0a.3.3 0 0 1 .175.046.283.283 0 0 1 .1.143l.161-.059a.451.451 0 0 0-.166-.226.47.47 0 0 0-.272-.076zm.277.19l2.754 7.214.16-.061-2.754-7.214zm2.75 7.2l.022.123.169-.031-.022-.123zm.021.107a.13.13 0 0 1-.042.1l.121.121a.3.3 0 0 0 .092-.217zm-.042.1a.13.13 0 0 1-.1.042v.171a.3.3 0 0 0 .217-.092zm-.1.042h-.568v.171h.568zm-.568 0a.206.206 0 0 1-.135-.036l-.11.132a.373.373 0 0 0 .245.076zm-.129-.031a.262.262 0 0 1-.069-.1l-.162.054a.431.431 0 0 0 .11.167zm-.07-.1l-.613-1.584-.16.062.613 1.583zm-.693-1.638h-3.657v.171h3.657zm-3.737.055l-.614 1.584.16.062.613-1.583zm-.615 1.587a.235.235 0 0 1-.075.1l.111.13a.4.4 0 0 0 .126-.172zm-.074.1a.185.185 0 0 1-.124.036v.171a.354.354 0 0 0 .233-.076zm-.124.036h-.569v.171h.569zm4.306-2.677l-1.505-3.958-.16.061 1.505 3.958zm-1.666-3.958l-1.505 3.958.16.061 1.505-3.958zm-1.425 4.075h3.01v-.171h-3.01zm6.143 4.687l-.06.061zm0-7.761l.061.061zm.881 0l-.065.056.01.009zm.078.669h-.086a.086.086 0 0 0 .155.051zm3.579-.123l-.067.053zm.636 1.9h-.086zm0 .758l-.085-.007zm-.636 1.9l.067.054zm-3.557-.1l.068-.052a.086.086 0 0 0-.154.052zm-.067 2.765l-.061-.06zm2.787-3.323l-.069-.051zm.4-1.293l-.085-.008v.005zm-2.709-1.918l-.068-.052zm-.413 1.2h-.086zm-.011.423h-.085zm.011.435h-.086zm.424 1.149l.066-.054zm-1.216 3.315a.173.173 0 0 1-.129-.053l-.121.121a.342.342 0 0 0 .25.1zm-.129-.053a.157.157 0 0 1-.042-.118h-.172a.325.325 0 0 0 .092.239zm-.042-.118v-7.4h-.172v7.4zm0-7.4a.157.157 0 0 1 .042-.118l-.121-.121a.324.324 0 0 0-.092.239zm.042-.118a.173.173 0 0 1 .129-.053v-.172a.342.342 0 0 0-.25.1zm.129-.053h.513v-.172h-.513zm.513 0a.137.137 0 0 1 .113.048l.13-.111a.309.309 0 0 0-.244-.108zm.123.058a.137.137 0 0 1 .048.113h.171a.309.309 0 0 0-.108-.243zm.048.113v.49h.171v-.49zm.155.541a2.033 2.033 0 0 1 1.759-.823v-.171a2.2 2.2 0 0 0-1.9.894zm1.759-.823a2.007 2.007 0 0 1 1.683.7l.135-.106a2.177 2.177 0 0 0-1.818-.768zm1.683.7a3.045 3.045 0 0 1 .617 1.845l.171-.007a3.218 3.218 0 0 0-.654-1.946zm.617 1.85c.007.078.011.2.011.372h.171c0-.171 0-.3-.012-.387zm.011.372c0 .171 0 .294-.011.372l.17.015c.008-.086.012-.216.012-.387zm-.011.376a3.08 3.08 0 0 1-.617 1.846l.134.106a3.25 3.25 0 0 0 .654-1.945zm-.617 1.845a2.025 2.025 0 0 1-1.683.7v.171a2.2 2.2 0 0 0 1.817-.768zm-1.683.7a2.068 2.068 0 0 1-1.739-.8l-.136.1a2.239 2.239 0 0 0 1.874.87zm-1.892-.75v2.587h.172v-2.587zm0 2.587a.156.156 0 0 1-.042.118l.121.121a.325.325 0 0 0 .092-.239zm-.046.123a.138.138 0 0 1-.114.048v.172a.308.308 0 0 0 .244-.108zm-.114.048h-.546v.172h.546zm1.817-2.739a1.408 1.408 0 0 0 1.218-.526l-.138-.1a1.24 1.24 0 0 1-1.079.455zm1.217-.525a2.355 2.355 0 0 0 .419-1.341l-.171-.007a2.182 2.182 0 0 1-.385 1.246zm.418-1.336c.008-.079.012-.19.012-.332h-.172c0 .14 0 .245-.011.315zm.012-.332a2.726 2.726 0 0 0-.407-1.632 1.448 1.448 0 0 0-1.24-.562v.171a1.278 1.278 0 0 1 1.1.492 2.565 2.565 0 0 1 .374 1.53zm-1.647-2.193a1.452 1.452 0 0 0-1.228.547l.136.1a1.282 1.282 0 0 1 1.091-.479zm-1.228.547a2.2 2.2 0 0 0-.43 1.252l.172.008a2.028 2.028 0 0 1 .4-1.157zm-.43 1.254l-.011.424h.171l.011-.424zm-.011.428l.011.435h.172l-.011-.435zm.011.436a1.95 1.95 0 0 0 .443 1.2l.133-.109a1.776 1.776 0 0 1-.4-1.1zm.443 1.2a1.484 1.484 0 0 0 1.214.522v-.171a1.314 1.314 0 0 1-1.082-.459zm5.828 1.117l.037-.077zm-.747-.6l-.07.049zm.335-2.063l.052.068zm1.65-.624l.012.085zm1.661-.234l.012.085a.086.086 0 0 0 .074-.085zm-2.107-1.249l.046.072zm-.468.48l-.075-.042a.083.083 0 0 0-.006.015zm-.089.145l-.054-.067-.007.006zm-.792-.022l-.065.056.009.009zm-.067-.178h-.086zm.245-.6l-.07-.049zm.747-.591l.038.077zm3.033.334l-.063.058zm.468 5.252l.06.061zm-.881 0l-.065.056a.043.043 0 0 0 .009.009zm-.067-.669h.086a.086.086 0 0 0-.156-.048zm-.714.6l-.04-.076zm.223-1.059l-.062-.06zm.468-1.684h.086a.086.086 0 0 0-.1-.085zm-1.293.189l.012.085zm-1.193.379l.046.072zm-.033 1.349l-.047.071zm.635.985a2.241 2.241 0 0 1-.978-.215l-.074.155a2.412 2.412 0 0 0 1.051.231zm-.978-.215a1.859 1.859 0 0 1-.715-.576l-.138.1a2.024 2.024 0 0 0 .779.629zm-.713-.573a1.4 1.4 0 0 1-.253-.81h-.172a1.571 1.571 0 0 0 .283.907zm-.253-.81a1.374 1.374 0 0 1 .569-1.136l-.105-.135a1.544 1.544 0 0 0-.635 1.272zm.569-1.137a3.316 3.316 0 0 1 1.609-.607l-.024-.17a3.481 3.481 0 0 0-1.691.642zm1.609-.607l1.661-.234-.024-.17-1.662.234zm1.735-.319v-.323h-.171v.323zm0-.323a1.156 1.156 0 0 0-.355-.917 1.536 1.536 0 0 0-1.035-.306v.172a1.37 1.37 0 0 1 .922.263.986.986 0 0 1 .3.788zm-1.39-1.223a1.486 1.486 0 0 0-.851.227l.1.142a1.316 1.316 0 0 1 .755-.2zm-.849.226a1.452 1.452 0 0 0-.5.51l.15.084a1.286 1.286 0 0 1 .44-.449zm-.5.524a.226.226 0 0 1-.062.105l.107.134a.391.391 0 0 0 .117-.185zm-.068.112a.1.1 0 0 1-.073.019v.171a.266.266 0 0 0 .194-.07zm-.073.019h-.48v.171h.48zm-.48 0a.18.18 0 0 1-.122-.046l-.112.13a.352.352 0 0 0 .234.087zm-.113-.037a.18.18 0 0 1-.047-.123h-.171a.352.352 0 0 0 .087.234zm-.047-.119a1.1 1.1 0 0 1 .23-.557l-.14-.1a1.253 1.253 0 0 0-.261.648zm.23-.556a1.843 1.843 0 0 1 .715-.564l-.075-.154a2.018 2.018 0 0 0-.78.618zm.716-.564a2.611 2.611 0 0 1 1.2-.247v-.171a2.781 2.781 0 0 0-1.277.266zm1.2-.247a2.268 2.268 0 0 1 1.732.563l.126-.116a2.435 2.435 0 0 0-1.858-.618zm1.733.564a1.945 1.945 0 0 1 .523 1.391h.171a2.117 2.117 0 0 0-.57-1.508zm.523 1.391v3.613h.171v-3.613zm0 3.613a.172.172 0 0 1-.053.129l.121.121a.344.344 0 0 0 .1-.25zm-.053.129a.157.157 0 0 1-.118.042v.171a.326.326 0 0 0 .239-.092zm-.118.042h-.513v.171h.513zm-.513 0a.2.2 0 0 1-.134-.046l-.111.13a.367.367 0 0 0 .245.088zm-.124-.037a.194.194 0 0 1-.047-.134h-.171a.366.366 0 0 0 .087.245zm-.047-.134v-.479h-.171v.479zm-.156-.528a1.846 1.846 0 0 1-.683.575l.079.152a2.012 2.012 0 0 0 .745-.629zm-.683.575a2.476 2.476 0 0 1-1.153.236v.171a2.644 2.644 0 0 0 1.233-.255zm-.919-.429a1.666 1.666 0 0 0 1.244-.494l-.123-.12a1.493 1.493 0 0 1-1.121.442zm1.244-.494a1.969 1.969 0 0 0 .492-1.431h-.171a1.8 1.8 0 0 1-.444 1.312zm.492-1.431v-.312h-.171v.312zm-.1-.4l-1.293.189.025.17 1.293-.189zm-1.293.189a3 3 0 0 0-1.228.393l.095.143a2.837 2.837 0 0 1 1.158-.365zm-1.227.392a.845.845 0 0 0-.441.73h.172a.676.676 0 0 1 .362-.586zm-.441.73a.869.869 0 0 0 .406.762l.095-.142a.7.7 0 0 1-.33-.62zm.408.764a1.673 1.673 0 0 0 .916.247v-.171a1.5 1.5 0 0 1-.823-.221zm5.686.329l-.061.06zm-.714-1.9h-.085zm-.011-.446h-.085zm.011-.446h-.085zm.714-1.885l.061.061zm3.234-.39l-.04.076zm.825.713l-.073.046zm.3.848h-.086zm-.067.178l.056.065zm-.892.022l.054-.067zm-.112-.178l-.081.029zm-.535-.758l-.048.071zm-1.974.2l-.062-.059zm-.435 1.3h-.086zm-.011.4h-.086zm.011.379h-.086zm.435 1.316l-.062.059zm1.974.2l.046.072zm.535-.769l-.079-.033zm.112-.178l.054.067.007-.006zm.892.022l-.061.06zm.067.178l-.085-.009zm-.3.847l-.072-.046zm-.825.714l-.04-.076zm-1.36.2a2.471 2.471 0 0 1-1.814-.644l-.12.122a2.64 2.64 0 0 0 1.933.694zm-1.813-.643a2.653 2.653 0 0 1-.689-1.839l-.171.006a2.822 2.822 0 0 0 .738 1.952zm-.689-1.838l-.011-.446h-.171l.011.446zm-.011-.442l.011-.446h-.171l-.011.446zm.011-.445a2.611 2.611 0 0 1 .689-1.827l-.122-.121a2.78 2.78 0 0 0-.738 1.942zm.689-1.827a2.447 2.447 0 0 1 1.813-.655v-.171a2.617 2.617 0 0 0-1.934.705zm1.813-.655a2.836 2.836 0 0 1 1.32.28l.079-.152a3 3 0 0 0-1.4-.3zm1.32.28a1.99 1.99 0 0 1 .792.683l.145-.091a2.158 2.158 0 0 0-.858-.744zm.793.685a1.617 1.617 0 0 1 .287.8l.171-.009a1.789 1.789 0 0 0-.315-.89zm.287.809a.11.11 0 0 1-.037.1l.112.13a.281.281 0 0 0 .1-.252zm-.037.1a.2.2 0 0 1-.134.046v.171a.369.369 0 0 0 .246-.088zm-.134.046h-.535v.171h.535zm-.535 0a.184.184 0 0 1-.114-.026l-.107.134a.345.345 0 0 0 .221.064zm-.114-.026a.389.389 0 0 1-.086-.144l-.158.066a.533.533 0 0 0 .137.212zm-.084-.14a1.514 1.514 0 0 0-.57-.8l-.093.144a1.343 1.343 0 0 1 .5.715zm-.568-.8a1.6 1.6 0 0 0-.918-.249v.171a1.435 1.435 0 0 1 .822.219zm-.918-.249a1.535 1.535 0 0 0-1.166.462l.124.118a1.364 1.364 0 0 1 1.042-.408zm-1.166.462a2.036 2.036 0 0 0-.458 1.36l.171.006a1.872 1.872 0 0 1 .411-1.249zm-.458 1.361l-.011.4h.171l.011-.4zm-.011.406l.011.379.171-.005-.011-.379zm.011.38a2.052 2.052 0 0 0 .458 1.371l.124-.118a1.889 1.889 0 0 1-.411-1.26zm.458 1.371a1.533 1.533 0 0 0 1.166.451v-.172a1.363 1.363 0 0 1-1.042-.4zm1.166.451a1.661 1.661 0 0 0 .916-.237l-.093-.144a1.491 1.491 0 0 1-.823.209zm.918-.238a1.576 1.576 0 0 0 .568-.812l-.162-.057a1.409 1.409 0 0 1-.5.727zm.566-.807a.39.39 0 0 1 .086-.144l-.107-.134a.533.533 0 0 0-.137.213zm.093-.151a.144.144 0 0 1 .107-.031v-.171a.31.31 0 0 0-.228.081zm.107-.031h.535v-.171h-.535zm.535 0a.173.173 0 0 1 .129.053l.121-.121a.344.344 0 0 0-.25-.1zm.134.057a.11.11 0 0 1 .037.1l.17.017a.281.281 0 0 0-.1-.252zm.037.109a1.664 1.664 0 0 1-.288.806l.144.092a1.839 1.839 0 0 0 .315-.889zm-.288.806a1.989 1.989 0 0 1-.792.683l.079.152a2.162 2.162 0 0 0 .858-.744zm-.793.684a2.8 2.8 0 0 1-1.32.28v.171a2.96 2.96 0 0 0 1.4-.3zm2.568.187l-.065.056.01.009zm0-7.772l.061.06zm.926 0l-.065.056.009.009zm.078 2.776h-.085a.086.086 0 0 0 .153.053zm.758-.624l.038.077zm2.743.468l-.065.056zm.524 5.151l-.061-.06zm-.925 0l-.065.056.009.009zm-.457-4.5l-.065.056zm-2.23.011l-.062-.059zm-.49 4.493l-.061-.06zm-.736-.019a.2.2 0 0 1-.134-.046l-.112.13a.367.367 0 0 0 .245.088zm-.124-.037a.2.2 0 0 1-.046-.134h-.172a.367.367 0 0 0 .087.245zm-.046-.134v-7.4h-.172v7.4zm0-7.4a.156.156 0 0 1 .042-.118l-.121-.121a.326.326 0 0 0-.092.239zm.042-.118a.172.172 0 0 1 .129-.053v-.171a.343.343 0 0 0-.25.1zm.129-.053h.557v-.171h-.557zm.557 0a.137.137 0 0 1 .113.048l.13-.112a.308.308 0 0 0-.244-.108zm.122.057a.137.137 0 0 1 .048.113h.172a.309.309 0 0 0-.108-.243zm.048.113v2.6h.172v-2.6zm.153 2.651a2.076 2.076 0 0 1 .728-.6l-.075-.154a2.248 2.248 0 0 0-.788.649zm.73-.6a2.272 2.272 0 0 1 1.043-.214v-.171a2.438 2.438 0 0 0-1.121.232zm1.043-.214a1.982 1.982 0 0 1 1.6.661l.13-.112a2.152 2.152 0 0 0-1.727-.721zm1.6.663a2.557 2.557 0 0 1 .581 1.761h.171a2.727 2.727 0 0 0-.624-1.874zm.581 1.761v3.144h.171v-3.144zm0 3.144a.173.173 0 0 1-.053.129l.121.121a.345.345 0 0 0 .1-.25zm-.053.129a.156.156 0 0 1-.118.042v.171a.327.327 0 0 0 .239-.092zm-.118.042h-.557v.171h.557zm-.557 0a.2.2 0 0 1-.134-.046l-.112.13a.367.367 0 0 0 .245.088zm-.124-.037a.2.2 0 0 1-.046-.134h-.172a.368.368 0 0 0 .087.245zm-.046-.134V823.8h-.172v3.088zm0-3.088a1.859 1.859 0 0 0-.412-1.284l-.128.114a1.69 1.69 0 0 1 .368 1.169zm-.411-1.283a1.471 1.471 0 0 0-1.169-.464v.171a1.3 1.3 0 0 1 1.039.406zm-1.169-.464a1.566 1.566 0 0 0-1.188.473l.124.118a1.4 1.4 0 0 1 1.064-.419zm-1.188.473a1.779 1.779 0 0 0-.436 1.275h.172a1.609 1.609 0 0 1 .389-1.156zm-.436 1.275v3.088h.172V823.8zm0 3.088a.172.172 0 0 1-.053.129l.121.121a.344.344 0 0 0 .1-.25zm-.053.129a.156.156 0 0 1-.118.042v.171a.327.327 0 0 0 .239-.092zm-.118.042h-.557v.171h.557zm6.449-.505l-.062.059zm-.747-1.94h-.086zm-.012-.379h-.085v.005zm.012-.368l-.086-.006zm.758-1.918l-.061-.06zm3.735.078l-.065.056zm.6 2.5l.061.061zm-4.036.067v-.086a.086.086 0 0 0-.086.086zm0 .1h-.086zm.435 1.238l-.068.053zm1.918.3l.045.073zm.491-.435l-.069-.051zm.145-.156l.039.077h.006zm.9.022l-.055.066zm-.245.747l-.064-.057zm-.858.6l.035.078zm.267-3.189v.086a.086.086 0 0 0 .086-.086zm-.424-1.282l-.066.055zm-2.23 0l-.065-.055zm-.4 1.282h-.086a.086.086 0 0 0 .086.086zm1.528 3.349a2.38 2.38 0 0 1-1.779-.677l-.122.12a2.55 2.55 0 0 0 1.9.728zm-1.778-.676a2.86 2.86 0 0 1-.724-1.886l-.171.009a3.027 3.027 0 0 0 .771 1.995zm-.723-1.884l-.011-.379h-.171l.011.379zm-.011-.374l.011-.368-.172-.005-.011.368zm.011-.365a2.871 2.871 0 0 1 .735-1.864l-.124-.118a3.042 3.042 0 0 0-.782 1.971zm.734-1.864a2.331 2.331 0 0 1 1.756-.687v-.171a2.5 2.5 0 0 0-1.879.74zm1.756-.687a2.307 2.307 0 0 1 1.853.762l.13-.112a2.477 2.477 0 0 0-1.983-.821zm1.854.762a3.03 3.03 0 0 1 .659 2.062h.172a3.2 3.2 0 0 0-.7-2.175zm.659 2.062v.19h.172v-.19zm0 .19a.172.172 0 0 1-.053.129l.121.121a.345.345 0 0 0 .1-.25zm-.053.129a.156.156 0 0 1-.118.042v.171a.327.327 0 0 0 .239-.092zm-.118.042h-3.858v.171h3.858zm-3.944.086v.1h.172v-.1zm0 .1a2.2 2.2 0 0 0 .453 1.287l.135-.106a2.027 2.027 0 0 1-.417-1.189zm.454 1.288a1.418 1.418 0 0 0 1.148.533v-.171a1.247 1.247 0 0 1-1.015-.47zm1.148.533a1.647 1.647 0 0 0 .882-.214l-.09-.146a1.481 1.481 0 0 1-.791.188zm.882-.214a1.777 1.777 0 0 0 .515-.458l-.14-.1a1.613 1.613 0 0 1-.466.412zm.513-.456a1.251 1.251 0 0 1 .081-.1.28.28 0 0 1 .026-.025l.008-.006-.077-.153a.326.326 0 0 0-.083.068 1.55 1.55 0 0 0-.092.113zm.12-.134a.328.328 0 0 1 .146-.021v-.171a.468.468 0 0 0-.234.046zm.146-.021h.547v-.171h-.547zm.547 0a.166.166 0 0 1 .112.036l.11-.132a.337.337 0 0 0-.222-.076zm.112.036a.107.107 0 0 1 .036.09h.171a.277.277 0 0 0-.1-.222zm.036.09a.9.9 0 0 1-.291.534l.128.115a1.055 1.055 0 0 0 .334-.649zm-.291.535a2.42 2.42 0 0 1-.83.581l.072.156a2.6 2.6 0 0 0 .888-.624zm-.829.58a2.964 2.964 0 0 1-1.224.238v.171a3.133 3.133 0 0 0 1.295-.253zm.389-3.111v-.033h-.171v.033zm0-.033a1.9 1.9 0 0 0-.445-1.306l-.129.114a1.731 1.731 0 0 1 .4 1.192zm-.444-1.3a1.466 1.466 0 0 0-1.181-.521v.172a1.3 1.3 0 0 1 1.049.46zm-1.181-.521a1.466 1.466 0 0 0-1.18.521l.131.11a1.3 1.3 0 0 1 1.049-.46zm-1.181.521a1.965 1.965 0 0 0-.422 1.3h.172a1.794 1.794 0 0 1 .382-1.194zm-.422 1.3v.033h.172v-.033zm.086.119h3.055v-.171h-3.055z" fill="#51504f" data-name="Path 10" transform="translate(-1460.636 -807.945)"></path>
                                <path id="Path_11" d="M1519.066 884.011a.581.581 0 0 1-.567-.567 1.151 1.151 0 0 1 .028-.312l7.026-18.328a.881.881 0 0 1 .906-.623h1.926a.882.882 0 0 1 .907.623l7 18.328.057.312a.583.583 0 0 1-.567.567h-1.445a.735.735 0 0 1-.482-.142.9.9 0 0 1-.226-.34l-1.558-4.023h-9.292l-1.558 4.023a.8.8 0 0 1-.255.34.688.688 0 0 1-.453.142zm12.181-6.94l-3.824-10.056-3.823 10.055zm8.184-10.538a.592.592 0 0 1-.652-.651v-1.53a.714.714 0 0 1 .17-.482.656.656 0 0 1 .482-.2h1.785a.677.677 0 0 1 .68.68v1.53a.655.655 0 0 1-.2.481.713.713 0 0 1-.481.17zm.227 17.479a.593.593 0 0 1-.652-.652v-13.428a.611.611 0 0 1 .17-.453.656.656 0 0 1 .482-.2h1.359a.679.679 0 0 1 .652.651v13.427a.655.655 0 0 1-.2.482.613.613 0 0 1-.453.17zm6.861 0a.592.592 0 0 1-.651-.652v-13.4a.715.715 0 0 1 .17-.481.656.656 0 0 1 .482-.2h1.3a.677.677 0 0 1 .68.68v1.246a4.255 4.255 0 0 1 3.966-1.926h1.1a.679.679 0 0 1 .651.651v1.161a.566.566 0 0 1-.2.453.612.612 0 0 1-.453.17h-1.7a3.2 3.2 0 0 0-2.408.907 3.253 3.253 0 0 0-.879 2.408v8.328a.656.656 0 0 1-.2.482.716.716 0 0 1-.482.17zm12.234 0a.593.593 0 0 1-.651-.652v-11.814h-2.408a.592.592 0 0 1-.651-.651v-.963a.611.611 0 0 1 .17-.453.654.654 0 0 1 .481-.2h2.408v-1.417q0-4.816 4.872-4.815h1.586a.679.679 0 0 1 .652.651v.963a.656.656 0 0 1-.2.481.613.613 0 0 1-.453.17h-1.529a2.1 2.1 0 0 0-1.785.68 3.248 3.248 0 0 0-.51 2.011v1.275h6.062V863.7a.613.613 0 0 1 .17-.453.656.656 0 0 1 .482-.2h1.3a.679.679 0 0 1 .652.651v19.659a.655.655 0 0 1-.2.482.613.613 0 0 1-.454.17h-1.3a.592.592 0 0 1-.652-.652v-11.811h-6.062v11.813a.657.657 0 0 1-.2.482.614.614 0 0 1-.454.17zm20.9.283a6.487 6.487 0 0 1-4.844-1.757 6.837 6.837 0 0 1-1.813-4.674l-.029-1.218.029-1.218a6.732 6.732 0 0 1 1.841-4.646 7.389 7.389 0 0 1 9.631 0 6.736 6.736 0 0 1 1.841 4.646q.028.311.028 1.218t-.028 1.218a6.772 6.772 0 0 1-1.841 4.674 6.391 6.391 0 0 1-4.82 1.756zm0-2.181a3.582 3.582 0 0 0 2.8-1.133 4.931 4.931 0 0 0 1.133-3.258q.028-.283.028-1.076t-.028-1.076a4.931 4.931 0 0 0-1.133-3.258 3.582 3.582 0 0 0-2.8-1.133 3.671 3.671 0 0 0-2.833 1.133 4.83 4.83 0 0 0-1.1 3.258l-.028 1.076.028 1.076a4.83 4.83 0 0 0 1.1 3.258 3.671 3.671 0 0 0 2.828 1.132zm13.755 1.9a.846.846 0 0 1-.566-.17 1.321 1.321 0 0 1-.34-.538l-4.023-13.144-.056-.283a.575.575 0 0 1 .17-.425.641.641 0 0 1 .425-.17h1.246a.612.612 0 0 1 .453.17.646.646 0 0 1 .255.312l3.145 10.679 3.371-10.566a.761.761 0 0 1 .255-.4.726.726 0 0 1 .538-.2h.963a.728.728 0 0 1 .539.2.76.76 0 0 1 .255.4l3.371 10.566 3.144-10.679a.655.655 0 0 1 .2-.312.714.714 0 0 1 .482-.17h1.275a.542.542 0 0 1 .4.17.576.576 0 0 1 .17.425l-.057.283-3.994 13.144a1.323 1.323 0 0 1-.34.538.9.9 0 0 1-.6.17h-1.1a.86.86 0 0 1-.935-.708l-3.286-10.141-3.286 10.141a.928.928 0 0 1-.963.708z" fill="#51504f" data-name="Path 11" transform="translate(-1454.66 -838.62)"></path>
                            </g>
                        </g>
                    </g>
                </svg>

            </a>
        </div>
        <div class="desktop-only navbar__menu-container">

            <div class="navbar__menu-content" id="main_navbar">

                <div class="navbar__links-container">
                    
                        <a class="navbar__text-link" href="/community/">
                            Community
                        </a>
                    
                        <a class="navbar__text-link" href="/meetups/">
                            Meetups
                        </a>
                    
                        <a class="navbar__text-link" href="/docs/">
                            Documentation
                        </a>
                    
                        <a class="navbar__text-link" href="/use-cases/">
                            Use-cases
                        </a>
                    
                        <a class="navbar__text-link" href="/announcements/">
                            Announcements
                        </a>
                    
                        <a class="navbar__text-link" href="/blog/">
                            Blog
                        </a>
                    
                        <a class="navbar__text-link" href="/ecosystem/">
                            Ecosystem
                        </a>
                    
                </div>

                

            </div>

        </div>
        <div class="mobile-only navbar__drawer-container">
            <button class="navbar__toggle-button" id="navbar-toggle-button">

                <div id="hamburger-icon" class="navbar__toggle-button--icon visible">
                    <svg xmlns="http://www.w3.org/2000/svg" width="26" height="20" viewBox="0 0 26 20">
                        <g id="Group_1294" data-name="Group 1294" transform="translate(-38.791 291)">
                            <g id="Group_1291" data-name="Group 1291" transform="translate(39 -291)">
                                <rect id="Rectangle_461" width="26" height="2" fill="#51504f" data-name="Rectangle 461" rx="1" transform="translate(-.209)"></rect>
                            </g>
                            <g id="Group_1292" data-name="Group 1292" transform="translate(39 -281.822)">
                                <rect id="Rectangle_462" width="26" height="2" fill="#51504f" data-name="Rectangle 462" rx="1" transform="translate(-.209 -.178)"></rect>
                            </g>
                            <g id="Group_1293" data-name="Group 1293" transform="translate(39 -272.644)">
                                <rect id="Rectangle_463" width="26" height="2" fill="#51504f" data-name="Rectangle 463" rx="1" transform="translate(-.209 -.356)"></rect>
                            </g>
                        </g>
                    </svg>

                </div>

                <div id="close-icon" class="navbar__toggle-button--icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="19.799" height="19.799" viewBox="0 0 19.799 19.799">
                        <g id="Group_1574" data-name="Group 1574" transform="translate(-41.892 290.899)">
                            <g id="Group_1291" data-name="Group 1291" transform="rotate(-45 -308.114 -187.077)">
                                <rect id="Rectangle_461" width="26" height="2" fill="#51504f" data-name="Rectangle 461" rx="1" transform="translate(-.209)"></rect>
                            </g>
                            <g id="Group_1292" data-name="Group 1292" transform="rotate(45 372.48 -93.011)">
                                <rect id="Rectangle_462" width="26" height="2" fill="#51504f" data-name="Rectangle 462" rx="1" transform="translate(-.209 -.178)"></rect>
                            </g>
                        </g>
                    </svg>

                </div>

            </button>
            <div class="navbar__drawer" id="navbar-drawer">
                <div class="navbar__menu-content" id="main_navbar">

                    <div class="navbar__links-container">
                        
                            <a class="navbar__text-link" href="/community/">
                                Community
                            </a>
                        
                            <a class="navbar__text-link" href="/meetups/">
                                Meetups
                            </a>
                        
                            <a class="navbar__text-link" href="/docs/">
                                Documentation
                            </a>
                        
                            <a class="navbar__text-link" href="/use-cases/">
                                Use-cases
                            </a>
                        
                            <a class="navbar__text-link" href="/announcements/">
                                Announcements
                            </a>
                        
                            <a class="navbar__text-link" href="/blog/">
                                Blog
                            </a>
                        
                            <a class="navbar__text-link" href="/ecosystem/">
                                Ecosystem
                            </a>
                        

                    </div>
                    

                </div>
            </div>
        </div>
    </nav>

</header>


    <div class="roadmap container-fluid td-default base-layout">
        
        
    <div class="content-drawer-wrapper">
        <button class="content-drawer__toggle-button" id="content-open-button">

            <div id="hamburger-icon" class="content-drawer__toggle-button--icon visible">
                <svg xmlns="http://www.w3.org/2000/svg" width="20.005" height="13.879" viewBox="0 0 20.005 13.879">
                    <g id="Group_1619" data-name="Group 1619" transform="translate(271.132 -418.872)">
                        <g id="Group_1613" data-name="Group 1613" transform="translate(-266.229 431.045)">
                            <path id="Path_1337" d="M-218.5 513.215h-14.583a.259.259 0 0 1-.259-.26.259.259 0 0 1 .259-.259h14.583a.26.26 0 0 1 .259.259.259.259 0 0 1-.259.26z" fill="#51504f" data-name="Path 1337" transform="translate(233.345 -512.696)"></path>
                        </g>
                        <g id="Group_1614" data-name="Group 1614" transform="translate(-266.229 425.684)">
                            <path id="Path_1338" d="M-218.5 471.9h-14.583a.259.259 0 0 1-.259-.26.26.26 0 0 1 .259-.259h14.583a.26.26 0 0 1 .259.259.26.26 0 0 1-.259.26z" fill="#51504f" data-name="Path 1338" transform="translate(233.345 -471.376)"></path>
                        </g>
                        <g id="Group_1615" data-name="Group 1615" transform="translate(-266.229 420.323)">
                            <path id="Path_1339" d="M-218.5 430.574h-14.583a.259.259 0 0 1-.259-.259.259.259 0 0 1 .259-.259h14.583a.26.26 0 0 1 .259.259.259.259 0 0 1-.259.259z" fill="#51504f" data-name="Path 1339" transform="translate(233.345 -430.055)"></path>
                        </g>
                        <g id="Group_1616" data-name="Group 1616" transform="translate(-271.132 429.814)">
                            <path id="Path_1340" d="M-269.663 506.145a1.47 1.47 0 0 1-1.469-1.469 1.47 1.47 0 0 1 1.469-1.469 1.47 1.47 0 0 1 1.469 1.469 1.47 1.47 0 0 1-1.469 1.469zm0-2.418a.951.951 0 0 0-.95.95.951.951 0 0 0 .95.95.951.951 0 0 0 .95-.95.951.951 0 0 0-.95-.95z" fill="#51504f" data-name="Path 1340" transform="translate(271.132 -503.208)"></path>
                        </g>
                        <g id="Group_1617" data-name="Group 1617" transform="translate(-271.132 424.556)">
                            <path id="Path_1341" d="M-269.663 465.62a1.47 1.47 0 0 1-1.469-1.469 1.47 1.47 0 0 1 1.469-1.469 1.47 1.47 0 0 1 1.469 1.469 1.47 1.47 0 0 1-1.469 1.469zm0-2.418a.951.951 0 0 0-.95.95.951.951 0 0 0 .95.95.951.951 0 0 0 .95-.95.951.951 0 0 0-.95-.952z" fill="#51504f" data-name="Path 1341" transform="translate(271.132 -462.683)"></path>
                        </g>
                        <g id="Group_1618" data-name="Group 1618" transform="translate(-271.132 418.872)">
                            <path id="Path_1342" d="M-269.663 421.809a1.47 1.47 0 0 1-1.469-1.469 1.47 1.47 0 0 1 1.469-1.469 1.47 1.47 0 0 1 1.469 1.469 1.47 1.47 0 0 1-1.469 1.469zm0-2.418a.951.951 0 0 0-.95.95.951.951 0 0 0 .95.95.951.951 0 0 0 .95-.95.951.951 0 0 0-.95-.95z" fill="#51504f" data-name="Path 1342" transform="translate(271.132 -418.872)"></path>
                        </g>
                    </g>
                </svg>

                <span class="bodytext__mobile--brownish-grey">Content</span>
            </div>

        </button>
        <nav id="content-navbar" class="navbar navbar--hidden">
            <div class="navbar__icon-container">
                <a href="/">
                    <svg xmlns="http://www.w3.org/2000/svg" width="155.314" height="60" viewBox="0 0 155.314 60">
                        <defs>
                            <clipPath id="clip-path">
                                <path id="Rectangle_1" d="M0 0h155.314v60H0z" fill="none" data-name="Rectangle 1"></path>
                            </clipPath>
                        </defs>
                        <g id="logo" transform="translate(-1305 -780.355)">
                            <g id="Group_2" clip-path="url(#clip-path)" data-name="Group 2" transform="translate(1305 780.355)">
                                <g id="Group_1" data-name="Group 1" transform="translate(.486 .486)">
                                    <path id="Path_1" d="M1307.562 880.867l28.187-28.893a.521.521 0 0 0 .063-.666c-1.714-2.393-4.877-2.808-6.049-4.416-3.472-4.763-4.353-7.459-5.845-7.292a.456.456 0 0 0-.271.143l-10.182 10.438c-5.858 6-6.7 19.225-6.852 30.3a.552.552 0 0 0 .949.386z" fill="#017cee" data-name="Path 1" transform="translate(-1306.613 -822.232)"></path>
                                    <path id="Path_2" d="M1405.512 908.489l-28.893-28.189a.521.521 0 0 0-.667-.063c-2.393 1.715-2.808 4.877-4.416 6.049-4.763 3.472-7.459 4.353-7.292 5.845a.456.456 0 0 0 .143.27l10.438 10.182c6 5.858 19.225 6.7 30.3 6.852a.552.552 0 0 0 .387-.946z" fill="#00ad46" data-name="Path 2" transform="translate(-1346.876 -850.567)"></path>
                                    <path id="Path_3" d="M1373.909 902.252c-3.28-3.2-4.8-9.53 1.486-22.583-10.219 4.567-13.8 10.57-12.039 12.289z" fill="#04d659" data-name="Path 3" transform="translate(-1345.96 -850.233)"></path>
                                    <path id="Path_4" d="M1433.132 782.359l-28.186 28.893a.52.52 0 0 0-.063.666c1.715 2.393 4.876 2.808 6.049 4.416 3.472 4.763 4.354 7.459 5.845 7.292a.454.454 0 0 0 .271-.143l10.182-10.438c5.858-6 6.7-19.225 6.852-30.3a.553.553 0 0 0-.95-.386z" fill="#00c7d4" data-name="Path 4" transform="translate(-1375.21 -782.123)"></path>
                                    <path id="Path_5" d="M1426.9 881.155c-3.2 3.28-9.53 4.8-22.584-1.486 4.567 10.219 10.57 13.8 12.289 12.039z" fill="#11e1ee" data-name="Path 5" transform="translate(-1374.875 -850.233)"></path>
                                    <path id="Path_6" d="M1307 782.919l28.893 28.186a.521.521 0 0 0 .666.063c2.393-1.715 2.808-4.877 4.416-6.049 4.763-3.472 7.459-4.353 7.292-5.845a.459.459 0 0 0-.143-.271l-10.438-10.182c-6-5.858-19.225-6.7-30.3-6.852a.552.552 0 0 0-.386.95z" fill="#e43921" data-name="Path 6" transform="translate(-1306.766 -781.97)"></path>
                                    <path id="Path_7" d="M1405.8 804.711c3.28 3.2 4.8 9.53-1.486 22.584 10.219-4.567 13.8-10.571 12.039-12.289z" fill-rule="evenodd" fill="#ff7557" data-name="Path 7" transform="translate(-1374.875 -797.859)"></path>
                                    <path id="Path_8" d="M1329.355 849.266c3.2-3.28 9.53-4.8 22.584 1.486-4.567-10.219-10.57-13.8-12.289-12.039z" fill="#0cb6ff" data-name="Path 8" transform="translate(-1322.503 -821.316)"></path>
                                    <circle id="Ellipse_1" cx="1.26" cy="1.26" r="1.26" fill="#4a4848" data-name="Ellipse 1" transform="translate(28.18 28.171)"></circle>
                                    <path id="Path_9" d="M1527.558 827.347a.229.229 0 0 1-.223-.223.458.458 0 0 1 .011-.123l2.766-7.214a.346.346 0 0 1 .357-.245h.758a.348.348 0 0 1 .357.245l2.754 7.214.022.123a.228.228 0 0 1-.223.223h-.568a.288.288 0 0 1-.19-.056.352.352 0 0 1-.089-.134l-.613-1.583h-3.657l-.613 1.583a.317.317 0 0 1-.1.134.269.269 0 0 1-.178.056zm4.795-2.732l-1.505-3.958-1.505 3.958zm3.322 4.85a.258.258 0 0 1-.189-.078.241.241 0 0 1-.067-.178v-7.4a.241.241 0 0 1 .067-.178.258.258 0 0 1 .189-.078h.513a.268.268 0 0 1 .256.256v.49a2.118 2.118 0 0 1 1.828-.858 2.092 2.092 0 0 1 1.751.736 3.135 3.135 0 0 1 .636 1.9q.011.122.011.379t-.011.379a3.168 3.168 0 0 1-.636 1.9 2.111 2.111 0 0 1-1.751.736 2.154 2.154 0 0 1-1.806-.836v2.587a.241.241 0 0 1-.067.178.223.223 0 0 1-.179.078zm2.364-2.91a1.324 1.324 0 0 0 1.149-.491 2.266 2.266 0 0 0 .4-1.293q.011-.111.011-.323 0-2.107-1.562-2.107a1.365 1.365 0 0 0-1.159.513 2.111 2.111 0 0 0-.412 1.2l-.012.424.012.435a1.862 1.862 0 0 0 .424 1.149 1.4 1.4 0 0 0 1.148.493zm5.628.9a2.329 2.329 0 0 1-1.015-.223 1.94 1.94 0 0 1-.747-.6 1.487 1.487 0 0 1-.268-.859 1.459 1.459 0 0 1 .6-1.2 3.4 3.4 0 0 1 1.65-.624l1.661-.234v-.323q0-1.137-1.3-1.137a1.4 1.4 0 0 0-.8.212 1.376 1.376 0 0 0-.468.48.305.305 0 0 1-.089.145.18.18 0 0 1-.134.045h-.48a.23.23 0 0 1-.245-.245 1.17 1.17 0 0 1 .245-.6 1.931 1.931 0 0 1 .747-.591 2.7 2.7 0 0 1 1.238-.256 2.351 2.351 0 0 1 1.8.591 2.032 2.032 0 0 1 .547 1.45v3.613a.257.257 0 0 1-.078.19.24.24 0 0 1-.178.067h-.513a.233.233 0 0 1-.257-.256v-.479a1.923 1.923 0 0 1-.714.6 2.557 2.557 0 0 1-1.203.237zm.234-.836a1.579 1.579 0 0 0 1.182-.469 1.881 1.881 0 0 0 .468-1.371v-.312l-1.293.19a2.918 2.918 0 0 0-1.193.379.761.761 0 0 0-.4.658.784.784 0 0 0 .368.691 1.585 1.585 0 0 0 .867.237zm6.643.836a2.556 2.556 0 0 1-1.873-.669 2.738 2.738 0 0 1-.714-1.9l-.011-.446.011-.446a2.7 2.7 0 0 1 .714-1.885 2.531 2.531 0 0 1 1.873-.68 2.917 2.917 0 0 1 1.36.29 2.077 2.077 0 0 1 .825.714 1.7 1.7 0 0 1 .3.848.2.2 0 0 1-.067.178.281.281 0 0 1-.19.067h-.535a.265.265 0 0 1-.168-.045.458.458 0 0 1-.111-.178 1.428 1.428 0 0 0-.535-.758 1.516 1.516 0 0 0-.87-.234 1.45 1.45 0 0 0-1.1.435 1.952 1.952 0 0 0-.435 1.3l-.011.4.011.379a1.969 1.969 0 0 0 .435 1.316 1.446 1.446 0 0 0 1.1.424 1.577 1.577 0 0 0 .87-.223 1.493 1.493 0 0 0 .535-.769.458.458 0 0 1 .111-.178.228.228 0 0 1 .168-.056h.535a.258.258 0 0 1 .19.078.2.2 0 0 1 .067.178 1.75 1.75 0 0 1-.3.847 2.078 2.078 0 0 1-.825.714 2.876 2.876 0 0 1-1.361.302zm4.078-.112a.233.233 0 0 1-.257-.256v-7.4a.241.241 0 0 1 .067-.178.259.259 0 0 1 .19-.078h.557a.267.267 0 0 1 .257.256v2.6a2.167 2.167 0 0 1 .758-.624 2.353 2.353 0 0 1 1.082-.223 2.067 2.067 0 0 1 1.661.691 2.642 2.642 0 0 1 .6 1.818v3.144a.257.257 0 0 1-.078.19.24.24 0 0 1-.178.067h-.557a.233.233 0 0 1-.256-.256V824a1.775 1.775 0 0 0-.39-1.227 1.387 1.387 0 0 0-1.1-.435 1.481 1.481 0 0 0-1.126.446 1.7 1.7 0 0 0-.412 1.215v3.088a.257.257 0 0 1-.078.19.24.24 0 0 1-.178.067zm8.846.112a2.466 2.466 0 0 1-1.84-.7 2.938 2.938 0 0 1-.747-1.94l-.011-.379.011-.368a2.953 2.953 0 0 1 .758-1.918 2.7 2.7 0 0 1 3.735.078 3.114 3.114 0 0 1 .68 2.119v.19a.257.257 0 0 1-.078.189.241.241 0 0 1-.178.067h-3.858v.1a2.11 2.11 0 0 0 .435 1.238 1.332 1.332 0 0 0 1.081.5 1.563 1.563 0 0 0 .836-.2 1.7 1.7 0 0 0 .491-.435.6.6 0 0 1 .145-.156.391.391 0 0 1 .19-.033h.547a.252.252 0 0 1 .167.056.192.192 0 0 1 .067.156.975.975 0 0 1-.312.591 2.51 2.51 0 0 1-.859.6 3.049 3.049 0 0 1-1.26.248zm1.527-3.434v-.033a1.817 1.817 0 0 0-.424-1.249 1.512 1.512 0 0 0-2.23 0 1.883 1.883 0 0 0-.4 1.249v.033z" fill="#51504f" data-name="Path 9" transform="translate(-1460.834 -808.144)"></path>
                                    <path id="Path_10" d="M1527.2 827.081l-.061.061zm-.056-.279l-.08-.031zm2.766-7.214l.08.031zm1.472 0l-.081.029zm2.754 7.214l.084-.015a.064.064 0 0 0 0-.015zm.022.123h.086v-.015zm-.067.156l.06.061zm-.914.011l-.061.061.006.005zm-.089-.134l.081-.027zm-.613-1.583l.08-.031a.086.086 0 0 0-.08-.055zm-3.657 0v-.086a.086.086 0 0 0-.08.055zm-.613 1.583l-.08-.031zm-.1.134l.055.066zm4.047-2.676v.086a.086.086 0 0 0 .08-.116zm-1.505-3.958l.08-.03a.086.086 0 0 0-.16 0zm-1.505 3.958l-.08-.03a.086.086 0 0 0 .08.116zm-1.784 2.646a.128.128 0 0 1-.1-.042l-.122.121a.3.3 0 0 0 .217.092zm-.1-.042a.129.129 0 0 1-.042-.1h-.171a.3.3 0 0 0 .092.217zm-.042-.1a.38.38 0 0 1 .007-.1l-.163-.054a.514.514 0 0 0-.016.15zm.005-.092l2.765-7.214-.16-.061-2.765 7.214zm2.766-7.216a.283.283 0 0 1 .1-.143.3.3 0 0 1 .174-.046v-.172a.47.47 0 0 0-.271.076.453.453 0 0 0-.166.226zm.276-.189h.758v-.172h-.758zm.758 0a.3.3 0 0 1 .175.046.283.283 0 0 1 .1.143l.161-.059a.451.451 0 0 0-.166-.226.47.47 0 0 0-.272-.076zm.277.19l2.754 7.214.16-.061-2.754-7.214zm2.75 7.2l.022.123.169-.031-.022-.123zm.021.107a.13.13 0 0 1-.042.1l.121.121a.3.3 0 0 0 .092-.217zm-.042.1a.13.13 0 0 1-.1.042v.171a.3.3 0 0 0 .217-.092zm-.1.042h-.568v.171h.568zm-.568 0a.206.206 0 0 1-.135-.036l-.11.132a.373.373 0 0 0 .245.076zm-.129-.031a.262.262 0 0 1-.069-.1l-.162.054a.431.431 0 0 0 .11.167zm-.07-.1l-.613-1.584-.16.062.613 1.583zm-.693-1.638h-3.657v.171h3.657zm-3.737.055l-.614 1.584.16.062.613-1.583zm-.615 1.587a.235.235 0 0 1-.075.1l.111.13a.4.4 0 0 0 .126-.172zm-.074.1a.185.185 0 0 1-.124.036v.171a.354.354 0 0 0 .233-.076zm-.124.036h-.569v.171h.569zm4.306-2.677l-1.505-3.958-.16.061 1.505 3.958zm-1.666-3.958l-1.505 3.958.16.061 1.505-3.958zm-1.425 4.075h3.01v-.171h-3.01zm6.143 4.687l-.06.061zm0-7.761l.061.061zm.881 0l-.065.056.01.009zm.078.669h-.086a.086.086 0 0 0 .155.051zm3.579-.123l-.067.053zm.636 1.9h-.086zm0 .758l-.085-.007zm-.636 1.9l.067.054zm-3.557-.1l.068-.052a.086.086 0 0 0-.154.052zm-.067 2.765l-.061-.06zm2.787-3.323l-.069-.051zm.4-1.293l-.085-.008v.005zm-2.709-1.918l-.068-.052zm-.413 1.2h-.086zm-.011.423h-.085zm.011.435h-.086zm.424 1.149l.066-.054zm-1.216 3.315a.173.173 0 0 1-.129-.053l-.121.121a.342.342 0 0 0 .25.1zm-.129-.053a.157.157 0 0 1-.042-.118h-.172a.325.325 0 0 0 .092.239zm-.042-.118v-7.4h-.172v7.4zm0-7.4a.157.157 0 0 1 .042-.118l-.121-.121a.324.324 0 0 0-.092.239zm.042-.118a.173.173 0 0 1 .129-.053v-.172a.342.342 0 0 0-.25.1zm.129-.053h.513v-.172h-.513zm.513 0a.137.137 0 0 1 .113.048l.13-.111a.309.309 0 0 0-.244-.108zm.123.058a.137.137 0 0 1 .048.113h.171a.309.309 0 0 0-.108-.243zm.048.113v.49h.171v-.49zm.155.541a2.033 2.033 0 0 1 1.759-.823v-.171a2.2 2.2 0 0 0-1.9.894zm1.759-.823a2.007 2.007 0 0 1 1.683.7l.135-.106a2.177 2.177 0 0 0-1.818-.768zm1.683.7a3.045 3.045 0 0 1 .617 1.845l.171-.007a3.218 3.218 0 0 0-.654-1.946zm.617 1.85c.007.078.011.2.011.372h.171c0-.171 0-.3-.012-.387zm.011.372c0 .171 0 .294-.011.372l.17.015c.008-.086.012-.216.012-.387zm-.011.376a3.08 3.08 0 0 1-.617 1.846l.134.106a3.25 3.25 0 0 0 .654-1.945zm-.617 1.845a2.025 2.025 0 0 1-1.683.7v.171a2.2 2.2 0 0 0 1.817-.768zm-1.683.7a2.068 2.068 0 0 1-1.739-.8l-.136.1a2.239 2.239 0 0 0 1.874.87zm-1.892-.75v2.587h.172v-2.587zm0 2.587a.156.156 0 0 1-.042.118l.121.121a.325.325 0 0 0 .092-.239zm-.046.123a.138.138 0 0 1-.114.048v.172a.308.308 0 0 0 .244-.108zm-.114.048h-.546v.172h.546zm1.817-2.739a1.408 1.408 0 0 0 1.218-.526l-.138-.1a1.24 1.24 0 0 1-1.079.455zm1.217-.525a2.355 2.355 0 0 0 .419-1.341l-.171-.007a2.182 2.182 0 0 1-.385 1.246zm.418-1.336c.008-.079.012-.19.012-.332h-.172c0 .14 0 .245-.011.315zm.012-.332a2.726 2.726 0 0 0-.407-1.632 1.448 1.448 0 0 0-1.24-.562v.171a1.278 1.278 0 0 1 1.1.492 2.565 2.565 0 0 1 .374 1.53zm-1.647-2.193a1.452 1.452 0 0 0-1.228.547l.136.1a1.282 1.282 0 0 1 1.091-.479zm-1.228.547a2.2 2.2 0 0 0-.43 1.252l.172.008a2.028 2.028 0 0 1 .4-1.157zm-.43 1.254l-.011.424h.171l.011-.424zm-.011.428l.011.435h.172l-.011-.435zm.011.436a1.95 1.95 0 0 0 .443 1.2l.133-.109a1.776 1.776 0 0 1-.4-1.1zm.443 1.2a1.484 1.484 0 0 0 1.214.522v-.171a1.314 1.314 0 0 1-1.082-.459zm5.828 1.117l.037-.077zm-.747-.6l-.07.049zm.335-2.063l.052.068zm1.65-.624l.012.085zm1.661-.234l.012.085a.086.086 0 0 0 .074-.085zm-2.107-1.249l.046.072zm-.468.48l-.075-.042a.083.083 0 0 0-.006.015zm-.089.145l-.054-.067-.007.006zm-.792-.022l-.065.056.009.009zm-.067-.178h-.086zm.245-.6l-.07-.049zm.747-.591l.038.077zm3.033.334l-.063.058zm.468 5.252l.06.061zm-.881 0l-.065.056a.043.043 0 0 0 .009.009zm-.067-.669h.086a.086.086 0 0 0-.156-.048zm-.714.6l-.04-.076zm.223-1.059l-.062-.06zm.468-1.684h.086a.086.086 0 0 0-.1-.085zm-1.293.189l.012.085zm-1.193.379l.046.072zm-.033 1.349l-.047.071zm.635.985a2.241 2.241 0 0 1-.978-.215l-.074.155a2.412 2.412 0 0 0 1.051.231zm-.978-.215a1.859 1.859 0 0 1-.715-.576l-.138.1a2.024 2.024 0 0 0 .779.629zm-.713-.573a1.4 1.4 0 0 1-.253-.81h-.172a1.571 1.571 0 0 0 .283.907zm-.253-.81a1.374 1.374 0 0 1 .569-1.136l-.105-.135a1.544 1.544 0 0 0-.635 1.272zm.569-1.137a3.316 3.316 0 0 1 1.609-.607l-.024-.17a3.481 3.481 0 0 0-1.691.642zm1.609-.607l1.661-.234-.024-.17-1.662.234zm1.735-.319v-.323h-.171v.323zm0-.323a1.156 1.156 0 0 0-.355-.917 1.536 1.536 0 0 0-1.035-.306v.172a1.37 1.37 0 0 1 .922.263.986.986 0 0 1 .3.788zm-1.39-1.223a1.486 1.486 0 0 0-.851.227l.1.142a1.316 1.316 0 0 1 .755-.2zm-.849.226a1.452 1.452 0 0 0-.5.51l.15.084a1.286 1.286 0 0 1 .44-.449zm-.5.524a.226.226 0 0 1-.062.105l.107.134a.391.391 0 0 0 .117-.185zm-.068.112a.1.1 0 0 1-.073.019v.171a.266.266 0 0 0 .194-.07zm-.073.019h-.48v.171h.48zm-.48 0a.18.18 0 0 1-.122-.046l-.112.13a.352.352 0 0 0 .234.087zm-.113-.037a.18.18 0 0 1-.047-.123h-.171a.352.352 0 0 0 .087.234zm-.047-.119a1.1 1.1 0 0 1 .23-.557l-.14-.1a1.253 1.253 0 0 0-.261.648zm.23-.556a1.843 1.843 0 0 1 .715-.564l-.075-.154a2.018 2.018 0 0 0-.78.618zm.716-.564a2.611 2.611 0 0 1 1.2-.247v-.171a2.781 2.781 0 0 0-1.277.266zm1.2-.247a2.268 2.268 0 0 1 1.732.563l.126-.116a2.435 2.435 0 0 0-1.858-.618zm1.733.564a1.945 1.945 0 0 1 .523 1.391h.171a2.117 2.117 0 0 0-.57-1.508zm.523 1.391v3.613h.171v-3.613zm0 3.613a.172.172 0 0 1-.053.129l.121.121a.344.344 0 0 0 .1-.25zm-.053.129a.157.157 0 0 1-.118.042v.171a.326.326 0 0 0 .239-.092zm-.118.042h-.513v.171h.513zm-.513 0a.2.2 0 0 1-.134-.046l-.111.13a.367.367 0 0 0 .245.088zm-.124-.037a.194.194 0 0 1-.047-.134h-.171a.366.366 0 0 0 .087.245zm-.047-.134v-.479h-.171v.479zm-.156-.528a1.846 1.846 0 0 1-.683.575l.079.152a2.012 2.012 0 0 0 .745-.629zm-.683.575a2.476 2.476 0 0 1-1.153.236v.171a2.644 2.644 0 0 0 1.233-.255zm-.919-.429a1.666 1.666 0 0 0 1.244-.494l-.123-.12a1.493 1.493 0 0 1-1.121.442zm1.244-.494a1.969 1.969 0 0 0 .492-1.431h-.171a1.8 1.8 0 0 1-.444 1.312zm.492-1.431v-.312h-.171v.312zm-.1-.4l-1.293.189.025.17 1.293-.189zm-1.293.189a3 3 0 0 0-1.228.393l.095.143a2.837 2.837 0 0 1 1.158-.365zm-1.227.392a.845.845 0 0 0-.441.73h.172a.676.676 0 0 1 .362-.586zm-.441.73a.869.869 0 0 0 .406.762l.095-.142a.7.7 0 0 1-.33-.62zm.408.764a1.673 1.673 0 0 0 .916.247v-.171a1.5 1.5 0 0 1-.823-.221zm5.686.329l-.061.06zm-.714-1.9h-.085zm-.011-.446h-.085zm.011-.446h-.085zm.714-1.885l.061.061zm3.234-.39l-.04.076zm.825.713l-.073.046zm.3.848h-.086zm-.067.178l.056.065zm-.892.022l.054-.067zm-.112-.178l-.081.029zm-.535-.758l-.048.071zm-1.974.2l-.062-.059zm-.435 1.3h-.086zm-.011.4h-.086zm.011.379h-.086zm.435 1.316l-.062.059zm1.974.2l.046.072zm.535-.769l-.079-.033zm.112-.178l.054.067.007-.006zm.892.022l-.061.06zm.067.178l-.085-.009zm-.3.847l-.072-.046zm-.825.714l-.04-.076zm-1.36.2a2.471 2.471 0 0 1-1.814-.644l-.12.122a2.64 2.64 0 0 0 1.933.694zm-1.813-.643a2.653 2.653 0 0 1-.689-1.839l-.171.006a2.822 2.822 0 0 0 .738 1.952zm-.689-1.838l-.011-.446h-.171l.011.446zm-.011-.442l.011-.446h-.171l-.011.446zm.011-.445a2.611 2.611 0 0 1 .689-1.827l-.122-.121a2.78 2.78 0 0 0-.738 1.942zm.689-1.827a2.447 2.447 0 0 1 1.813-.655v-.171a2.617 2.617 0 0 0-1.934.705zm1.813-.655a2.836 2.836 0 0 1 1.32.28l.079-.152a3 3 0 0 0-1.4-.3zm1.32.28a1.99 1.99 0 0 1 .792.683l.145-.091a2.158 2.158 0 0 0-.858-.744zm.793.685a1.617 1.617 0 0 1 .287.8l.171-.009a1.789 1.789 0 0 0-.315-.89zm.287.809a.11.11 0 0 1-.037.1l.112.13a.281.281 0 0 0 .1-.252zm-.037.1a.2.2 0 0 1-.134.046v.171a.369.369 0 0 0 .246-.088zm-.134.046h-.535v.171h.535zm-.535 0a.184.184 0 0 1-.114-.026l-.107.134a.345.345 0 0 0 .221.064zm-.114-.026a.389.389 0 0 1-.086-.144l-.158.066a.533.533 0 0 0 .137.212zm-.084-.14a1.514 1.514 0 0 0-.57-.8l-.093.144a1.343 1.343 0 0 1 .5.715zm-.568-.8a1.6 1.6 0 0 0-.918-.249v.171a1.435 1.435 0 0 1 .822.219zm-.918-.249a1.535 1.535 0 0 0-1.166.462l.124.118a1.364 1.364 0 0 1 1.042-.408zm-1.166.462a2.036 2.036 0 0 0-.458 1.36l.171.006a1.872 1.872 0 0 1 .411-1.249zm-.458 1.361l-.011.4h.171l.011-.4zm-.011.406l.011.379.171-.005-.011-.379zm.011.38a2.052 2.052 0 0 0 .458 1.371l.124-.118a1.889 1.889 0 0 1-.411-1.26zm.458 1.371a1.533 1.533 0 0 0 1.166.451v-.172a1.363 1.363 0 0 1-1.042-.4zm1.166.451a1.661 1.661 0 0 0 .916-.237l-.093-.144a1.491 1.491 0 0 1-.823.209zm.918-.238a1.576 1.576 0 0 0 .568-.812l-.162-.057a1.409 1.409 0 0 1-.5.727zm.566-.807a.39.39 0 0 1 .086-.144l-.107-.134a.533.533 0 0 0-.137.213zm.093-.151a.144.144 0 0 1 .107-.031v-.171a.31.31 0 0 0-.228.081zm.107-.031h.535v-.171h-.535zm.535 0a.173.173 0 0 1 .129.053l.121-.121a.344.344 0 0 0-.25-.1zm.134.057a.11.11 0 0 1 .037.1l.17.017a.281.281 0 0 0-.1-.252zm.037.109a1.664 1.664 0 0 1-.288.806l.144.092a1.839 1.839 0 0 0 .315-.889zm-.288.806a1.989 1.989 0 0 1-.792.683l.079.152a2.162 2.162 0 0 0 .858-.744zm-.793.684a2.8 2.8 0 0 1-1.32.28v.171a2.96 2.96 0 0 0 1.4-.3zm2.568.187l-.065.056.01.009zm0-7.772l.061.06zm.926 0l-.065.056.009.009zm.078 2.776h-.085a.086.086 0 0 0 .153.053zm.758-.624l.038.077zm2.743.468l-.065.056zm.524 5.151l-.061-.06zm-.925 0l-.065.056.009.009zm-.457-4.5l-.065.056zm-2.23.011l-.062-.059zm-.49 4.493l-.061-.06zm-.736-.019a.2.2 0 0 1-.134-.046l-.112.13a.367.367 0 0 0 .245.088zm-.124-.037a.2.2 0 0 1-.046-.134h-.172a.367.367 0 0 0 .087.245zm-.046-.134v-7.4h-.172v7.4zm0-7.4a.156.156 0 0 1 .042-.118l-.121-.121a.326.326 0 0 0-.092.239zm.042-.118a.172.172 0 0 1 .129-.053v-.171a.343.343 0 0 0-.25.1zm.129-.053h.557v-.171h-.557zm.557 0a.137.137 0 0 1 .113.048l.13-.112a.308.308 0 0 0-.244-.108zm.122.057a.137.137 0 0 1 .048.113h.172a.309.309 0 0 0-.108-.243zm.048.113v2.6h.172v-2.6zm.153 2.651a2.076 2.076 0 0 1 .728-.6l-.075-.154a2.248 2.248 0 0 0-.788.649zm.73-.6a2.272 2.272 0 0 1 1.043-.214v-.171a2.438 2.438 0 0 0-1.121.232zm1.043-.214a1.982 1.982 0 0 1 1.6.661l.13-.112a2.152 2.152 0 0 0-1.727-.721zm1.6.663a2.557 2.557 0 0 1 .581 1.761h.171a2.727 2.727 0 0 0-.624-1.874zm.581 1.761v3.144h.171v-3.144zm0 3.144a.173.173 0 0 1-.053.129l.121.121a.345.345 0 0 0 .1-.25zm-.053.129a.156.156 0 0 1-.118.042v.171a.327.327 0 0 0 .239-.092zm-.118.042h-.557v.171h.557zm-.557 0a.2.2 0 0 1-.134-.046l-.112.13a.367.367 0 0 0 .245.088zm-.124-.037a.2.2 0 0 1-.046-.134h-.172a.368.368 0 0 0 .087.245zm-.046-.134V823.8h-.172v3.088zm0-3.088a1.859 1.859 0 0 0-.412-1.284l-.128.114a1.69 1.69 0 0 1 .368 1.169zm-.411-1.283a1.471 1.471 0 0 0-1.169-.464v.171a1.3 1.3 0 0 1 1.039.406zm-1.169-.464a1.566 1.566 0 0 0-1.188.473l.124.118a1.4 1.4 0 0 1 1.064-.419zm-1.188.473a1.779 1.779 0 0 0-.436 1.275h.172a1.609 1.609 0 0 1 .389-1.156zm-.436 1.275v3.088h.172V823.8zm0 3.088a.172.172 0 0 1-.053.129l.121.121a.344.344 0 0 0 .1-.25zm-.053.129a.156.156 0 0 1-.118.042v.171a.327.327 0 0 0 .239-.092zm-.118.042h-.557v.171h.557zm6.449-.505l-.062.059zm-.747-1.94h-.086zm-.012-.379h-.085v.005zm.012-.368l-.086-.006zm.758-1.918l-.061-.06zm3.735.078l-.065.056zm.6 2.5l.061.061zm-4.036.067v-.086a.086.086 0 0 0-.086.086zm0 .1h-.086zm.435 1.238l-.068.053zm1.918.3l.045.073zm.491-.435l-.069-.051zm.145-.156l.039.077h.006zm.9.022l-.055.066zm-.245.747l-.064-.057zm-.858.6l.035.078zm.267-3.189v.086a.086.086 0 0 0 .086-.086zm-.424-1.282l-.066.055zm-2.23 0l-.065-.055zm-.4 1.282h-.086a.086.086 0 0 0 .086.086zm1.528 3.349a2.38 2.38 0 0 1-1.779-.677l-.122.12a2.55 2.55 0 0 0 1.9.728zm-1.778-.676a2.86 2.86 0 0 1-.724-1.886l-.171.009a3.027 3.027 0 0 0 .771 1.995zm-.723-1.884l-.011-.379h-.171l.011.379zm-.011-.374l.011-.368-.172-.005-.011.368zm.011-.365a2.871 2.871 0 0 1 .735-1.864l-.124-.118a3.042 3.042 0 0 0-.782 1.971zm.734-1.864a2.331 2.331 0 0 1 1.756-.687v-.171a2.5 2.5 0 0 0-1.879.74zm1.756-.687a2.307 2.307 0 0 1 1.853.762l.13-.112a2.477 2.477 0 0 0-1.983-.821zm1.854.762a3.03 3.03 0 0 1 .659 2.062h.172a3.2 3.2 0 0 0-.7-2.175zm.659 2.062v.19h.172v-.19zm0 .19a.172.172 0 0 1-.053.129l.121.121a.345.345 0 0 0 .1-.25zm-.053.129a.156.156 0 0 1-.118.042v.171a.327.327 0 0 0 .239-.092zm-.118.042h-3.858v.171h3.858zm-3.944.086v.1h.172v-.1zm0 .1a2.2 2.2 0 0 0 .453 1.287l.135-.106a2.027 2.027 0 0 1-.417-1.189zm.454 1.288a1.418 1.418 0 0 0 1.148.533v-.171a1.247 1.247 0 0 1-1.015-.47zm1.148.533a1.647 1.647 0 0 0 .882-.214l-.09-.146a1.481 1.481 0 0 1-.791.188zm.882-.214a1.777 1.777 0 0 0 .515-.458l-.14-.1a1.613 1.613 0 0 1-.466.412zm.513-.456a1.251 1.251 0 0 1 .081-.1.28.28 0 0 1 .026-.025l.008-.006-.077-.153a.326.326 0 0 0-.083.068 1.55 1.55 0 0 0-.092.113zm.12-.134a.328.328 0 0 1 .146-.021v-.171a.468.468 0 0 0-.234.046zm.146-.021h.547v-.171h-.547zm.547 0a.166.166 0 0 1 .112.036l.11-.132a.337.337 0 0 0-.222-.076zm.112.036a.107.107 0 0 1 .036.09h.171a.277.277 0 0 0-.1-.222zm.036.09a.9.9 0 0 1-.291.534l.128.115a1.055 1.055 0 0 0 .334-.649zm-.291.535a2.42 2.42 0 0 1-.83.581l.072.156a2.6 2.6 0 0 0 .888-.624zm-.829.58a2.964 2.964 0 0 1-1.224.238v.171a3.133 3.133 0 0 0 1.295-.253zm.389-3.111v-.033h-.171v.033zm0-.033a1.9 1.9 0 0 0-.445-1.306l-.129.114a1.731 1.731 0 0 1 .4 1.192zm-.444-1.3a1.466 1.466 0 0 0-1.181-.521v.172a1.3 1.3 0 0 1 1.049.46zm-1.181-.521a1.466 1.466 0 0 0-1.18.521l.131.11a1.3 1.3 0 0 1 1.049-.46zm-1.181.521a1.965 1.965 0 0 0-.422 1.3h.172a1.794 1.794 0 0 1 .382-1.194zm-.422 1.3v.033h.172v-.033zm.086.119h3.055v-.171h-3.055z" fill="#51504f" data-name="Path 10" transform="translate(-1460.636 -807.945)"></path>
                                    <path id="Path_11" d="M1519.066 884.011a.581.581 0 0 1-.567-.567 1.151 1.151 0 0 1 .028-.312l7.026-18.328a.881.881 0 0 1 .906-.623h1.926a.882.882 0 0 1 .907.623l7 18.328.057.312a.583.583 0 0 1-.567.567h-1.445a.735.735 0 0 1-.482-.142.9.9 0 0 1-.226-.34l-1.558-4.023h-9.292l-1.558 4.023a.8.8 0 0 1-.255.34.688.688 0 0 1-.453.142zm12.181-6.94l-3.824-10.056-3.823 10.055zm8.184-10.538a.592.592 0 0 1-.652-.651v-1.53a.714.714 0 0 1 .17-.482.656.656 0 0 1 .482-.2h1.785a.677.677 0 0 1 .68.68v1.53a.655.655 0 0 1-.2.481.713.713 0 0 1-.481.17zm.227 17.479a.593.593 0 0 1-.652-.652v-13.428a.611.611 0 0 1 .17-.453.656.656 0 0 1 .482-.2h1.359a.679.679 0 0 1 .652.651v13.427a.655.655 0 0 1-.2.482.613.613 0 0 1-.453.17zm6.861 0a.592.592 0 0 1-.651-.652v-13.4a.715.715 0 0 1 .17-.481.656.656 0 0 1 .482-.2h1.3a.677.677 0 0 1 .68.68v1.246a4.255 4.255 0 0 1 3.966-1.926h1.1a.679.679 0 0 1 .651.651v1.161a.566.566 0 0 1-.2.453.612.612 0 0 1-.453.17h-1.7a3.2 3.2 0 0 0-2.408.907 3.253 3.253 0 0 0-.879 2.408v8.328a.656.656 0 0 1-.2.482.716.716 0 0 1-.482.17zm12.234 0a.593.593 0 0 1-.651-.652v-11.814h-2.408a.592.592 0 0 1-.651-.651v-.963a.611.611 0 0 1 .17-.453.654.654 0 0 1 .481-.2h2.408v-1.417q0-4.816 4.872-4.815h1.586a.679.679 0 0 1 .652.651v.963a.656.656 0 0 1-.2.481.613.613 0 0 1-.453.17h-1.529a2.1 2.1 0 0 0-1.785.68 3.248 3.248 0 0 0-.51 2.011v1.275h6.062V863.7a.613.613 0 0 1 .17-.453.656.656 0 0 1 .482-.2h1.3a.679.679 0 0 1 .652.651v19.659a.655.655 0 0 1-.2.482.613.613 0 0 1-.454.17h-1.3a.592.592 0 0 1-.652-.652v-11.811h-6.062v11.813a.657.657 0 0 1-.2.482.614.614 0 0 1-.454.17zm20.9.283a6.487 6.487 0 0 1-4.844-1.757 6.837 6.837 0 0 1-1.813-4.674l-.029-1.218.029-1.218a6.732 6.732 0 0 1 1.841-4.646 7.389 7.389 0 0 1 9.631 0 6.736 6.736 0 0 1 1.841 4.646q.028.311.028 1.218t-.028 1.218a6.772 6.772 0 0 1-1.841 4.674 6.391 6.391 0 0 1-4.82 1.756zm0-2.181a3.582 3.582 0 0 0 2.8-1.133 4.931 4.931 0 0 0 1.133-3.258q.028-.283.028-1.076t-.028-1.076a4.931 4.931 0 0 0-1.133-3.258 3.582 3.582 0 0 0-2.8-1.133 3.671 3.671 0 0 0-2.833 1.133 4.83 4.83 0 0 0-1.1 3.258l-.028 1.076.028 1.076a4.83 4.83 0 0 0 1.1 3.258 3.671 3.671 0 0 0 2.828 1.132zm13.755 1.9a.846.846 0 0 1-.566-.17 1.321 1.321 0 0 1-.34-.538l-4.023-13.144-.056-.283a.575.575 0 0 1 .17-.425.641.641 0 0 1 .425-.17h1.246a.612.612 0 0 1 .453.17.646.646 0 0 1 .255.312l3.145 10.679 3.371-10.566a.761.761 0 0 1 .255-.4.726.726 0 0 1 .538-.2h.963a.728.728 0 0 1 .539.2.76.76 0 0 1 .255.4l3.371 10.566 3.144-10.679a.655.655 0 0 1 .2-.312.714.714 0 0 1 .482-.17h1.275a.542.542 0 0 1 .4.17.576.576 0 0 1 .17.425l-.057.283-3.994 13.144a1.323 1.323 0 0 1-.34.538.9.9 0 0 1-.6.17h-1.1a.86.86 0 0 1-.935-.708l-3.286-10.141-3.286 10.141a.928.928 0 0 1-.963.708z" fill="#51504f" data-name="Path 11" transform="translate(-1454.66 -838.62)"></path>
                                </g>
                            </g>
                        </g>
                    </svg>

                </a>
            </div>

            <div id="content-close-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="19.799" height="19.799" viewBox="0 0 19.799 19.799">
                    <g id="Group_1574" data-name="Group 1574" transform="translate(-41.892 290.899)">
                        <g id="Group_1291" data-name="Group 1291" transform="rotate(-45 -308.114 -187.077)">
                            <rect id="Rectangle_461" width="26" height="2" fill="#51504f" data-name="Rectangle 461" rx="1" transform="translate(-.209)"></rect>
                        </g>
                        <g id="Group_1292" data-name="Group 1292" transform="rotate(45 372.48 -93.011)">
                            <rect id="Rectangle_462" width="26" height="2" fill="#51504f" data-name="Rectangle 462" rx="1" transform="translate(-.209 -.178)"></rect>
                        </g>
                    </g>
                </svg>

            </div>

        </nav>
        <div class="content-drawer-container" id="content-drawer">
            <div class="content-drawer">
                <div class="td-sidebar">

<div id="docs-version-selector" class="docs-version-selector sidebar__version-selector">
    <a class="dropdown-toggle" href="#" id="versionDropdown" role="button" data-toggle="dropdown" aria-haspopup="true"
       aria-expanded="false">
        <span class="bodytext__medium--greyish-brown">Version: </span><span class="version">2.7.3</span>
    </a>
    <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">

    </div>
    <script type="application/x-template" id="version-item-template">
        <a class="dropdown-item"></a>
    </script>
</div>

<div class="searchb-box">
    <form class="search-form" action="../../../search.html" method="get">
        <input class="search-form__input" type="text" name="q" placeholder="Search docs" size="16">
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />

        <button class="search-form__button" type="submit">

            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20">
                <g id="Group_1579" data-name="Group 1579" transform="translate(-41.001 -41)">
                    <path id="Path_169" d="M71.415 64.687a7.215 7.215 0 1 0-6.729 6.728 7.222 7.222 0 0 0 6.729-6.728z" fill="none" data-name="Path 169" transform="translate(-14.277 -14.276)"></path>
                    <path id="Path_170" d="M60.863 59.8l-6.093-6.09a7.78 7.78 0 1 0-1.06 1.06l6.09 6.093a.468.468 0 0 0 .662 0l.4-.4a.468.468 0 0 0 .001-.663zM42.512 49.183a6.274 6.274 0 1 1 5.851 5.85 6.28 6.28 0 0 1-5.851-5.85z" fill="#51504f" data-name="Path 170"></path>
                </g>
            </svg>
        </button>
    </form>
</div>


<style>
    .searchb-box {
        margin-bottom: 26px;
    }
    .searchb-box .search-form {
        width: 100%;
        margin-top: 20px;
    }
</style>


<div class="toctree" role="navigation" aria-label="main navigation">
    <p class="caption" role="heading"><span class="caption-text">Content</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/index.html">Installation of Airflow™</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security/index.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../howto/index.html">How-to Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ui.html">UI / Screenshots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../core-concepts/index.html">Core Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authoring-and-scheduling/index.html">Authoring and Scheduling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../administration-and-deployment/index.html">Administration and Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../integration.html">Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../public-airflow-interface.html">Public Interface of Airflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../best-practices.html">Best Practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release-process.html">Release Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../privacy_notice.html">Privacy Notice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../project.html">Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../operators-and-hooks-ref.html">Operators and hooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli-and-env-variables-ref.html">CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../templates-ref.html">Templates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../stable-rest-api-ref.html">Stable REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deprecated-rest-api-ref.html">Deprecated REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configurations-ref.html">Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extra-packages-ref.html">Extra packages</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Internal DB details</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../migrations-ref.html">Database Migrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../database-erd-ref.html">Database ERD Schema</a></li>
</ul>

</div>

<style type="text/css">
    .toctree {
    }
    .toctree li {
        list-style: none;
    }
    .toctree .caption {
        font-family: Roboto;
        font-size: 18px;
        font-weight: bold;
        font-stretch: normal;
        font-style: normal;
        line-height: 1.33;
        letter-spacing: normal;
        color: #51504f;
        padding-bottom: 13px;
        text-transform: uppercase;
        margin-bottom: 0;
    }
    .toctree .current > a:not([href="#"])  {
        color: #017cee;
    }
    .toctree > ul {
        padding-left: 0;
    }
    .toctree ul {
        padding-left: 15px;
        display: none;
    }
    .toctree > ul,
    .toctree li.current > ul {
        display: block;
    }

    .toctree a .toctree-expand {
        display: inline-block;
        position: relative;
        height: 1em;
    }

    .toctree a .toctree-expand:before {
        position: absolute;
        top: 6px;
        left: -12px;
        content: '►';
        font-size: 7px;
    }
    .toctree .current > a > .toctree-expand:before {
        content: '▼';
    }

    .toctree .current {
        color: #017cee;
    }
    .toctree li {
        font-family: Roboto;
        font-size: 16px;
        font-weight: normal;
        font-stretch: normal;
        font-style: normal;
        line-height: 1.63;
        letter-spacing: normal;
        color: #707070;
    }

</style>
                </div>
            </div>
        </div>
    </div>
        
        <div class="d-flex">
            
            
    <div class="td-sidebar desktop-only d-print-none">

<div id="docs-version-selector" class="docs-version-selector sidebar__version-selector">
    <a class="dropdown-toggle" href="#" id="versionDropdown" role="button" data-toggle="dropdown" aria-haspopup="true"
       aria-expanded="false">
        <span class="bodytext__medium--greyish-brown">Version: </span><span class="version">2.7.3</span>
    </a>
    <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">

    </div>
    <script type="application/x-template" id="version-item-template">
        <a class="dropdown-item"></a>
    </script>
</div>

<div class="searchb-box">
    <form class="search-form" action="../../../search.html" method="get">
        <input class="search-form__input" type="text" name="q" placeholder="Search docs" size="16">
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />

        <button class="search-form__button" type="submit">

            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20">
                <g id="Group_1579" data-name="Group 1579" transform="translate(-41.001 -41)">
                    <path id="Path_169" d="M71.415 64.687a7.215 7.215 0 1 0-6.729 6.728 7.222 7.222 0 0 0 6.729-6.728z" fill="none" data-name="Path 169" transform="translate(-14.277 -14.276)"></path>
                    <path id="Path_170" d="M60.863 59.8l-6.093-6.09a7.78 7.78 0 1 0-1.06 1.06l6.09 6.093a.468.468 0 0 0 .662 0l.4-.4a.468.468 0 0 0 .001-.663zM42.512 49.183a6.274 6.274 0 1 1 5.851 5.85 6.28 6.28 0 0 1-5.851-5.85z" fill="#51504f" data-name="Path 170"></path>
                </g>
            </svg>
        </button>
    </form>
</div>


<style>
    .searchb-box {
        margin-bottom: 26px;
    }
    .searchb-box .search-form {
        width: 100%;
        margin-top: 20px;
    }
</style>


<div class="toctree" role="navigation" aria-label="main navigation">
    <p class="caption" role="heading"><span class="caption-text">Content</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/index.html">Installation of Airflow™</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security/index.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../howto/index.html">How-to Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ui.html">UI / Screenshots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../core-concepts/index.html">Core Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authoring-and-scheduling/index.html">Authoring and Scheduling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../administration-and-deployment/index.html">Administration and Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../integration.html">Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../public-airflow-interface.html">Public Interface of Airflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../best-practices.html">Best Practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release-process.html">Release Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../privacy_notice.html">Privacy Notice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../project.html">Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../operators-and-hooks-ref.html">Operators and hooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli-and-env-variables-ref.html">CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../templates-ref.html">Templates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../stable-rest-api-ref.html">Stable REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deprecated-rest-api-ref.html">Deprecated REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configurations-ref.html">Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extra-packages-ref.html">Extra packages</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Internal DB details</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../migrations-ref.html">Database Migrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../database-erd-ref.html">Database ERD Schema</a></li>
</ul>

</div>

<style type="text/css">
    .toctree {
    }
    .toctree li {
        list-style: none;
    }
    .toctree .caption {
        font-family: Roboto;
        font-size: 18px;
        font-weight: bold;
        font-stretch: normal;
        font-style: normal;
        line-height: 1.33;
        letter-spacing: normal;
        color: #51504f;
        padding-bottom: 13px;
        text-transform: uppercase;
        margin-bottom: 0;
    }
    .toctree .current > a:not([href="#"])  {
        color: #017cee;
    }
    .toctree > ul {
        padding-left: 0;
    }
    .toctree ul {
        padding-left: 15px;
        display: none;
    }
    .toctree > ul,
    .toctree li.current > ul {
        display: block;
    }

    .toctree a .toctree-expand {
        display: inline-block;
        position: relative;
        height: 1em;
    }

    .toctree a .toctree-expand:before {
        position: absolute;
        top: 6px;
        left: -12px;
        content: '►';
        font-size: 7px;
    }
    .toctree .current > a > .toctree-expand:before {
        content: '▼';
    }

    .toctree .current {
        color: #017cee;
    }
    .toctree li {
        font-family: Roboto;
        font-size: 16px;
        font-weight: normal;
        font-stretch: normal;
        font-style: normal;
        line-height: 1.63;
        letter-spacing: normal;
        color: #707070;
    }

</style>
    </div>
            

            

            <main class="col-12 col-md-9 col-xl-8" role="main">
                


    




<div role="navigation" aria-label="breadcrumbs navigation" class="d-none d-md-block d-print-none">

    <ul class="breadcrumb">
        
            <li class="breadcrumb-item"><a href="../../../index.html" class="icon icon-home"> Home</a></li>
            
                <li class="breadcrumb-item"><a href="../../index.html"> Module code</a></li>
            
            <li class="breadcrumb-item"><a href="taskinstance.html"> airflow.models.taskinstance</a></li>
        
    </ul>
</div>
                
                <div class="rst-content">
                    <div class="document">
                            <div class="documentwrapper">
                                <div class="bodywrapper">
                                    <div class="body" role="main">
                                        
  <h1>Source code for airflow.models.taskinstance</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Licensed to the Apache Software Foundation (ASF) under one</span>
<span class="c1"># or more contributor license agreements.  See the NOTICE file</span>
<span class="c1"># distributed with this work for additional information</span>
<span class="c1"># regarding copyright ownership.  The ASF licenses this file</span>
<span class="c1"># to you under the Apache License, Version 2.0 (the</span>
<span class="c1"># &quot;License&quot;); you may not use this file except in compliance</span>
<span class="c1"># with the License.  You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#   http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing,</span>
<span class="c1"># software distributed under the License is distributed on an</span>
<span class="c1"># &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span>
<span class="c1"># KIND, either express or implied.  See the License for the</span>
<span class="c1"># specific language governing permissions and limitations</span>
<span class="c1"># under the License.</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">collections.abc</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">PurePath</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">TracebackType</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote</span>

<span class="kn">import</span> <span class="nn">dill</span>
<span class="kn">import</span> <span class="nn">jinja2</span>
<span class="kn">import</span> <span class="nn">lazy_object_proxy</span>
<span class="kn">import</span> <span class="nn">pendulum</span>
<span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">TemplateAssertionError</span><span class="p">,</span> <span class="n">UndefinedError</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Column</span><span class="p">,</span>
    <span class="n">DateTime</span><span class="p">,</span>
    <span class="n">Float</span><span class="p">,</span>
    <span class="n">ForeignKey</span><span class="p">,</span>
    <span class="n">ForeignKeyConstraint</span><span class="p">,</span>
    <span class="n">Index</span><span class="p">,</span>
    <span class="n">Integer</span><span class="p">,</span>
    <span class="n">PrimaryKeyConstraint</span><span class="p">,</span>
    <span class="n">String</span><span class="p">,</span>
    <span class="n">Text</span><span class="p">,</span>
    <span class="n">and_</span><span class="p">,</span>
    <span class="n">delete</span><span class="p">,</span>
    <span class="n">false</span><span class="p">,</span>
    <span class="n">func</span><span class="p">,</span>
    <span class="n">inspect</span><span class="p">,</span>
    <span class="n">or_</span><span class="p">,</span>
    <span class="n">text</span><span class="p">,</span>
    <span class="n">update</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.associationproxy</span> <span class="kn">import</span> <span class="n">association_proxy</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.mutable</span> <span class="kn">import</span> <span class="n">MutableDict</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">reconstructor</span><span class="p">,</span> <span class="n">relationship</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.attributes</span> <span class="kn">import</span> <span class="n">NO_VALUE</span><span class="p">,</span> <span class="n">set_committed_value</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.session</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.elements</span> <span class="kn">import</span> <span class="n">BooleanClauseList</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="n">ColumnOperators</span><span class="p">,</span> <span class="n">case</span>

<span class="kn">from</span> <span class="nn">airflow</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">airflow.compat.functools</span> <span class="kn">import</span> <span class="n">cache</span>
<span class="kn">from</span> <span class="nn">airflow.configuration</span> <span class="kn">import</span> <span class="n">conf</span>
<span class="kn">from</span> <span class="nn">airflow.datasets</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">airflow.datasets.manager</span> <span class="kn">import</span> <span class="n">dataset_manager</span>
<span class="kn">from</span> <span class="nn">airflow.exceptions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AirflowException</span><span class="p">,</span>
    <span class="n">AirflowFailException</span><span class="p">,</span>
    <span class="n">AirflowRescheduleException</span><span class="p">,</span>
    <span class="n">AirflowSensorTimeout</span><span class="p">,</span>
    <span class="n">AirflowSkipException</span><span class="p">,</span>
    <span class="n">AirflowTaskTimeout</span><span class="p">,</span>
    <span class="n">DagRunNotFound</span><span class="p">,</span>
    <span class="n">RemovedInAirflow3Warning</span><span class="p">,</span>
    <span class="n">TaskDeferred</span><span class="p">,</span>
    <span class="n">UnmappableXComLengthPushed</span><span class="p">,</span>
    <span class="n">UnmappableXComTypePushed</span><span class="p">,</span>
    <span class="n">XComForMappingNotPushed</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">airflow.listeners.listener</span> <span class="kn">import</span> <span class="n">get_listener_manager</span>
<span class="kn">from</span> <span class="nn">airflow.models.base</span> <span class="kn">import</span> <span class="n">Base</span><span class="p">,</span> <span class="n">StringID</span>
<span class="kn">from</span> <span class="nn">airflow.models.dagbag</span> <span class="kn">import</span> <span class="n">DagBag</span>
<span class="kn">from</span> <span class="nn">airflow.models.log</span> <span class="kn">import</span> <span class="n">Log</span>
<span class="kn">from</span> <span class="nn">airflow.models.mappedoperator</span> <span class="kn">import</span> <span class="n">MappedOperator</span>
<span class="kn">from</span> <span class="nn">airflow.models.param</span> <span class="kn">import</span> <span class="n">process_params</span>
<span class="kn">from</span> <span class="nn">airflow.models.taskfail</span> <span class="kn">import</span> <span class="n">TaskFail</span>
<span class="kn">from</span> <span class="nn">airflow.models.taskinstancekey</span> <span class="kn">import</span> <span class="n">TaskInstanceKey</span>
<span class="kn">from</span> <span class="nn">airflow.models.taskmap</span> <span class="kn">import</span> <span class="n">TaskMap</span>
<span class="kn">from</span> <span class="nn">airflow.models.taskreschedule</span> <span class="kn">import</span> <span class="n">TaskReschedule</span>
<span class="kn">from</span> <span class="nn">airflow.models.xcom</span> <span class="kn">import</span> <span class="n">LazyXComAccess</span><span class="p">,</span> <span class="n">XCom</span>
<span class="kn">from</span> <span class="nn">airflow.plugins_manager</span> <span class="kn">import</span> <span class="n">integrate_macros_plugins</span>
<span class="kn">from</span> <span class="nn">airflow.sentry</span> <span class="kn">import</span> <span class="n">Sentry</span>
<span class="kn">from</span> <span class="nn">airflow.stats</span> <span class="kn">import</span> <span class="n">Stats</span>
<span class="kn">from</span> <span class="nn">airflow.templates</span> <span class="kn">import</span> <span class="n">SandboxedEnvironment</span>
<span class="kn">from</span> <span class="nn">airflow.ti_deps.dep_context</span> <span class="kn">import</span> <span class="n">DepContext</span>
<span class="kn">from</span> <span class="nn">airflow.ti_deps.dependencies_deps</span> <span class="kn">import</span> <span class="n">REQUEUEABLE_DEPS</span><span class="p">,</span> <span class="n">RUNNING_DEPS</span>
<span class="kn">from</span> <span class="nn">airflow.timetables.base</span> <span class="kn">import</span> <span class="n">DataInterval</span>
<span class="kn">from</span> <span class="nn">airflow.typing_compat</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">TypeGuard</span>
<span class="kn">from</span> <span class="nn">airflow.utils</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">airflow.utils.context</span> <span class="kn">import</span> <span class="n">ConnectionAccessor</span><span class="p">,</span> <span class="n">Context</span><span class="p">,</span> <span class="n">VariableAccessor</span><span class="p">,</span> <span class="n">context_merge</span>
<span class="kn">from</span> <span class="nn">airflow.utils.email</span> <span class="kn">import</span> <span class="n">send_email</span>
<span class="kn">from</span> <span class="nn">airflow.utils.helpers</span> <span class="kn">import</span> <span class="n">prune_dict</span><span class="p">,</span> <span class="n">render_template_to_string</span>
<span class="kn">from</span> <span class="nn">airflow.utils.log.logging_mixin</span> <span class="kn">import</span> <span class="n">LoggingMixin</span>
<span class="kn">from</span> <span class="nn">airflow.utils.module_loading</span> <span class="kn">import</span> <span class="n">qualname</span>
<span class="kn">from</span> <span class="nn">airflow.utils.net</span> <span class="kn">import</span> <span class="n">get_hostname</span>
<span class="kn">from</span> <span class="nn">airflow.utils.operator_helpers</span> <span class="kn">import</span> <span class="n">context_to_airflow_vars</span>
<span class="kn">from</span> <span class="nn">airflow.utils.platform</span> <span class="kn">import</span> <span class="n">getuser</span>
<span class="kn">from</span> <span class="nn">airflow.utils.retries</span> <span class="kn">import</span> <span class="n">run_with_db_retries</span>
<span class="kn">from</span> <span class="nn">airflow.utils.session</span> <span class="kn">import</span> <span class="n">NEW_SESSION</span><span class="p">,</span> <span class="n">create_session</span><span class="p">,</span> <span class="n">provide_session</span>
<span class="kn">from</span> <span class="nn">airflow.utils.sqlalchemy</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ExecutorConfigType</span><span class="p">,</span>
    <span class="n">ExtendedJSON</span><span class="p">,</span>
    <span class="n">UtcDateTime</span><span class="p">,</span>
    <span class="n">tuple_in_condition</span><span class="p">,</span>
    <span class="n">with_row_locks</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">airflow.utils.state</span> <span class="kn">import</span> <span class="n">DagRunState</span><span class="p">,</span> <span class="n">JobState</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">TaskInstanceState</span>
<span class="kn">from</span> <span class="nn">airflow.utils.task_group</span> <span class="kn">import</span> <span class="n">MappedTaskGroup</span>
<span class="kn">from</span> <span class="nn">airflow.utils.task_instance_session</span> <span class="kn">import</span> <span class="n">set_current_task_instance_session</span>
<span class="kn">from</span> <span class="nn">airflow.utils.timeout</span> <span class="kn">import</span> <span class="n">timeout</span>
<span class="kn">from</span> <span class="nn">airflow.utils.xcom</span> <span class="kn">import</span> <span class="n">XCOM_RETURN_KEY</span>

<div class="viewcode-block" id="TR"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TR">[docs]</a><span class="n">TR</span> <span class="o">=</span> <span class="n">TaskReschedule</span></div>

<span class="n">_CURRENT_CONTEXT</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Context</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<div class="viewcode-block" id="log"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.log">[docs]</a><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span></div>


<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">airflow.models.abstractoperator</span> <span class="kn">import</span> <span class="n">TaskStateChangeCallback</span>
    <span class="kn">from</span> <span class="nn">airflow.models.baseoperator</span> <span class="kn">import</span> <span class="n">BaseOperator</span>
    <span class="kn">from</span> <span class="nn">airflow.models.dag</span> <span class="kn">import</span> <span class="n">DAG</span><span class="p">,</span> <span class="n">DagModel</span>
    <span class="kn">from</span> <span class="nn">airflow.models.dagrun</span> <span class="kn">import</span> <span class="n">DagRun</span>
    <span class="kn">from</span> <span class="nn">airflow.models.dataset</span> <span class="kn">import</span> <span class="n">DatasetEvent</span>
    <span class="kn">from</span> <span class="nn">airflow.models.operator</span> <span class="kn">import</span> <span class="n">Operator</span>
    <span class="kn">from</span> <span class="nn">airflow.utils.task_group</span> <span class="kn">import</span> <span class="n">TaskGroup</span>

    <span class="c1"># This is a workaround because mypy doesn&#39;t work with hybrid_property</span>
    <span class="c1"># TODO: remove this hack and move hybrid_property back to main import block</span>
    <span class="c1"># See https://github.com/python/mypy/issues/4430</span>
<div class="viewcode-block" id="hybrid_property"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.hybrid_property">[docs]</a>    <span class="n">hybrid_property</span> <span class="o">=</span> <span class="nb">property</span></div>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sqlalchemy.ext.hybrid</span> <span class="kn">import</span> <span class="n">hybrid_property</span>


<div class="viewcode-block" id="PAST_DEPENDS_MET"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.PAST_DEPENDS_MET">[docs]</a><span class="n">PAST_DEPENDS_MET</span> <span class="o">=</span> <span class="s2">&quot;past_depends_met&quot;</span></div>


<span class="k">class</span> <span class="nc">TaskReturnCode</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enum to signal manner of exit for task run command.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">DEFERRED</span> <span class="o">=</span> <span class="mi">100</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;When task exits with deferral to trigger.&quot;&quot;&quot;</span>


<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<div class="viewcode-block" id="set_current_context"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.set_current_context">[docs]</a><span class="k">def</span> <span class="nf">set_current_context</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Context</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the current execution context to the provided context object.</span>

<span class="sd">    This method should be called once per Task execution, before calling operator.execute.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_CURRENT_CONTEXT</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">context</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">expected_state</span> <span class="o">=</span> <span class="n">_CURRENT_CONTEXT</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">expected_state</span> <span class="o">!=</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Current context is not equal to the state at context stack. Expected=</span><span class="si">%s</span><span class="s2">, got=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">context</span><span class="p">,</span>
                <span class="n">expected_state</span><span class="p">,</span>
            <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_stop_remaining_tasks</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stop non-teardown tasks in dag.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag_run</span><span class="o">.</span><span class="n">get_task_instances</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">dag</span><span class="p">,</span> <span class="n">DAG</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="n">tis</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ti</span><span class="o">.</span><span class="n">task_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span> <span class="ow">or</span> <span class="n">ti</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span>
            <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">task_dict</span><span class="p">[</span><span class="n">ti</span><span class="o">.</span><span class="n">task_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">is_teardown</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ti</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Forcing task </span><span class="si">%s</span><span class="s2"> to fail due to dag&#39;s `fail_stop` setting&quot;</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">task_id</span><span class="p">)</span>
                <span class="n">ti</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting task </span><span class="si">%s</span><span class="s2"> to SKIPPED due to dag&#39;s `fail_stop` setting.&quot;</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">task_id</span><span class="p">)</span>
                <span class="n">ti</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">SKIPPED</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Not skipping teardown task &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">task_id</span><span class="p">)</span>


<div class="viewcode-block" id="clear_task_instances"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.clear_task_instances">[docs]</a><span class="k">def</span> <span class="nf">clear_task_instances</span><span class="p">(</span>
    <span class="n">tis</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TaskInstance</span><span class="p">],</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span>
    <span class="n">activate_dag_runs</span><span class="p">:</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dag</span><span class="p">:</span> <span class="n">DAG</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dag_run_state</span><span class="p">:</span> <span class="n">DagRunState</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">=</span> <span class="n">DagRunState</span><span class="o">.</span><span class="n">QUEUED</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clear a set of task instances, but make sure the running ones get killed.</span>

<span class="sd">    Also sets Dagrun&#39;s `state` to QUEUED and `start_date` to the time of execution.</span>
<span class="sd">    But only for finished DRs (SUCCESS and FAILED).</span>
<span class="sd">    Doesn&#39;t clear DR&#39;s `state` and `start_date`for running</span>
<span class="sd">    DRs (QUEUED and RUNNING) because clearing the state for already</span>
<span class="sd">    running DR is redundant and clearing `start_date` affects DR&#39;s duration.</span>

<span class="sd">    :param tis: a list of task instances</span>
<span class="sd">    :param session: current session</span>
<span class="sd">    :param dag_run_state: state to set finished DagRuns to.</span>
<span class="sd">        If set to False, DagRuns state will not be changed.</span>
<span class="sd">    :param dag: DAG object</span>
<span class="sd">    :param activate_dag_runs: Deprecated parameter, do not pass</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Keys: dag_id -&gt; run_id -&gt; map_indexes -&gt; try_numbers -&gt; task_id</span>
    <span class="n">task_id_by_key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)))</span>
    <span class="p">)</span>
    <span class="n">dag_bag</span> <span class="o">=</span> <span class="n">DagBag</span><span class="p">(</span><span class="n">read_dags_from_db</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="n">tis</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ti</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ti</span><span class="o">.</span><span class="n">job_id</span><span class="p">:</span>
                <span class="c1"># If a task is cleared when running, set its state to RESTARTING so that</span>
                <span class="c1"># the task is terminated and becomes eligible for retry.</span>
                <span class="n">ti</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">RESTARTING</span>
                <span class="n">job_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ti_dag</span> <span class="o">=</span> <span class="n">dag</span> <span class="k">if</span> <span class="n">dag</span> <span class="ow">and</span> <span class="n">dag</span><span class="o">.</span><span class="n">dag_id</span> <span class="o">==</span> <span class="n">ti</span><span class="o">.</span><span class="n">dag_id</span> <span class="k">else</span> <span class="n">dag_bag</span><span class="o">.</span><span class="n">get_dag</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">dag_id</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
            <span class="n">task_id</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">task_id</span>
            <span class="k">if</span> <span class="n">ti_dag</span> <span class="ow">and</span> <span class="n">ti_dag</span><span class="o">.</span><span class="n">has_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">ti_dag</span><span class="o">.</span><span class="n">get_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
                <span class="n">ti</span><span class="o">.</span><span class="n">refresh_from_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                <span class="n">task_retries</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">retries</span>
                <span class="n">ti</span><span class="o">.</span><span class="n">max_tries</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">try_number</span> <span class="o">+</span> <span class="n">task_retries</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Ignore errors when updating max_tries if the DAG or</span>
                <span class="c1"># task are not found since database records could be</span>
                <span class="c1"># outdated. We make max_tries the maximum value of its</span>
                <span class="c1"># original max_tries or the last attempted try number.</span>
                <span class="n">ti</span><span class="o">.</span><span class="n">max_tries</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">max_tries</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">prev_attempted_tries</span><span class="p">)</span>
            <span class="n">ti</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ti</span><span class="o">.</span><span class="n">external_executor_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ti</span><span class="o">.</span><span class="n">clear_next_method_args</span><span class="p">()</span>
            <span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ti</span><span class="p">)</span>

        <span class="n">task_id_by_key</span><span class="p">[</span><span class="n">ti</span><span class="o">.</span><span class="n">dag_id</span><span class="p">][</span><span class="n">ti</span><span class="o">.</span><span class="n">run_id</span><span class="p">][</span><span class="n">ti</span><span class="o">.</span><span class="n">map_index</span><span class="p">][</span><span class="n">ti</span><span class="o">.</span><span class="n">try_number</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">task_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">task_id_by_key</span><span class="p">:</span>
        <span class="c1"># Clear all reschedules related to the ti to clear</span>

        <span class="c1"># This is an optimization for the common case where all tis are for a small number</span>
        <span class="c1"># of dag_id, run_id, try_number, and map_index. Use a nested dict of dag_id,</span>
        <span class="c1"># run_id, try_number, map_index, and task_id to construct the where clause in a</span>
        <span class="c1"># hierarchical manner. This speeds up the delete statement by more than 40x for</span>
        <span class="c1"># large number of tis (50k+).</span>
        <span class="n">conditions</span> <span class="o">=</span> <span class="n">or_</span><span class="p">(</span>
            <span class="n">and_</span><span class="p">(</span>
                <span class="n">TR</span><span class="o">.</span><span class="n">dag_id</span> <span class="o">==</span> <span class="n">dag_id</span><span class="p">,</span>
                <span class="n">or_</span><span class="p">(</span>
                    <span class="n">and_</span><span class="p">(</span>
                        <span class="n">TR</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="n">run_id</span><span class="p">,</span>
                        <span class="n">or_</span><span class="p">(</span>
                            <span class="n">and_</span><span class="p">(</span>
                                <span class="n">TR</span><span class="o">.</span><span class="n">map_index</span> <span class="o">==</span> <span class="n">map_index</span><span class="p">,</span>
                                <span class="n">or_</span><span class="p">(</span>
                                    <span class="n">and_</span><span class="p">(</span><span class="n">TR</span><span class="o">.</span><span class="n">try_number</span> <span class="o">==</span> <span class="n">try_number</span><span class="p">,</span> <span class="n">TR</span><span class="o">.</span><span class="n">task_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">task_ids</span><span class="p">))</span>
                                    <span class="k">for</span> <span class="n">try_number</span><span class="p">,</span> <span class="n">task_ids</span> <span class="ow">in</span> <span class="n">task_tries</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                <span class="p">),</span>
                            <span class="p">)</span>
                            <span class="k">for</span> <span class="n">map_index</span><span class="p">,</span> <span class="n">task_tries</span> <span class="ow">in</span> <span class="n">map_indexes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">map_indexes</span> <span class="ow">in</span> <span class="n">run_ids</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">dag_id</span><span class="p">,</span> <span class="n">run_ids</span> <span class="ow">in</span> <span class="n">task_id_by_key</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">delete_qry</span> <span class="o">=</span> <span class="n">TR</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">delete_qry</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">airflow.jobs.job</span> <span class="kn">import</span> <span class="n">Job</span>

        <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">(</span><span class="n">Job</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Job</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">JobState</span><span class="o">.</span><span class="n">RESTARTING</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">activate_dag_runs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;`activate_dag_runs` parameter to clear_task_instances function is deprecated. &quot;</span>
            <span class="s2">&quot;Please use `dag_run_state`&quot;</span><span class="p">,</span>
            <span class="n">RemovedInAirflow3Warning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">activate_dag_runs</span><span class="p">:</span>
            <span class="n">dag_run_state</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">dag_run_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">tis</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">airflow.models.dagrun</span> <span class="kn">import</span> <span class="n">DagRun</span>  <span class="c1"># Avoid circular import</span>

        <span class="n">run_ids_by_dag_id</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">tis</span><span class="p">:</span>
            <span class="n">run_ids_by_dag_id</span><span class="p">[</span><span class="n">instance</span><span class="o">.</span><span class="n">dag_id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span>

        <span class="n">drs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DagRun</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">or_</span><span class="p">(</span>
                    <span class="n">and_</span><span class="p">(</span><span class="n">DagRun</span><span class="o">.</span><span class="n">dag_id</span> <span class="o">==</span> <span class="n">dag_id</span><span class="p">,</span> <span class="n">DagRun</span><span class="o">.</span><span class="n">run_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">run_ids</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">dag_id</span><span class="p">,</span> <span class="n">run_ids</span> <span class="ow">in</span> <span class="n">run_ids_by_dag_id</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">dag_run_state</span> <span class="o">=</span> <span class="n">DagRunState</span><span class="p">(</span><span class="n">dag_run_state</span><span class="p">)</span>  <span class="c1"># Validate the state value.</span>
        <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="n">drs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dr</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="n">State</span><span class="o">.</span><span class="n">finished_dr_states</span><span class="p">:</span>
                <span class="n">dr</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">dag_run_state</span>
                <span class="n">dr</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">dag_run_state</span> <span class="o">==</span> <span class="n">DagRunState</span><span class="o">.</span><span class="n">QUEUED</span><span class="p">:</span>
                    <span class="n">dr</span><span class="o">.</span><span class="n">last_scheduling_decision</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">dr</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">_is_mappable_value</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeGuard</span><span class="p">[</span><span class="n">Collection</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Whether a value can be used for task mapping.</span>

<span class="sd">    We only allow collections with guaranteed ordering, but exclude character</span>
<span class="sd">    sequences since that&#39;s usually not what users would expect to be mappable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytearray</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">_creator_note</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creator the ``note`` association proxy.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TaskInstanceNote</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">val</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TaskInstanceNote</span><span class="p">(</span><span class="o">**</span><span class="n">val</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TaskInstanceNote</span><span class="p">(</span><span class="o">*</span><span class="n">val</span><span class="p">)</span>


<div class="viewcode-block" id="TaskInstance"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance">[docs]</a><span class="k">class</span> <span class="nc">TaskInstance</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">LoggingMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task instances store the state of a task instance.</span>

<span class="sd">    This table is the authority and single source of truth around what tasks</span>
<span class="sd">    have run and the state they are in.</span>

<span class="sd">    The SqlAlchemy model doesn&#39;t have a SqlAlchemy foreign key to the task or</span>
<span class="sd">    dag model deliberately to have more control over transactions.</span>

<span class="sd">    Database transactions on this table should insure double triggers and</span>
<span class="sd">    any confusion around what task instances are or aren&#39;t ready to run</span>
<span class="sd">    even while multiple schedulers may be firing task instances.</span>

<span class="sd">    A value of -1 in map_index represents any of: a TI without mapped tasks;</span>
<span class="sd">    a TI with mapped tasks that has yet to be expanded (state=pending);</span>
<span class="sd">    a TI with mapped tasks that expanded to an empty list (state=skipped).</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TaskInstance.__tablename__"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.__tablename__">[docs]</a>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;task_instance&quot;</span></div>
<div class="viewcode-block" id="TaskInstance.task_id"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.task_id">[docs]</a>    <span class="n">task_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">StringID</span><span class="p">(),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstance.dag_id"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.dag_id">[docs]</a>    <span class="n">dag_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">StringID</span><span class="p">(),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstance.run_id"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.run_id">[docs]</a>    <span class="n">run_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">StringID</span><span class="p">(),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstance.map_index"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.map_index">[docs]</a>    <span class="n">map_index</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">server_default</span><span class="o">=</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;-1&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="TaskInstance.start_date"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.start_date">[docs]</a>    <span class="n">start_date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UtcDateTime</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstance.end_date"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.end_date">[docs]</a>    <span class="n">end_date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UtcDateTime</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstance.duration"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.duration">[docs]</a>    <span class="n">duration</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Float</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstance.state"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.state">[docs]</a>    <span class="n">state</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span></div>
    <span class="n">_try_number</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;try_number&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<div class="viewcode-block" id="TaskInstance.max_tries"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.max_tries">[docs]</a>    <span class="n">max_tries</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">server_default</span><span class="o">=</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;-1&quot;</span><span class="p">))</span></div>
<div class="viewcode-block" id="TaskInstance.hostname"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.hostname">[docs]</a>    <span class="n">hostname</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span></div>
<div class="viewcode-block" id="TaskInstance.unixname"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.unixname">[docs]</a>    <span class="n">unixname</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span></div>
<div class="viewcode-block" id="TaskInstance.job_id"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.job_id">[docs]</a>    <span class="n">job_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstance.pool"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.pool">[docs]</a>    <span class="n">pool</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstance.pool_slots"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.pool_slots">[docs]</a>    <span class="n">pool_slots</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstance.queue"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.queue">[docs]</a>    <span class="n">queue</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span></div>
<div class="viewcode-block" id="TaskInstance.priority_weight"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.priority_weight">[docs]</a>    <span class="n">priority_weight</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstance.operator"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.operator">[docs]</a>    <span class="n">operator</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span></div>
<div class="viewcode-block" id="TaskInstance.custom_operator_name"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.custom_operator_name">[docs]</a>    <span class="n">custom_operator_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span></div>
<div class="viewcode-block" id="TaskInstance.queued_dttm"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.queued_dttm">[docs]</a>    <span class="n">queued_dttm</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UtcDateTime</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstance.queued_by_job_id"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.queued_by_job_id">[docs]</a>    <span class="n">queued_by_job_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstance.pid"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.pid">[docs]</a>    <span class="n">pid</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstance.executor_config"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.executor_config">[docs]</a>    <span class="n">executor_config</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ExecutorConfigType</span><span class="p">(</span><span class="n">pickler</span><span class="o">=</span><span class="n">dill</span><span class="p">))</span></div>
<div class="viewcode-block" id="TaskInstance.updated_at"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.updated_at">[docs]</a>    <span class="n">updated_at</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UtcDateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">,</span> <span class="n">onupdate</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span></div>

<div class="viewcode-block" id="TaskInstance.external_executor_id"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.external_executor_id">[docs]</a>    <span class="n">external_executor_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">StringID</span><span class="p">())</span></div>

    <span class="c1"># The trigger to resume on if we are in state DEFERRED</span>
<div class="viewcode-block" id="TaskInstance.trigger_id"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.trigger_id">[docs]</a>    <span class="n">trigger_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span></div>

    <span class="c1"># Optional timeout datetime for the trigger (past this, we&#39;ll fail)</span>
<div class="viewcode-block" id="TaskInstance.trigger_timeout"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.trigger_timeout">[docs]</a>    <span class="n">trigger_timeout</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">)</span></div>
    <span class="c1"># The trigger_timeout should be TIMESTAMP(using UtcDateTime) but for ease of</span>
    <span class="c1"># migration, we are keeping it as DateTime pending a change where expensive</span>
    <span class="c1"># migration is inevitable.</span>

    <span class="c1"># The method to call next, and any extra arguments to pass to it.</span>
    <span class="c1"># Usually used when resuming from DEFERRED.</span>
<div class="viewcode-block" id="TaskInstance.next_method"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.next_method">[docs]</a>    <span class="n">next_method</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span></div>
<div class="viewcode-block" id="TaskInstance.next_kwargs"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.next_kwargs">[docs]</a>    <span class="n">next_kwargs</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">MutableDict</span><span class="o">.</span><span class="n">as_mutable</span><span class="p">(</span><span class="n">ExtendedJSON</span><span class="p">))</span></div>

    <span class="c1"># If adding new fields here then remember to add them to</span>
    <span class="c1"># refresh_from_db() or they won&#39;t display in the UI correctly</span>

<div class="viewcode-block" id="TaskInstance.__table_args__"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.__table_args__">[docs]</a>    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Index</span><span class="p">(</span><span class="s2">&quot;ti_dag_state&quot;</span><span class="p">,</span> <span class="n">dag_id</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span>
        <span class="n">Index</span><span class="p">(</span><span class="s2">&quot;ti_dag_run&quot;</span><span class="p">,</span> <span class="n">dag_id</span><span class="p">,</span> <span class="n">run_id</span><span class="p">),</span>
        <span class="n">Index</span><span class="p">(</span><span class="s2">&quot;ti_state&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span>
        <span class="n">Index</span><span class="p">(</span><span class="s2">&quot;ti_state_lkp&quot;</span><span class="p">,</span> <span class="n">dag_id</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span>
        <span class="c1"># The below index has been added to improve performance on postgres setups with tens of millions of</span>
        <span class="c1"># taskinstance rows. Aim is to improve the below query (it can be used to find the last successful</span>
        <span class="c1"># execution date of a task instance):</span>
        <span class="c1">#    SELECT start_date FROM task_instance WHERE dag_id = &#39;xx&#39; AND task_id = &#39;yy&#39; AND state = &#39;success&#39;</span>
        <span class="c1">#    ORDER BY start_date DESC NULLS LAST LIMIT 1;</span>
        <span class="c1"># Existing &quot;ti_state_lkp&quot; is not enough for such query when this table has millions of rows, since</span>
        <span class="c1"># rows have to be fetched in order to retrieve the start_date column. With this index, INDEX ONLY SCAN</span>
        <span class="c1"># is performed and that query runs within milliseconds.</span>
        <span class="n">Index</span><span class="p">(</span><span class="s2">&quot;ti_state_incl_start_date&quot;</span><span class="p">,</span> <span class="n">dag_id</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">postgresql_include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">]),</span>
        <span class="n">Index</span><span class="p">(</span><span class="s2">&quot;ti_pool&quot;</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">priority_weight</span><span class="p">),</span>
        <span class="n">Index</span><span class="p">(</span><span class="s2">&quot;ti_job_id&quot;</span><span class="p">,</span> <span class="n">job_id</span><span class="p">),</span>
        <span class="n">Index</span><span class="p">(</span><span class="s2">&quot;ti_trigger_id&quot;</span><span class="p">,</span> <span class="n">trigger_id</span><span class="p">),</span>
        <span class="n">PrimaryKeyConstraint</span><span class="p">(</span>
            <span class="s2">&quot;dag_id&quot;</span><span class="p">,</span> <span class="s2">&quot;task_id&quot;</span><span class="p">,</span> <span class="s2">&quot;run_id&quot;</span><span class="p">,</span> <span class="s2">&quot;map_index&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;task_instance_pkey&quot;</span><span class="p">,</span> <span class="n">mssql_clustered</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">),</span>
        <span class="n">ForeignKeyConstraint</span><span class="p">(</span>
            <span class="p">[</span><span class="n">trigger_id</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;trigger.id&quot;</span><span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;task_instance_trigger_id_fkey&quot;</span><span class="p">,</span>
            <span class="n">ondelete</span><span class="o">=</span><span class="s2">&quot;CASCADE&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">ForeignKeyConstraint</span><span class="p">(</span>
            <span class="p">[</span><span class="n">dag_id</span><span class="p">,</span> <span class="n">run_id</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;dag_run.dag_id&quot;</span><span class="p">,</span> <span class="s2">&quot;dag_run.run_id&quot;</span><span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;task_instance_dag_run_fkey&quot;</span><span class="p">,</span>
            <span class="n">ondelete</span><span class="o">=</span><span class="s2">&quot;CASCADE&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="TaskInstance.dag_model"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.dag_model">[docs]</a>    <span class="n">dag_model</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;DagModel&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;TaskInstance.dag_id == DagModel.dag_id&quot;</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">dag_id</span><span class="p">,</span>
        <span class="n">uselist</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">innerjoin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">viewonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="TaskInstance.trigger"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.trigger">[docs]</a>    <span class="n">trigger</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Trigger&quot;</span><span class="p">,</span> <span class="n">uselist</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;task_instance&quot;</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstance.triggerer_job"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.triggerer_job">[docs]</a>    <span class="n">triggerer_job</span> <span class="o">=</span> <span class="n">association_proxy</span><span class="p">(</span><span class="s2">&quot;trigger&quot;</span><span class="p">,</span> <span class="s2">&quot;triggerer_job&quot;</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstance.dag_run"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.dag_run">[docs]</a>    <span class="n">dag_run</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;DagRun&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;task_instances&quot;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s2">&quot;joined&quot;</span><span class="p">,</span> <span class="n">innerjoin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstance.rendered_task_instance_fields"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.rendered_task_instance_fields">[docs]</a>    <span class="n">rendered_task_instance_fields</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;RenderedTaskInstanceFields&quot;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s2">&quot;noload&quot;</span><span class="p">,</span> <span class="n">uselist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstance.execution_date"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.execution_date">[docs]</a>    <span class="n">execution_date</span> <span class="o">=</span> <span class="n">association_proxy</span><span class="p">(</span><span class="s2">&quot;dag_run&quot;</span><span class="p">,</span> <span class="s2">&quot;execution_date&quot;</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstance.task_instance_note"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.task_instance_note">[docs]</a>    <span class="n">task_instance_note</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;TaskInstanceNote&quot;</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;task_instance&quot;</span><span class="p">,</span>
        <span class="n">uselist</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;all, delete, delete-orphan&quot;</span><span class="p">,</span>
    <span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstance.note"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.note">[docs]</a>    <span class="n">note</span> <span class="o">=</span> <span class="n">association_proxy</span><span class="p">(</span><span class="s2">&quot;task_instance_note&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="n">_creator_note</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstance.task"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.task">[docs]</a>    <span class="n">task</span><span class="p">:</span> <span class="n">Operator</span>  <span class="c1"># Not always set...</span></div>

    <span class="n">is_trigger_log_context</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Indicate to FileTaskHandler that logging context should be set up for trigger logging.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">task</span><span class="p">:</span> <span class="n">Operator</span><span class="p">,</span>
        <span class="n">execution_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">map_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">dag_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">task_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_index</span> <span class="o">=</span> <span class="n">map_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_from_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="c1"># init_on_load will config the log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_on_load</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">run_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">execution_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">airflow.models.dagrun</span> <span class="kn">import</span> <span class="n">DagRun</span>  <span class="c1"># Avoid circular import</span>

            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Passing an execution_date to `TaskInstance()` is deprecated in favour of passing a run_id&quot;</span><span class="p">,</span>
                <span class="n">RemovedInAirflow3Warning</span><span class="p">,</span>
                <span class="c1"># Stack level is 4 because SQLA adds some wrappers around the constructor</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># make sure we have a localized execution_date stored in UTC</span>
            <span class="k">if</span> <span class="n">execution_date</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">timezone</span><span class="o">.</span><span class="n">is_localized</span><span class="p">(</span><span class="n">execution_date</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;execution date </span><span class="si">%s</span><span class="s2"> has no timezone information. Using default from dag or system&quot;</span><span class="p">,</span>
                    <span class="n">execution_date</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">has_dag</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">dag</span>
                    <span class="n">execution_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">make_aware</span><span class="p">(</span><span class="n">execution_date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">timezone</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">execution_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">make_aware</span><span class="p">(</span><span class="n">execution_date</span><span class="p">)</span>

                <span class="n">execution_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">convert_to_utc</span><span class="p">(</span><span class="n">execution_date</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">create_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">run_id</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DagRun</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">dag_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="p">,</span> <span class="n">execution_date</span><span class="o">=</span><span class="n">execution_date</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">run_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">DagRunNotFound</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;DagRun for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="si">!r}</span><span class="s2"> with date </span><span class="si">{</span><span class="n">execution_date</span><span class="si">}</span><span class="s2"> not found&quot;</span>
                    <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_id</span> <span class="o">=</span> <span class="n">run_id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">try_number</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_tries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">retries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unixname</span> <span class="o">=</span> <span class="n">getuser</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># Is this TaskInstance being currently running within `airflow tasks run --raw`.</span>
        <span class="c1"># Not persisted to the database so only valid for the current process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># can be changed when calling &#39;run&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_mode</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="TaskInstance.stats_tags"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.stats_tags">[docs]</a>    <span class="k">def</span> <span class="nf">stats_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">prune_dict</span><span class="p">({</span><span class="s2">&quot;dag_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="p">,</span> <span class="s2">&quot;task_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">})</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">insert_mapping</span><span class="p">(</span><span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Operator</span><span class="p">,</span> <span class="n">map_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Insert mapping.</span>

<span class="sd">        :meta private:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;dag_id&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">dag_id</span><span class="p">,</span>
            <span class="s2">&quot;task_id&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
            <span class="s2">&quot;run_id&quot;</span><span class="p">:</span> <span class="n">run_id</span><span class="p">,</span>
            <span class="s2">&quot;_try_number&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;unixname&quot;</span><span class="p">:</span> <span class="n">getuser</span><span class="p">(),</span>
            <span class="s2">&quot;queue&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span>
            <span class="s2">&quot;pool&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">pool</span><span class="p">,</span>
            <span class="s2">&quot;pool_slots&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">pool_slots</span><span class="p">,</span>
            <span class="s2">&quot;priority_weight&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">priority_weight_total</span><span class="p">,</span>
            <span class="s2">&quot;run_as_user&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">run_as_user</span><span class="p">,</span>
            <span class="s2">&quot;max_tries&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">retries</span><span class="p">,</span>
            <span class="s2">&quot;executor_config&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">executor_config</span><span class="p">,</span>
            <span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">task_type</span><span class="p">,</span>
            <span class="s2">&quot;custom_operator_name&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">&quot;custom_operator_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;map_index&quot;</span><span class="p">:</span> <span class="n">map_index</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@reconstructor</span>
<div class="viewcode-block" id="TaskInstance.init_on_load"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.init_on_load">[docs]</a>    <span class="k">def</span> <span class="nf">init_on_load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the attributes that aren&#39;t stored in the DB.&quot;&quot;&quot;</span>
        <span class="c1"># correctly config the ti log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;airflow.task&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_mode</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># can be changed when calling &#39;run&#39;</span></div>

    <span class="nd">@hybrid_property</span>
<div class="viewcode-block" id="TaskInstance.try_number"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.try_number">[docs]</a>    <span class="k">def</span> <span class="nf">try_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the try number that this task number will be when it is actually run.</span>

<span class="sd">        If the TaskInstance is currently running, this will match the column in the</span>
<span class="sd">        database, in all other cases this will be incremented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This is designed so that task logs end up in the right file.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_number</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_number</span> <span class="o">+</span> <span class="mi">1</span></div>

    <span class="nd">@try_number</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">try_number</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_try_number</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="TaskInstance.prev_attempted_tries"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.prev_attempted_tries">[docs]</a>    <span class="k">def</span> <span class="nf">prev_attempted_tries</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the number of previously attempted tries, defaulting to 0.</span>

<span class="sd">        Expose this for the Task Tries and Gantt graph views.</span>
<span class="sd">        Using `try_number` throws off the counts for non-running tasks.</span>
<span class="sd">        Also useful in error logging contexts to get the try number for the last try that was attempted.</span>
<span class="sd">        https://issues.apache.org/jira/browse/AIRFLOW-2143</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_number</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="TaskInstance.next_try_number"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.next_try_number">[docs]</a>    <span class="k">def</span> <span class="nf">next_try_number</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_number</span> <span class="o">+</span> <span class="mi">1</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="TaskInstance.operator_name"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.operator_name">[docs]</a>    <span class="k">def</span> <span class="nf">operator_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;@property: use a more friendly display name for the operator, if set.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_operator_name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span></div>

<div class="viewcode-block" id="TaskInstance.command_as_list"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.command_as_list">[docs]</a>    <span class="k">def</span> <span class="nf">command_as_list</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mark_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ignore_all_deps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ignore_task_deps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ignore_depends_on_past</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">wait_for_past_depends_before_skipping</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ignore_ti_state</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">local</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">pickle_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">job_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cfg_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a command that can be executed anywhere where airflow is installed.</span>

<span class="sd">        This command is part of the message sent to executors by the orchestrator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dag</span><span class="p">:</span> <span class="n">DAG</span> <span class="o">|</span> <span class="n">DagModel</span>
        <span class="c1"># Use the dag if we have it, else fallback to the ORM dag_model, which might not be loaded</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;task&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="s2">&quot;dag&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">dag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">dag</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag_model</span>

        <span class="n">should_pass_filepath</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">pickle_id</span> <span class="ow">and</span> <span class="n">dag</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">PurePath</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">should_pass_filepath</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dag</span><span class="o">.</span><span class="n">is_subdag</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">dag</span><span class="o">.</span><span class="n">parent_dag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">dag</span><span class="o">.</span><span class="n">parent_dag</span><span class="o">.</span><span class="n">relative_fileloc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">dag</span><span class="o">.</span><span class="n">relative_fileloc</span>

            <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;DAGS_FOLDER&quot;</span> <span class="o">/</span> <span class="n">path</span>

        <span class="k">return</span> <span class="n">TaskInstance</span><span class="o">.</span><span class="n">generate_command</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
            <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
            <span class="n">mark_success</span><span class="o">=</span><span class="n">mark_success</span><span class="p">,</span>
            <span class="n">ignore_all_deps</span><span class="o">=</span><span class="n">ignore_all_deps</span><span class="p">,</span>
            <span class="n">ignore_task_deps</span><span class="o">=</span><span class="n">ignore_task_deps</span><span class="p">,</span>
            <span class="n">ignore_depends_on_past</span><span class="o">=</span><span class="n">ignore_depends_on_past</span><span class="p">,</span>
            <span class="n">wait_for_past_depends_before_skipping</span><span class="o">=</span><span class="n">wait_for_past_depends_before_skipping</span><span class="p">,</span>
            <span class="n">ignore_ti_state</span><span class="o">=</span><span class="n">ignore_ti_state</span><span class="p">,</span>
            <span class="n">local</span><span class="o">=</span><span class="n">local</span><span class="p">,</span>
            <span class="n">pickle_id</span><span class="o">=</span><span class="n">pickle_id</span><span class="p">,</span>
            <span class="n">file_path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
            <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
            <span class="n">pool</span><span class="o">=</span><span class="n">pool</span><span class="p">,</span>
            <span class="n">cfg_path</span><span class="o">=</span><span class="n">cfg_path</span><span class="p">,</span>
            <span class="n">map_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map_index</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="TaskInstance.generate_command"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.generate_command">[docs]</a>    <span class="k">def</span> <span class="nf">generate_command</span><span class="p">(</span>
        <span class="n">dag_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mark_success</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ignore_all_deps</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ignore_depends_on_past</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">wait_for_past_depends_before_skipping</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ignore_task_deps</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ignore_ti_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">local</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">pickle_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">file_path</span><span class="p">:</span> <span class="n">PurePath</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">raw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pool</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cfg_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">map_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the shell command required to execute this task instance.</span>

<span class="sd">        :param dag_id: DAG ID</span>
<span class="sd">        :param task_id: Task ID</span>
<span class="sd">        :param run_id: The run_id of this task&#39;s DagRun</span>
<span class="sd">        :param mark_success: Whether to mark the task as successful</span>
<span class="sd">        :param ignore_all_deps: Ignore all ignorable dependencies.</span>
<span class="sd">            Overrides the other ignore_* parameters.</span>
<span class="sd">        :param ignore_depends_on_past: Ignore depends_on_past parameter of DAGs</span>
<span class="sd">            (e.g. for Backfills)</span>
<span class="sd">        :param wait_for_past_depends_before_skipping: Wait for past depends before marking the ti as skipped</span>
<span class="sd">        :param ignore_task_deps: Ignore task-specific dependencies such as depends_on_past</span>
<span class="sd">            and trigger rule</span>
<span class="sd">        :param ignore_ti_state: Ignore the task instance&#39;s previous failure/success</span>
<span class="sd">        :param local: Whether to run the task locally</span>
<span class="sd">        :param pickle_id: If the DAG was serialized to the DB, the ID</span>
<span class="sd">            associated with the pickled DAG</span>
<span class="sd">        :param file_path: path to the file containing the DAG definition</span>
<span class="sd">        :param raw: raw mode (needs more details)</span>
<span class="sd">        :param job_id: job ID (needs more details)</span>
<span class="sd">        :param pool: the Airflow pool that the task should run in</span>
<span class="sd">        :param cfg_path: the Path to the configuration file</span>
<span class="sd">        :return: shell command that can be used to run the task instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;airflow&quot;</span><span class="p">,</span> <span class="s2">&quot;tasks&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="n">dag_id</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">run_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mark_success</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--mark-success&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">pickle_id</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--pickle&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">pickle_id</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">job_id</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--job-id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">job_id</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">ignore_all_deps</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--ignore-all-dependencies&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ignore_task_deps</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--ignore-dependencies&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ignore_depends_on_past</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--depends-on-past&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore&quot;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">wait_for_past_depends_before_skipping</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--depends-on-past&quot;</span><span class="p">,</span> <span class="s2">&quot;wait&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ignore_ti_state</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--force&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">local</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--local&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--pool&quot;</span><span class="p">,</span> <span class="n">pool</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--raw&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">file_path</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--subdir&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">fspath</span><span class="p">(</span><span class="n">file_path</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">cfg_path</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--cfg-path&quot;</span><span class="p">,</span> <span class="n">cfg_path</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">map_index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--map-index&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">map_index</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">cmd</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="TaskInstance.log_url"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.log_url">[docs]</a>    <span class="k">def</span> <span class="nf">log_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log URL for TaskInstance.&quot;&quot;&quot;</span>
        <span class="n">iso</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execution_date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get_mandatory_value</span><span class="p">(</span><span class="s2">&quot;webserver&quot;</span><span class="p">,</span> <span class="s2">&quot;BASE_URL&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="s2">&quot;/log&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;?execution_date=</span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&amp;task_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&amp;dag_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&amp;map_index=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">map_index</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="TaskInstance.mark_success_url"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.mark_success_url">[docs]</a>    <span class="k">def</span> <span class="nf">mark_success_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;URL to mark TI success.&quot;&quot;&quot;</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get_mandatory_value</span><span class="p">(</span><span class="s2">&quot;webserver&quot;</span><span class="p">,</span> <span class="s2">&quot;BASE_URL&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="s2">&quot;/confirm&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;?task_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&amp;dag_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&amp;dag_run_id=</span><span class="si">{</span><span class="n">quote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="s2">&quot;&amp;upstream=false&quot;</span>
            <span class="s2">&quot;&amp;downstream=false&quot;</span>
            <span class="s2">&quot;&amp;state=success&quot;</span>
        <span class="p">)</span></div>

    <span class="nd">@provide_session</span>
<div class="viewcode-block" id="TaskInstance.current_state"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.current_state">[docs]</a>    <span class="k">def</span> <span class="nf">current_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">NEW_SESSION</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the very latest state from the database.</span>

<span class="sd">        If a session is passed, we use and looking up the state becomes part of the session,</span>
<span class="sd">        otherwise a new session is used.</span>

<span class="sd">        sqlalchemy.inspect is used here to get the primary keys ensuring that if they change</span>
<span class="sd">        it will not regress</span>

<span class="sd">        :param session: SQLAlchemy ORM Session</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">inspect</span><span class="p">(</span><span class="n">TaskInstance</span><span class="p">)</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">TaskInstance</span><span class="o">.</span><span class="n">state</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span></div>

    <span class="nd">@provide_session</span>
<div class="viewcode-block" id="TaskInstance.error"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.error">[docs]</a>    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">NEW_SESSION</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Force the task instance&#39;s state to FAILED in the database.</span>

<span class="sd">        :param session: SQLAlchemy ORM Session</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Recording the task instance as FAILED&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">FAILED</span>
        <span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

    <span class="nd">@provide_session</span>
<div class="viewcode-block" id="TaskInstance.refresh_from_db"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.refresh_from_db">[docs]</a>    <span class="k">def</span> <span class="nf">refresh_from_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">NEW_SESSION</span><span class="p">,</span> <span class="n">lock_for_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Refresh the task instance from the database based on the primary key.</span>

<span class="sd">        :param session: SQLAlchemy ORM Session</span>
<span class="sd">        :param lock_for_update: if True, indicates that the database should</span>
<span class="sd">            lock the TaskInstance (issuing a FOR UPDATE clause) until the</span>
<span class="sd">            session is committed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Refreshing TaskInstance </span><span class="si">%s</span><span class="s2"> from DB&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">TaskInstance</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">column_attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="n">qry</span> <span class="o">=</span> <span class="p">(</span>
            <span class="c1"># To avoid joining any relationships, by default select all</span>
            <span class="c1"># columns, not the object. This also means we get (effectively) a</span>
            <span class="c1"># namedtuple back, not a TI object</span>
            <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="o">*</span><span class="n">TaskInstance</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">dag_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="p">,</span>
                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">task_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">map_index</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_index</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">lock_for_update</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="n">run_with_db_retries</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">attempt</span><span class="p">:</span>
                    <span class="n">ti</span><span class="p">:</span> <span class="n">TaskInstance</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">qry</span><span class="o">.</span><span class="n">with_for_update</span><span class="p">()</span><span class="o">.</span><span class="n">one_or_none</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ti</span> <span class="o">=</span> <span class="n">qry</span><span class="o">.</span><span class="n">one_or_none</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ti</span><span class="p">:</span>
            <span class="c1"># Fields ordered per model definition</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">start_date</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">end_date</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">duration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">state</span>
            <span class="c1"># Since we selected columns, not the object, this is the raw value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">try_number</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">try_number</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_tries</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max_tries</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">hostname</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unixname</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">unixname</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">job_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">pool</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool_slots</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">pool_slots</span> <span class="ow">or</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">queue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priority_weight</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">priority_weight</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">operator</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">custom_operator_name</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">custom_operator_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queued_dttm</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">queued_dttm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queued_by_job_id</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">queued_by_job_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">pid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">executor_config</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">executor_config</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">external_executor_id</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">external_executor_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger_id</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">trigger_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_method</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">next_method</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_kwargs</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">next_kwargs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="TaskInstance.refresh_from_task"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.refresh_from_task">[docs]</a>    <span class="k">def</span> <span class="nf">refresh_from_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Operator</span><span class="p">,</span> <span class="n">pool_override</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy common attributes from the given task.</span>

<span class="sd">        :param task: The task object to copy from</span>
<span class="sd">        :param pool_override: Use the pool_override instead of task&#39;s pool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">pool_override</span> <span class="ow">or</span> <span class="n">task</span><span class="o">.</span><span class="n">pool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool_slots</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">pool_slots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority_weight</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">priority_weight_total</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_as_user</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run_as_user</span>
        <span class="c1"># Do not set max_tries to task.retries here because max_tries is a cumulative</span>
        <span class="c1"># value that needs to be stored in the db.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor_config</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">executor_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">task_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_operator_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">&quot;custom_operator_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

    <span class="nd">@provide_session</span>
<div class="viewcode-block" id="TaskInstance.clear_xcom_data"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.clear_xcom_data">[docs]</a>    <span class="k">def</span> <span class="nf">clear_xcom_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">NEW_SESSION</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear all XCom data from the database for the task instance.</span>

<span class="sd">        If the task is unmapped, all XComs matching this task ID in the same DAG</span>
<span class="sd">        run are removed. If the task is mapped, only the one with matching map</span>
<span class="sd">        index is removed.</span>

<span class="sd">        :param session: SQLAlchemy ORM Session</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Clearing XCom data&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">map_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">map_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_index</span>
        <span class="n">XCom</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span>
            <span class="n">dag_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="p">,</span>
            <span class="n">task_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
            <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
            <span class="n">map_index</span><span class="o">=</span><span class="n">map_index</span><span class="p">,</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="TaskInstance.key"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.key">[docs]</a>    <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskInstanceKey</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a tuple that identifies the task instance uniquely.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TaskInstanceKey</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_number</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_index</span><span class="p">)</span></div>

    <span class="nd">@provide_session</span>
<div class="viewcode-block" id="TaskInstance.set_state"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.set_state">[docs]</a>    <span class="k">def</span> <span class="nf">set_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">NEW_SESSION</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set TaskInstance state.</span>

<span class="sd">        :param state: State to set for the TI</span>
<span class="sd">        :param session: SQLAlchemy ORM Session</span>
<span class="sd">        :return: Was the state changed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">state</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">current_time</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting task state for </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="ow">or</span> <span class="n">current_time</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="n">State</span><span class="o">.</span><span class="n">finished</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">UP_FOR_RETRY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="ow">or</span> <span class="n">current_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="TaskInstance.is_premature"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.is_premature">[docs]</a>    <span class="k">def</span> <span class="nf">is_premature</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns whether a task is in UP_FOR_RETRY state and its retry interval has elapsed.&quot;&quot;&quot;</span>
        <span class="c1"># is the task still in the retry waiting period?</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">UP_FOR_RETRY</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ready_for_retry</span><span class="p">()</span></div>

    <span class="nd">@provide_session</span>
<div class="viewcode-block" id="TaskInstance.are_dependents_done"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.are_dependents_done">[docs]</a>    <span class="k">def</span> <span class="nf">are_dependents_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">NEW_SESSION</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether the immediate dependents of this task instance have succeeded or have been skipped.</span>

<span class="sd">        This is meant to be used by wait_for_downstream.</span>

<span class="sd">        This is useful when you do not want to start processing the next</span>
<span class="sd">        schedule of a task until the dependents are done. For instance,</span>
<span class="sd">        if the task DROPs and recreates a table.</span>

<span class="sd">        :param session: SQLAlchemy ORM Session</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">downstream_task_ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">ti</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">TaskInstance</span><span class="o">.</span><span class="n">task_id</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">TaskInstance</span><span class="o">.</span><span class="n">dag_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="p">,</span>
            <span class="n">TaskInstance</span><span class="o">.</span><span class="n">task_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">downstream_task_ids</span><span class="p">),</span>
            <span class="n">TaskInstance</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
            <span class="n">TaskInstance</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">in_</span><span class="p">((</span><span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">SKIPPED</span><span class="p">,</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">)),</span>
        <span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">ti</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">count</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">downstream_task_ids</span><span class="p">)</span></div>

    <span class="nd">@provide_session</span>
<div class="viewcode-block" id="TaskInstance.get_previous_dagrun"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.get_previous_dagrun">[docs]</a>    <span class="k">def</span> <span class="nf">get_previous_dagrun</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">DagRunState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DagRun</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the DagRun that ran before this task instance&#39;s DagRun.</span>

<span class="sd">        :param state: If passed, it only take into account instances of a specific state.</span>
<span class="sd">        :param session: SQLAlchemy ORM Session.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">dag</span>
        <span class="k">if</span> <span class="n">dag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">dr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dagrun</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
        <span class="n">dr</span><span class="o">.</span><span class="n">dag</span> <span class="o">=</span> <span class="n">dag</span>

        <span class="c1"># We always ignore schedule in dagrun lookup when `state` is given</span>
        <span class="c1"># or the DAG is never scheduled. For legacy reasons, when</span>
        <span class="c1"># `catchup=True`, we use `get_previous_scheduled_dagrun` unless</span>
        <span class="c1"># `ignore_schedule` is `True`.</span>
        <span class="n">ignore_schedule</span> <span class="o">=</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">dag</span><span class="o">.</span><span class="n">timetable</span><span class="o">.</span><span class="n">can_be_scheduled</span>
        <span class="k">if</span> <span class="n">dag</span><span class="o">.</span><span class="n">catchup</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ignore_schedule</span><span class="p">:</span>
            <span class="n">last_dagrun</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">get_previous_scheduled_dagrun</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_dagrun</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">get_previous_dagrun</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">last_dagrun</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">last_dagrun</span>

        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="nd">@provide_session</span>
<div class="viewcode-block" id="TaskInstance.get_previous_ti"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.get_previous_ti">[docs]</a>    <span class="k">def</span> <span class="nf">get_previous_ti</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">DagRunState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">NEW_SESSION</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskInstance</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the task instance for the task that ran before this task instance.</span>

<span class="sd">        :param state: If passed, it only take into account instances of a specific state.</span>
<span class="sd">        :param session: SQLAlchemy ORM Session</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dagrun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_previous_dagrun</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dagrun</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">dagrun</span><span class="o">.</span><span class="n">get_task_instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="TaskInstance.previous_ti"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.previous_ti">[docs]</a>    <span class="k">def</span> <span class="nf">previous_ti</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskInstance</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This attribute is deprecated.</span>

<span class="sd">        Please use :class:`airflow.models.taskinstance.TaskInstance.get_previous_ti`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            This attribute is deprecated.</span>
<span class="sd">            Please use `airflow.models.taskinstance.TaskInstance.get_previous_ti` method.</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="n">RemovedInAirflow3Warning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_previous_ti</span><span class="p">()</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="TaskInstance.previous_ti_success"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.previous_ti_success">[docs]</a>    <span class="k">def</span> <span class="nf">previous_ti_success</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskInstance</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This attribute is deprecated.</span>

<span class="sd">        Please use :class:`airflow.models.taskinstance.TaskInstance.get_previous_ti`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            This attribute is deprecated.</span>
<span class="sd">            Please use `airflow.models.taskinstance.TaskInstance.get_previous_ti` method.</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="n">RemovedInAirflow3Warning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_previous_ti</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">DagRunState</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">)</span></div>

    <span class="nd">@provide_session</span>
<div class="viewcode-block" id="TaskInstance.get_previous_execution_date"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.get_previous_execution_date">[docs]</a>    <span class="k">def</span> <span class="nf">get_previous_execution_date</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">DagRunState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">NEW_SESSION</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pendulum</span><span class="o">.</span><span class="n">DateTime</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the execution date from property previous_ti_success.</span>

<span class="sd">        :param state: If passed, it only take into account instances of a specific state.</span>
<span class="sd">        :param session: SQLAlchemy ORM Session</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;previous_execution_date was called&quot;</span><span class="p">)</span>
        <span class="n">prev_ti</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_previous_ti</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prev_ti</span> <span class="ow">and</span> <span class="n">pendulum</span><span class="o">.</span><span class="n">instance</span><span class="p">(</span><span class="n">prev_ti</span><span class="o">.</span><span class="n">execution_date</span><span class="p">)</span></div>

    <span class="nd">@provide_session</span>
<div class="viewcode-block" id="TaskInstance.get_previous_start_date"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.get_previous_start_date">[docs]</a>    <span class="k">def</span> <span class="nf">get_previous_start_date</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">DagRunState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">NEW_SESSION</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pendulum</span><span class="o">.</span><span class="n">DateTime</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the start date from property previous_ti_success.</span>

<span class="sd">        :param state: If passed, it only take into account instances of a specific state.</span>
<span class="sd">        :param session: SQLAlchemy ORM Session</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;previous_start_date was called&quot;</span><span class="p">)</span>
        <span class="n">prev_ti</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_previous_ti</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
        <span class="c1"># prev_ti may not exist and prev_ti.start_date may be None.</span>
        <span class="k">return</span> <span class="n">prev_ti</span> <span class="ow">and</span> <span class="n">prev_ti</span><span class="o">.</span><span class="n">start_date</span> <span class="ow">and</span> <span class="n">pendulum</span><span class="o">.</span><span class="n">instance</span><span class="p">(</span><span class="n">prev_ti</span><span class="o">.</span><span class="n">start_date</span><span class="p">)</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="TaskInstance.previous_start_date_success"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.previous_start_date_success">[docs]</a>    <span class="k">def</span> <span class="nf">previous_start_date_success</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pendulum</span><span class="o">.</span><span class="n">DateTime</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This attribute is deprecated.</span>

<span class="sd">        Please use :class:`airflow.models.taskinstance.TaskInstance.get_previous_start_date`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            This attribute is deprecated.</span>
<span class="sd">            Please use `airflow.models.taskinstance.TaskInstance.get_previous_start_date` method.</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="n">RemovedInAirflow3Warning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_previous_start_date</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">DagRunState</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">)</span></div>

    <span class="nd">@provide_session</span>
<div class="viewcode-block" id="TaskInstance.are_dependencies_met"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.are_dependencies_met">[docs]</a>    <span class="k">def</span> <span class="nf">are_dependencies_met</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">dep_context</span><span class="p">:</span> <span class="n">DepContext</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">NEW_SESSION</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Are all conditions met for this task instance to be run given the context for the dependencies.</span>

<span class="sd">        (e.g. a task instance being force run from the UI will ignore some dependencies).</span>

<span class="sd">        :param dep_context: The execution context that determines the dependencies that should be evaluated.</span>
<span class="sd">        :param session: database session</span>
<span class="sd">        :param verbose: whether log details on failed dependencies on info or debug log level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dep_context</span> <span class="o">=</span> <span class="n">dep_context</span> <span class="ow">or</span> <span class="n">DepContext</span><span class="p">()</span>
        <span class="n">failed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">verbose_aware_logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span>
        <span class="k">for</span> <span class="n">dep_status</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_failed_dep_statuses</span><span class="p">(</span><span class="n">dep_context</span><span class="o">=</span><span class="n">dep_context</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">):</span>
            <span class="n">failed</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">verbose_aware_logger</span><span class="p">(</span>
                <span class="s2">&quot;Dependencies not met for </span><span class="si">%s</span><span class="s2">, dependency &#39;</span><span class="si">%s</span><span class="s2">&#39; FAILED: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">dep_status</span><span class="o">.</span><span class="n">dep_name</span><span class="p">,</span>
                <span class="n">dep_status</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">failed</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">verbose_aware_logger</span><span class="p">(</span><span class="s2">&quot;Dependencies all met for dep_context=</span><span class="si">%s</span><span class="s2"> ti=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dep_context</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="nd">@provide_session</span>
<div class="viewcode-block" id="TaskInstance.get_failed_dep_statuses"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.get_failed_dep_statuses">[docs]</a>    <span class="k">def</span> <span class="nf">get_failed_dep_statuses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dep_context</span><span class="p">:</span> <span class="n">DepContext</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">NEW_SESSION</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get failed Dependencies.&quot;&quot;&quot;</span>
        <span class="n">dep_context</span> <span class="o">=</span> <span class="n">dep_context</span> <span class="ow">or</span> <span class="n">DepContext</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">dep_context</span><span class="o">.</span><span class="n">deps</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">deps</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dep_status</span> <span class="ow">in</span> <span class="n">dep</span><span class="o">.</span><span class="n">get_dep_statuses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">dep_context</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> dependency &#39;</span><span class="si">%s</span><span class="s2">&#39; PASSED: </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">dep_status</span><span class="o">.</span><span class="n">dep_name</span><span class="p">,</span>
                    <span class="n">dep_status</span><span class="o">.</span><span class="n">passed</span><span class="p">,</span>
                    <span class="n">dep_status</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">dep_status</span><span class="o">.</span><span class="n">passed</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">dep_status</span></div>

<div class="viewcode-block" id="TaskInstance.__repr__"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.__repr__">[docs]</a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;TaskInstance: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">run_id</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;map_index=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">map_index</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="k">return</span> <span class="n">prefix</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="si">}</span><span class="s2">]&gt;&quot;</span></div>

<div class="viewcode-block" id="TaskInstance.next_retry_datetime"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.next_retry_datetime">[docs]</a>    <span class="k">def</span> <span class="nf">next_retry_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get datetime of the next retry if the task instance fails.</span>

<span class="sd">        For exponential backoff, retry_delay is used as base and will be converted to seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">airflow.models.abstractoperator</span> <span class="kn">import</span> <span class="n">MAX_RETRY_DELAY</span>

        <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">retry_delay</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">retry_exponential_backoff</span><span class="p">:</span>
            <span class="c1"># If the min_backoff calculation is below 1, it will be converted to 0 via int. Thus,</span>
            <span class="c1"># we must round up prior to converting to an int, otherwise a divide by zero error</span>
            <span class="c1"># will occur in the modded_hash calculation.</span>
            <span class="n">min_backoff</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">delay</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">try_number</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span>

            <span class="c1"># In the case when delay.total_seconds() is 0, min_backoff will not be rounded up to 1.</span>
            <span class="c1"># To address this, we impose a lower bound of 1 on min_backoff. This effectively makes</span>
            <span class="c1"># the ceiling function unnecessary, but the ceiling function was retained to avoid</span>
            <span class="c1"># introducing a breaking change.</span>
            <span class="k">if</span> <span class="n">min_backoff</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">min_backoff</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="c1"># deterministic per task instance</span>
            <span class="n">ti_hash</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="si">}</span><span class="s2">#</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">#</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">execution_date</span><span class="si">}</span><span class="s2">#</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">try_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
                <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span>
                <span class="mi">16</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># between 1 and 1.0 * delay * (2^retry_number)</span>
            <span class="n">modded_hash</span> <span class="o">=</span> <span class="n">min_backoff</span> <span class="o">+</span> <span class="n">ti_hash</span> <span class="o">%</span> <span class="n">min_backoff</span>
            <span class="c1"># timedelta has a maximum representable value. The exponentiation</span>
            <span class="c1"># here means this value can be exceeded after a certain number</span>
            <span class="c1"># of tries (around 50 if the initial delay is 1s, even fewer if</span>
            <span class="c1"># the delay is larger). Cap the value here before creating a</span>
            <span class="c1"># timedelta object so the operation doesn&#39;t fail with &quot;OverflowError&quot;.</span>
            <span class="n">delay_backoff_in_seconds</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">modded_hash</span><span class="p">,</span> <span class="n">MAX_RETRY_DELAY</span><span class="p">)</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">delay_backoff_in_seconds</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">max_retry_delay</span><span class="p">:</span>
                <span class="n">delay</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">max_retry_delay</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">+</span> <span class="n">delay</span></div>

<div class="viewcode-block" id="TaskInstance.ready_for_retry"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.ready_for_retry">[docs]</a>    <span class="k">def</span> <span class="nf">ready_for_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check on whether the task instance is in the right state and timeframe to be retried.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">UP_FOR_RETRY</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_retry_datetime</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span></div>

    <span class="nd">@provide_session</span>
<div class="viewcode-block" id="TaskInstance.get_dagrun"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.get_dagrun">[docs]</a>    <span class="k">def</span> <span class="nf">get_dagrun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">NEW_SESSION</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DagRun</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the DagRun for this TaskInstance.</span>

<span class="sd">        :param session: SQLAlchemy ORM Session</span>
<span class="sd">        :return: DagRun</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">dag_run</span><span class="o">.</span><span class="n">loaded_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NO_VALUE</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;task&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dag_run</span><span class="o">.</span><span class="n">dag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">dag</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag_run</span>

        <span class="kn">from</span> <span class="nn">airflow.models.dagrun</span> <span class="kn">import</span> <span class="n">DagRun</span>  <span class="c1"># Avoid circular import</span>

        <span class="n">dr</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DagRun</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DagRun</span><span class="o">.</span><span class="n">dag_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="p">,</span> <span class="n">DagRun</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;task&quot;</span><span class="p">):</span>
            <span class="n">dr</span><span class="o">.</span><span class="n">dag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">dag</span>
        <span class="c1"># Record it in the instance for next time. This means that `self.execution_date` will work correctly</span>
        <span class="n">set_committed_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;dag_run&quot;</span><span class="p">,</span> <span class="n">dr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dr</span></div>

    <span class="nd">@provide_session</span>
<div class="viewcode-block" id="TaskInstance.check_and_change_state_before_execution"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.check_and_change_state_before_execution">[docs]</a>    <span class="k">def</span> <span class="nf">check_and_change_state_before_execution</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">ignore_all_deps</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ignore_depends_on_past</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">wait_for_past_depends_before_skipping</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ignore_task_deps</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ignore_ti_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">mark_success</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">test_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pool</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">external_executor_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">NEW_SESSION</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check dependencies and then sets state to RUNNING if they are met.</span>

<span class="sd">        Returns True if and only if state is set to RUNNING, which implies that task should be</span>
<span class="sd">        executed, in preparation for _run_raw_task.</span>

<span class="sd">        :param verbose: whether to turn on more verbose logging</span>
<span class="sd">        :param ignore_all_deps: Ignore all of the non-critical dependencies, just runs</span>
<span class="sd">        :param ignore_depends_on_past: Ignore depends_on_past DAG attribute</span>
<span class="sd">        :param wait_for_past_depends_before_skipping: Wait for past depends before mark the ti as skipped</span>
<span class="sd">        :param ignore_task_deps: Don&#39;t check the dependencies of this TaskInstance&#39;s task</span>
<span class="sd">        :param ignore_ti_state: Disregards previous task instance state</span>
<span class="sd">        :param mark_success: Don&#39;t run the task, mark its state as success</span>
<span class="sd">        :param test_mode: Doesn&#39;t record success or failure in the DB</span>
<span class="sd">        :param job_id: Job (BackfillJob / LocalTaskJob / SchedulerJob) ID</span>
<span class="sd">        :param pool: specifies the pool to use to run the task instance</span>
<span class="sd">        :param external_executor_id: The identifier of the celery executor</span>
<span class="sd">        :param session: SQLAlchemy ORM Session</span>
<span class="sd">        :return: whether the state was changed to running or not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_from_task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">pool_override</span><span class="o">=</span><span class="n">pool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_mode</span> <span class="o">=</span> <span class="n">test_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">lock_for_update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">get_hostname</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_all_deps</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ignore_ti_state</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">:</span>
            <span class="n">Stats</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s2">&quot;previously_succeeded&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_tags</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">mark_success</span><span class="p">:</span>
            <span class="c1"># Firstly find non-runnable and non-requeueable tis.</span>
            <span class="c1"># Since mark_success is not set, we do nothing.</span>
            <span class="n">non_requeueable_dep_context</span> <span class="o">=</span> <span class="n">DepContext</span><span class="p">(</span>
                <span class="n">deps</span><span class="o">=</span><span class="n">RUNNING_DEPS</span> <span class="o">-</span> <span class="n">REQUEUEABLE_DEPS</span><span class="p">,</span>
                <span class="n">ignore_all_deps</span><span class="o">=</span><span class="n">ignore_all_deps</span><span class="p">,</span>
                <span class="n">ignore_ti_state</span><span class="o">=</span><span class="n">ignore_ti_state</span><span class="p">,</span>
                <span class="n">ignore_depends_on_past</span><span class="o">=</span><span class="n">ignore_depends_on_past</span><span class="p">,</span>
                <span class="n">wait_for_past_depends_before_skipping</span><span class="o">=</span><span class="n">wait_for_past_depends_before_skipping</span><span class="p">,</span>
                <span class="n">ignore_task_deps</span><span class="o">=</span><span class="n">ignore_task_deps</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;non-requeueable deps&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">are_dependencies_met</span><span class="p">(</span>
                <span class="n">dep_context</span><span class="o">=</span><span class="n">non_requeueable_dep_context</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">):</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># For reporting purposes, we report based on 1-indexed,</span>
            <span class="c1"># not 0-indexed lists (i.e. Attempt 1 instead of</span>
            <span class="c1"># Attempt 0 for the first attempt).</span>
            <span class="c1"># Set the task start date. In case it was re-scheduled use the initial</span>
            <span class="c1"># start date that is recorded in task_reschedule table</span>
            <span class="c1"># If the task continues after being deferred (next_method is set), use the original start_date</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_method</span> <span class="k">else</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">UP_FOR_RESCHEDULE</span><span class="p">:</span>
                <span class="n">task_reschedule</span><span class="p">:</span> <span class="n">TR</span> <span class="o">=</span> <span class="n">TR</span><span class="o">.</span><span class="n">query_for_task_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">task_reschedule</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="n">task_reschedule</span><span class="o">.</span><span class="n">start_date</span>

            <span class="c1"># Secondly we find non-runnable but requeueable tis. We reset its state.</span>
            <span class="c1"># This is because we might have hit concurrency limits,</span>
            <span class="c1"># e.g. because of backfilling.</span>
            <span class="n">dep_context</span> <span class="o">=</span> <span class="n">DepContext</span><span class="p">(</span>
                <span class="n">deps</span><span class="o">=</span><span class="n">REQUEUEABLE_DEPS</span><span class="p">,</span>
                <span class="n">ignore_all_deps</span><span class="o">=</span><span class="n">ignore_all_deps</span><span class="p">,</span>
                <span class="n">ignore_depends_on_past</span><span class="o">=</span><span class="n">ignore_depends_on_past</span><span class="p">,</span>
                <span class="n">wait_for_past_depends_before_skipping</span><span class="o">=</span><span class="n">wait_for_past_depends_before_skipping</span><span class="p">,</span>
                <span class="n">ignore_task_deps</span><span class="o">=</span><span class="n">ignore_task_deps</span><span class="p">,</span>
                <span class="n">ignore_ti_state</span><span class="o">=</span><span class="n">ignore_ti_state</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;requeueable deps&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">are_dependencies_met</span><span class="p">(</span><span class="n">dep_context</span><span class="o">=</span><span class="n">dep_context</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Rescheduling due to concurrency limits reached &quot;</span>
                    <span class="s2">&quot;at task runtime. Attempt </span><span class="si">%s</span><span class="s2"> of &quot;</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">. State set to NONE.&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">try_number</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">max_tries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">queued_dttm</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
                <span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Resuming after deferral&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting attempt </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_number</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_tries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_try_number</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_mode</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Log</span><span class="p">(</span><span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">RUNNING</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">RUNNING</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit_state_change_metric</span><span class="p">(</span><span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_executor_id</span> <span class="o">=</span> <span class="n">external_executor_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_mode</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># Closing all pooled connections to prevent</span>
        <span class="c1"># &quot;max number of connections reached&quot;</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mark_success</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Marking success for </span><span class="si">%s</span><span class="s2"> on </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_date</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing </span><span class="si">%s</span><span class="s2"> on </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_date</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">_date_or_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">result</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">T%H%M%S&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_log_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lead_msg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">lead_msg</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">Marking task as </span><span class="si">%s</span><span class="s2">. dag_id=</span><span class="si">%s</span><span class="s2">, task_id=</span><span class="si">%s</span><span class="s2">, &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map_index</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;map_index=</span><span class="si">%d</span><span class="s2">, &quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">message</span> <span class="o">+</span> <span class="s2">&quot;execution_date=</span><span class="si">%s</span><span class="s2">, start_date=</span><span class="si">%s</span><span class="s2">, end_date=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="o">*</span><span class="n">params</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_date_or_empty</span><span class="p">(</span><span class="s2">&quot;execution_date&quot;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_date_or_empty</span><span class="p">(</span><span class="s2">&quot;start_date&quot;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_date_or_empty</span><span class="p">(</span><span class="s2">&quot;end_date&quot;</span><span class="p">),</span>
        <span class="p">)</span>

<div class="viewcode-block" id="TaskInstance.emit_state_change_metric"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.emit_state_change_metric">[docs]</a>    <span class="k">def</span> <span class="nf">emit_state_change_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_state</span><span class="p">:</span> <span class="n">TaskInstanceState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a time metric representing how much time a given state transition took.</span>

<span class="sd">        The previous state and metric name is deduced from the state the task was put in.</span>

<span class="sd">        :param new_state: The state that has just been set for this task.</span>
<span class="sd">            We do not use `self.state`, because sometimes the state is updated directly in the DB and not in</span>
<span class="sd">            the local TaskInstance object.</span>
<span class="sd">            Supported states: QUEUED and RUNNING</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">:</span>
            <span class="c1"># if the task has an end date, it means that this is not its first round.</span>
            <span class="c1"># we send the state transition time metric only on the first try, otherwise it gets more complex.</span>
            <span class="k">return</span>

        <span class="c1"># switch on state and deduce which metric to send</span>
        <span class="k">if</span> <span class="n">new_state</span> <span class="o">==</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">:</span>
            <span class="n">metric_name</span> <span class="o">=</span> <span class="s2">&quot;queued_duration&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">queued_dttm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># this should not really happen except in tests or rare cases,</span>
                <span class="c1"># but we don&#39;t want to create errors just for a metric, so we just skip it</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;cannot record </span><span class="si">%s</span><span class="s2"> for task </span><span class="si">%s</span><span class="s2"> because previous state change time has not been saved&quot;</span><span class="p">,</span>
                    <span class="n">metric_name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="n">timing</span> <span class="o">=</span> <span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">queued_dttm</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">new_state</span> <span class="o">==</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">QUEUED</span><span class="p">:</span>
            <span class="n">metric_name</span> <span class="o">=</span> <span class="s2">&quot;scheduled_duration&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># same comment as above</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;cannot record </span><span class="si">%s</span><span class="s2"> for task </span><span class="si">%s</span><span class="s2"> because previous state change time has not been saved&quot;</span><span class="p">,</span>
                    <span class="n">metric_name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="n">timing</span> <span class="o">=</span> <span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;no metric emission setup for state </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">new_state</span><span class="p">)</span>

        <span class="c1"># send metric twice, once (legacy) with tags in the name and once with tags as tags</span>
        <span class="n">Stats</span><span class="o">.</span><span class="n">timing</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dag.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">timing</span><span class="p">)</span>
        <span class="n">Stats</span><span class="o">.</span><span class="n">timing</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;task.</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">timing</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;task_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="s2">&quot;dag_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="p">})</span></div>

    <span class="c1"># Ensure we unset next_method and next_kwargs to ensure that any</span>
    <span class="c1"># retries don&#39;t re-use them.</span>
<div class="viewcode-block" id="TaskInstance.clear_next_method_args"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.clear_next_method_args">[docs]</a>    <span class="k">def</span> <span class="nf">clear_next_method_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Clearing next_method and next_kwargs.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">next_method</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_kwargs</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="nd">@provide_session</span>
    <span class="nd">@Sentry</span><span class="o">.</span><span class="n">enrich_errors</span>
    <span class="k">def</span> <span class="nf">_run_raw_task</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mark_success</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">test_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pool</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">NEW_SESSION</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskReturnCode</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a task, update the state upon completion, and run any appropriate callbacks.</span>

<span class="sd">        Immediately runs the task (without checking or changing db state</span>
<span class="sd">        before execution) and then sets the appropriate final state after</span>
<span class="sd">        completion and runs any post-execute callbacks. Meant to be called</span>
<span class="sd">        only after another function changes the state to running.</span>

<span class="sd">        :param mark_success: Don&#39;t run the task, mark its state as success</span>
<span class="sd">        :param test_mode: Doesn&#39;t record success or failure in the DB</span>
<span class="sd">        :param pool: specifies the pool to use to run the task instance</span>
<span class="sd">        :param session: SQLAlchemy ORM Session</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_mode</span> <span class="o">=</span> <span class="n">test_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_from_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="n">pool_override</span><span class="o">=</span><span class="n">pool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">get_hostname</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_mode</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">actual_start_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">Stats</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ti.start.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">dag_id</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_tags</span><span class="p">)</span>
        <span class="c1"># Same metric with tagging</span>
        <span class="n">Stats</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s2">&quot;ti.start&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_tags</span><span class="p">)</span>
        <span class="c1"># Initialize final state counters at zero</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">State</span><span class="o">.</span><span class="n">task_states</span><span class="p">:</span>
            <span class="n">Stats</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ti.finish.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">dag_id</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_tags</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Same metric with tagging</span>
            <span class="n">Stats</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span>
                <span class="s2">&quot;ti.finish&quot;</span><span class="p">,</span>
                <span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">tags</span><span class="o">=</span><span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_tags</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">)},</span>
            <span class="p">)</span>
        <span class="k">with</span> <span class="n">set_current_task_instance_session</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">prepare_for_execution</span><span class="p">()</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_template_context</span><span class="p">(</span><span class="n">ignore_param_exceptions</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">mark_success</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_execute_task_with_callbacks</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">test_mode</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">test_mode</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">(</span><span class="n">lock_for_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">SUCCESS</span>
            <span class="k">except</span> <span class="n">TaskDeferred</span> <span class="k">as</span> <span class="n">defer</span><span class="p">:</span>
                <span class="c1"># The task has signalled it wants to defer execution based on</span>
                <span class="c1"># a trigger.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_defer_task</span><span class="p">(</span><span class="n">defer</span><span class="o">=</span><span class="n">defer</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Pausing task as DEFERRED. dag_id=</span><span class="si">%s</span><span class="s2">, task_id=</span><span class="si">%s</span><span class="s2">, execution_date=</span><span class="si">%s</span><span class="s2">, start_date=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_date_or_empty</span><span class="p">(</span><span class="s2">&quot;execution_date&quot;</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_date_or_empty</span><span class="p">(</span><span class="s2">&quot;start_date&quot;</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">test_mode</span><span class="p">:</span>
                    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
                    <span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">TaskReturnCode</span><span class="o">.</span><span class="n">DEFERRED</span>
            <span class="k">except</span> <span class="n">AirflowSkipException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Recording SKIP</span>
                <span class="c1"># log only if exception has any arguments to prevent log flooding</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">test_mode</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">(</span><span class="n">lock_for_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">SKIPPED</span>
            <span class="k">except</span> <span class="n">AirflowRescheduleException</span> <span class="k">as</span> <span class="n">reschedule_exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle_reschedule</span><span class="p">(</span><span class="n">actual_start_date</span><span class="p">,</span> <span class="n">reschedule_exception</span><span class="p">,</span> <span class="n">test_mode</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">AirflowFailException</span><span class="p">,</span> <span class="n">AirflowSensorTimeout</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># If AirflowFailException is raised, task should not retry.</span>
                <span class="c1"># If a sensor in reschedule mode reaches timeout, task should not retry.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_failure</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">test_mode</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">force_fail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="n">AirflowException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">test_mode</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">(</span><span class="n">lock_for_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
                <span class="c1"># for case when task is marked as success/failed externally</span>
                <span class="c1"># or dagrun timed out and task is marked as skipped</span>
                <span class="c1"># current behavior doesn&#39;t hit the callbacks</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="n">State</span><span class="o">.</span><span class="n">finished</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">clear_next_method_args</span><span class="p">()</span>
                    <span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">handle_failure</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">test_mode</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
                    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="k">raise</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="ne">KeyboardInterrupt</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_failure</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">test_mode</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">Stats</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ti.finish.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_tags</span><span class="p">)</span>
                <span class="c1"># Same metric with tagging</span>
                <span class="n">Stats</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s2">&quot;ti.finish&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_tags</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)})</span>

            <span class="c1"># Recording SKIPPED or SUCCESS</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_next_method_args</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_state</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_duration</span><span class="p">()</span>

            <span class="c1"># run on_success_callback before db committing</span>
            <span class="c1"># otherwise, the LocalTaskJob sees the state is changed to `success`,</span>
            <span class="c1"># but the task_runner is still running, LocalTaskJob then treats the state is set externally!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_finished_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">on_success_callback</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="s2">&quot;on_success&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">test_mode</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_register_dataset_changes</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>

                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">:</span>
                    <span class="n">get_listener_manager</span><span class="p">()</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">on_task_instance_success</span><span class="p">(</span>
                        <span class="n">previous_state</span><span class="o">=</span><span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">,</span> <span class="n">task_instance</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span>
                    <span class="p">)</span>

            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_register_dataset_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">outlets</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;outlet obj </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="c1"># Lineage can have other types of objects besides datasets</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">):</span>
                <span class="n">dataset_manager</span><span class="o">.</span><span class="n">register_dataset_change</span><span class="p">(</span>
                    <span class="n">task_instance</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">dataset</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span>
                    <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_task_with_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">test_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare Task for Execution.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">airflow.models.renderedtifields</span> <span class="kn">import</span> <span class="n">RenderedTaskInstanceFields</span>

        <span class="n">parent_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">signal_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>

            <span class="c1"># If a task forks during execution (from DAG code) for whatever</span>
            <span class="c1"># reason, we want to make sure that we react to the signal only in</span>
            <span class="c1"># the process that we&#39;ve spawned ourselves (referred to here as the</span>
            <span class="c1"># parent process).</span>
            <span class="k">if</span> <span class="n">pid</span> <span class="o">!=</span> <span class="n">parent_pid</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Received SIGTERM. Terminating subprocesses.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">on_kill</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">AirflowException</span><span class="p">(</span><span class="s2">&quot;Task received SIGTERM signal&quot;</span><span class="p">)</span>

        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>

        <span class="c1"># Don&#39;t clear Xcom until the task is certain to execute, and check if we are resuming from deferral.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_method</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_xcom_data</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">Stats</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dag.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">dag_id</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">.duration&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_tags</span><span class="p">):</span>
            <span class="c1"># Set the validated/merged params on the task object.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span>

            <span class="k">with</span> <span class="n">set_current_context</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
                <span class="n">task_orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_templates</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">test_mode</span><span class="p">:</span>
                <span class="n">rtif</span> <span class="o">=</span> <span class="n">RenderedTaskInstanceFields</span><span class="p">(</span><span class="n">ti</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">render_templates</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">RenderedTaskInstanceFields</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rtif</span><span class="p">)</span>
                <span class="n">RenderedTaskInstanceFields</span><span class="o">.</span><span class="n">delete_old_records</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="p">)</span>

            <span class="c1"># Export context to make it available for operators to use.</span>
            <span class="n">airflow_context_vars</span> <span class="o">=</span> <span class="n">context_to_airflow_vars</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">in_env_var_format</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">airflow_context_vars</span><span class="p">)</span>

            <span class="c1"># Log context only for the default execution method, the assumption</span>
            <span class="c1"># being that otherwise we&#39;re resuming a deferred task (in which</span>
            <span class="c1"># case there&#39;s no need to log these again).</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_method</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Exporting env vars: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">!r}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">airflow_context_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
                <span class="p">)</span>

            <span class="c1"># Run pre_execute callback</span>
            <span class="c1"># Is never MappedOperator at this point</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">pre_execute</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>  <span class="c1"># type: ignore[union-attr]</span>

            <span class="c1"># Run on_execute callback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_execute_callback</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>

            <span class="c1"># Run on_task_instance_running event</span>
            <span class="n">get_listener_manager</span><span class="p">()</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">on_task_instance_running</span><span class="p">(</span>
                <span class="n">previous_state</span><span class="o">=</span><span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">QUEUED</span><span class="p">,</span> <span class="n">task_instance</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span>
            <span class="p">)</span>

            <span class="c1"># Execute the task</span>
            <span class="k">with</span> <span class="n">set_current_context</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_task</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">task_orig</span><span class="p">)</span>
            <span class="c1"># Run post_execute callback</span>
            <span class="c1"># Is never MappedOperator at this point</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">post_execute</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>  <span class="c1"># type: ignore[union-attr]</span>

        <span class="n">Stats</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;operator_successes_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">task_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_tags</span><span class="p">)</span>
        <span class="c1"># Same metric with tagging</span>
        <span class="n">Stats</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s2">&quot;operator_successes&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_tags</span><span class="p">,</span> <span class="s2">&quot;task_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">task_type</span><span class="p">})</span>
        <span class="n">Stats</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s2">&quot;ti_successes&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_tags</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run_finished_callback</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">callbacks</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">TaskStateChangeCallback</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">TaskStateChangeCallback</span><span class="p">],</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span>
        <span class="n">callback_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run callback after task finishes.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">callbacks</span><span class="p">:</span>
            <span class="n">callbacks</span> <span class="o">=</span> <span class="n">callbacks</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">callbacks</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">callbacks</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">callbacks</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">callback</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">callback_name</span> <span class="o">=</span> <span class="n">qualname</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Error when executing </span><span class="si">{</span><span class="n">callback_name</span><span class="si">}</span><span class="s2"> callback&quot;</span>  <span class="c1"># type: ignore[attr-defined]</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">task_orig</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute Task (optionally with a Timeout) and push Xcom results.&quot;&quot;&quot;</span>
        <span class="n">task_to_execute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span>
        <span class="c1"># If the task has been deferred and is being executed due to a trigger,</span>
        <span class="c1"># then we need to pick the right method to come back to, otherwise</span>
        <span class="c1"># we go for the default execute</span>
        <span class="n">execute_callable_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_method</span><span class="p">:</span>
            <span class="n">execute_callable</span> <span class="o">=</span> <span class="n">task_to_execute</span><span class="o">.</span><span class="n">resume_execution</span>
            <span class="n">execute_callable_kwargs</span><span class="p">[</span><span class="s2">&quot;next_method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_method</span>
            <span class="n">execute_callable_kwargs</span><span class="p">[</span><span class="s2">&quot;next_kwargs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_kwargs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">execute_callable</span> <span class="o">=</span> <span class="n">task_to_execute</span><span class="o">.</span><span class="n">execute</span>
        <span class="c1"># If a timeout is specified for the task, make it fail</span>
        <span class="c1"># if it goes beyond</span>
        <span class="k">if</span> <span class="n">task_to_execute</span><span class="o">.</span><span class="n">execution_timeout</span><span class="p">:</span>
            <span class="c1"># If we are coming in with a next_method (i.e. from a deferral),</span>
            <span class="c1"># calculate the timeout from our start_date.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_method</span><span class="p">:</span>
                <span class="n">timeout_seconds</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">task_to_execute</span><span class="o">.</span><span class="n">execution_timeout</span> <span class="o">-</span> <span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">timeout_seconds</span> <span class="o">=</span> <span class="n">task_to_execute</span><span class="o">.</span><span class="n">execution_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># It&#39;s possible we&#39;re already timed out, so fast-fail if true</span>
                <span class="k">if</span> <span class="n">timeout_seconds</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">AirflowTaskTimeout</span><span class="p">()</span>
                <span class="c1"># Run task in timeout wrapper</span>
                <span class="k">with</span> <span class="n">timeout</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">execute_callable</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">execute_callable_kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">AirflowTaskTimeout</span><span class="p">:</span>
                <span class="n">task_to_execute</span><span class="o">.</span><span class="n">on_kill</span><span class="p">()</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">execute_callable</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">execute_callable_kwargs</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">create_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">task_to_execute</span><span class="o">.</span><span class="n">do_xcom_push</span><span class="p">:</span>
                <span class="n">xcom_value</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xcom_value</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">xcom_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># If the task returns a result, push an XCom containing it.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xcom_push</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">XCOM_RETURN_KEY</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">xcom_value</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_record_task_map_for_downstreams</span><span class="p">(</span><span class="n">task_orig</span><span class="p">,</span> <span class="n">xcom_value</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@provide_session</span>
    <span class="k">def</span> <span class="nf">_defer_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">defer</span><span class="p">:</span> <span class="n">TaskDeferred</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mark the task as deferred and sets up the trigger that is needed to resume it.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">airflow.models.trigger</span> <span class="kn">import</span> <span class="n">Trigger</span>

        <span class="c1"># First, make the trigger entry</span>
        <span class="n">trigger_row</span> <span class="o">=</span> <span class="n">Trigger</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">defer</span><span class="o">.</span><span class="n">trigger</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">trigger_row</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># Then, update ourselves so it matches the deferral request</span>
        <span class="c1"># Keep an eye on the logic in `check_and_change_state_before_execution()`</span>
        <span class="c1"># depending on self.next_method semantics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">DEFERRED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger_id</span> <span class="o">=</span> <span class="n">trigger_row</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_method</span> <span class="o">=</span> <span class="n">defer</span><span class="o">.</span><span class="n">method_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_kwargs</span> <span class="o">=</span> <span class="n">defer</span><span class="o">.</span><span class="n">kwargs</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="c1"># Decrement try number so the next one is the same try</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_try_number</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1"># Calculate timeout too if it was passed</span>
        <span class="k">if</span> <span class="n">defer</span><span class="o">.</span><span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger_timeout</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">defer</span><span class="o">.</span><span class="n">timeout</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger_timeout</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># If an execution_timeout is set, set the timeout to the minimum of</span>
        <span class="c1"># it and the trigger timeout</span>
        <span class="n">execution_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">execution_timeout</span>
        <span class="k">if</span> <span class="n">execution_timeout</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger_timeout</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trigger_timeout</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">+</span> <span class="n">execution_timeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger_timeout</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trigger_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">+</span> <span class="n">execution_timeout</span>

    <span class="k">def</span> <span class="nf">_run_execute_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Operator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Functions that need to be run before a Task is executed.&quot;&quot;&quot;</span>
        <span class="n">callbacks</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">on_execute_callback</span>
        <span class="k">if</span> <span class="n">callbacks</span><span class="p">:</span>
            <span class="n">callbacks</span> <span class="o">=</span> <span class="n">callbacks</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">callbacks</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">callbacks</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">callbacks</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">callback</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed when executing execute callback&quot;</span><span class="p">)</span>

    <span class="nd">@provide_session</span>
<div class="viewcode-block" id="TaskInstance.run"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">ignore_all_deps</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ignore_depends_on_past</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">wait_for_past_depends_before_skipping</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ignore_task_deps</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ignore_ti_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">mark_success</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">test_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pool</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">NEW_SESSION</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run TaskInstance.&quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_and_change_state_before_execution</span><span class="p">(</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">ignore_all_deps</span><span class="o">=</span><span class="n">ignore_all_deps</span><span class="p">,</span>
            <span class="n">ignore_depends_on_past</span><span class="o">=</span><span class="n">ignore_depends_on_past</span><span class="p">,</span>
            <span class="n">wait_for_past_depends_before_skipping</span><span class="o">=</span><span class="n">wait_for_past_depends_before_skipping</span><span class="p">,</span>
            <span class="n">ignore_task_deps</span><span class="o">=</span><span class="n">ignore_task_deps</span><span class="p">,</span>
            <span class="n">ignore_ti_state</span><span class="o">=</span><span class="n">ignore_ti_state</span><span class="p">,</span>
            <span class="n">mark_success</span><span class="o">=</span><span class="n">mark_success</span><span class="p">,</span>
            <span class="n">test_mode</span><span class="o">=</span><span class="n">test_mode</span><span class="p">,</span>
            <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
            <span class="n">pool</span><span class="o">=</span><span class="n">pool</span><span class="p">,</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_run_raw_task</span><span class="p">(</span>
            <span class="n">mark_success</span><span class="o">=</span><span class="n">mark_success</span><span class="p">,</span> <span class="n">test_mode</span><span class="o">=</span><span class="n">test_mode</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span> <span class="n">pool</span><span class="o">=</span><span class="n">pool</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TaskInstance.dry_run"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.dry_run">[docs]</a>    <span class="k">def</span> <span class="nf">dry_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Only Renders Templates for the TI.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">airflow.models.baseoperator</span> <span class="kn">import</span> <span class="n">BaseOperator</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">prepare_for_execution</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render_templates</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="n">BaseOperator</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">dry_run</span><span class="p">()</span></div>

    <span class="nd">@provide_session</span>
    <span class="k">def</span> <span class="nf">_handle_reschedule</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">actual_start_date</span><span class="p">,</span> <span class="n">reschedule_exception</span><span class="p">,</span> <span class="n">test_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">NEW_SESSION</span>
    <span class="p">):</span>
        <span class="c1"># Don&#39;t record reschedule request in test mode</span>
        <span class="k">if</span> <span class="n">test_mode</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="kn">from</span> <span class="nn">airflow.models.dagrun</span> <span class="kn">import</span> <span class="n">DagRun</span>  <span class="c1"># Avoid circular import</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_duration</span><span class="p">()</span>

        <span class="c1"># Lock DAG run to be sure not to get into a deadlock situation when trying to insert</span>
        <span class="c1"># TaskReschedule which apparently also creates lock on corresponding DagRun entity</span>
        <span class="n">with_row_locks</span><span class="p">(</span>
            <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DagRun</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
                <span class="n">dag_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="p">,</span>
                <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>

        <span class="c1"># Log reschedule request</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">TaskReschedule</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_try_number</span><span class="p">,</span>
                <span class="n">actual_start_date</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">,</span>
                <span class="n">reschedule_exception</span><span class="o">.</span><span class="n">reschedule_date</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">map_index</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># set state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">UP_FOR_RESCHEDULE</span>

        <span class="c1"># Decrement try_number so subsequent runs will use the same try number and write</span>
        <span class="c1"># to same log file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_try_number</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clear_next_method_args</span><span class="p">()</span>

        <span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rescheduling task, marking task as UP_FOR_RESCHEDULE&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_truncated_error_traceback</span><span class="p">(</span><span class="n">error</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">,</span> <span class="n">truncate_to</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TracebackType</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Truncate the traceback of an exception to the first frame called from within a given function.</span>

<span class="sd">        :param error: exception to get traceback from</span>
<span class="sd">        :param truncate_to: Function to truncate TB to. Must have a ``__code__`` attribute</span>

<span class="sd">        :meta private:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">__traceback__</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">truncate_to</span><span class="o">.</span><span class="vm">__func__</span><span class="o">.</span><span class="vm">__code__</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="k">while</span> <span class="n">tb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tb</span><span class="o">.</span><span class="n">tb_frame</span><span class="o">.</span><span class="n">f_code</span> <span class="ow">is</span> <span class="n">code</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">tb</span><span class="o">.</span><span class="n">tb_next</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">tb_next</span>
        <span class="k">return</span> <span class="n">tb</span> <span class="ow">or</span> <span class="n">error</span><span class="o">.</span><span class="n">__traceback__</span>

    <span class="nd">@provide_session</span>
<div class="viewcode-block" id="TaskInstance.handle_failure"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.handle_failure">[docs]</a>    <span class="k">def</span> <span class="nf">handle_failure</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">error</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="ne">Exception</span> <span class="o">|</span> <span class="ne">KeyboardInterrupt</span><span class="p">,</span>
        <span class="n">test_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">Context</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">force_fail</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">NEW_SESSION</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle Failure for the TaskInstance.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">test_mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">test_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_mode</span>

        <span class="n">get_listener_manager</span><span class="p">()</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">on_task_instance_failed</span><span class="p">(</span>
            <span class="n">previous_state</span><span class="o">=</span><span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">,</span> <span class="n">task_instance</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">):</span>
                <span class="n">tb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_truncated_error_traceback</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">truncate_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_execute_task</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Task failed with exception&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="n">error</span><span class="p">,</span> <span class="n">tb</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_mode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_duration</span><span class="p">()</span>

        <span class="n">Stats</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;operator_failures_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_tags</span><span class="p">)</span>
        <span class="c1"># Same metric with tagging</span>
        <span class="n">Stats</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s2">&quot;operator_failures&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_tags</span><span class="p">,</span> <span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="p">})</span>
        <span class="n">Stats</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s2">&quot;ti_failures&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_tags</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_mode</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Log</span><span class="p">(</span><span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>

            <span class="c1"># Log failure duration</span>
            <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">TaskFail</span><span class="p">(</span><span class="n">ti</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clear_next_method_args</span><span class="p">()</span>

        <span class="c1"># In extreme cases (zombie in case of dag with parse error) we might _not_ have a Task.</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;task&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_template_context</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;exception&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error</span>

        <span class="c1"># Set state correctly and figure out how to log it and decide whether</span>
        <span class="c1"># to email</span>

        <span class="c1"># Note, callback invocation needs to be handled by caller of</span>
        <span class="c1"># _run_raw_task to avoid race conditions which could lead to duplicate</span>
        <span class="c1"># invocations or miss invocation.</span>

        <span class="c1"># Since this function is called only when the TaskInstance state is running,</span>
        <span class="c1"># try_number contains the current try_number (not the next). We</span>
        <span class="c1"># only mark task instance as FAILED if the next task instance</span>
        <span class="c1"># try_number exceeds the max_tries ... or if force_fail is truthy</span>

        <span class="n">task</span><span class="p">:</span> <span class="n">BaseOperator</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;task&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">context</span><span class="p">:</span>
                <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">unmap</span><span class="p">((</span><span class="n">context</span><span class="p">,</span> <span class="n">session</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unable to unmap task to determine if we need to send an alert email&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">force_fail</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_eligible_to_retry</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">FAILED</span>
            <span class="n">email_for_state</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;email_on_failure&quot;</span><span class="p">)</span>
            <span class="n">callbacks</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">on_failure_callback</span> <span class="k">if</span> <span class="n">task</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">callback_type</span> <span class="o">=</span> <span class="s2">&quot;on_failure&quot;</span>

            <span class="k">if</span> <span class="n">task</span> <span class="ow">and</span> <span class="n">task</span><span class="o">.</span><span class="n">dag</span> <span class="ow">and</span> <span class="n">task</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">fail_stop</span><span class="p">:</span>
                <span class="n">_stop_remaining_tasks</span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">QUEUED</span><span class="p">:</span>
                <span class="c1"># We increase the try_number so as to fail the task if it fails to start after sometime</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_try_number</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">UP_FOR_RETRY</span>
            <span class="n">email_for_state</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;email_on_retry&quot;</span><span class="p">)</span>
            <span class="n">callbacks</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">on_retry_callback</span> <span class="k">if</span> <span class="n">task</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">callback_type</span> <span class="o">=</span> <span class="s2">&quot;on_retry&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log_state</span><span class="p">(</span><span class="s2">&quot;Immediate failure requested. &quot;</span> <span class="k">if</span> <span class="n">force_fail</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">task</span> <span class="ow">and</span> <span class="n">email_for_state</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="ow">and</span> <span class="n">task</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">email_alert</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to send email to: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">callbacks</span> <span class="ow">and</span> <span class="n">context</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_finished_callback</span><span class="p">(</span><span class="n">callbacks</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">callback_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_mode</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="TaskInstance.is_eligible_to_retry"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.is_eligible_to_retry">[docs]</a>    <span class="k">def</span> <span class="nf">is_eligible_to_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Is task instance is eligible for retry.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">RESTARTING</span><span class="p">:</span>
            <span class="c1"># If a task is cleared when running, it goes into RESTARTING state and is always</span>
            <span class="c1"># eligible for retry</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;task&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># Couldn&#39;t load the task, don&#39;t know number of retries, guess:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_number</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_tries</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">retries</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_number</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_tries</span></div>

<div class="viewcode-block" id="TaskInstance.get_template_context"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.get_template_context">[docs]</a>    <span class="k">def</span> <span class="nf">get_template_context</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ignore_param_exceptions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Context</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return TI Context.&quot;&quot;&quot;</span>
        <span class="c1"># Do not use provide_session here -- it expunges everything on exit!</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>

        <span class="kn">from</span> <span class="nn">airflow</span> <span class="kn">import</span> <span class="n">macros</span>
        <span class="kn">from</span> <span class="nn">airflow.models.abstractoperator</span> <span class="kn">import</span> <span class="n">NotMapped</span>

        <span class="n">integrate_macros_plugins</span><span class="p">()</span>

        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span>
        <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">task</span><span class="o">.</span><span class="n">dag</span>
        <span class="n">dag</span><span class="p">:</span> <span class="n">DAG</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">dag</span>

        <span class="n">dag_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dagrun</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="n">data_interval</span> <span class="o">=</span> <span class="n">dag</span><span class="o">.</span><span class="n">get_run_data_interval</span><span class="p">(</span><span class="n">dag_run</span><span class="p">)</span>

        <span class="n">validated_params</span> <span class="o">=</span> <span class="n">process_params</span><span class="p">(</span><span class="n">dag</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">dag_run</span><span class="p">,</span> <span class="n">suppress_exception</span><span class="o">=</span><span class="n">ignore_param_exceptions</span><span class="p">)</span>

        <span class="n">logical_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">coerce_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execution_date</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">logical_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ds_nodash</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">logical_date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="n">ts_nodash</span> <span class="o">=</span> <span class="n">logical_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">T%H%M%S&quot;</span><span class="p">)</span>
        <span class="n">ts_nodash_with_tz</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="nd">@cache</span>  <span class="c1"># Prevent multiple database access.</span>
        <span class="k">def</span> <span class="nf">_get_previous_dagrun_success</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">DagRun</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_previous_dagrun</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">DagRunState</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_get_previous_dagrun_data_interval_success</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">DataInterval</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dagrun</span> <span class="o">=</span> <span class="n">_get_previous_dagrun_success</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dagrun</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">dag</span><span class="o">.</span><span class="n">get_run_data_interval</span><span class="p">(</span><span class="n">dagrun</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_prev_data_interval_start_success</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">pendulum</span><span class="o">.</span><span class="n">DateTime</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_interval</span> <span class="o">=</span> <span class="n">_get_previous_dagrun_data_interval_success</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">data_interval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">data_interval</span><span class="o">.</span><span class="n">start</span>

        <span class="k">def</span> <span class="nf">get_prev_data_interval_end_success</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">pendulum</span><span class="o">.</span><span class="n">DateTime</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_interval</span> <span class="o">=</span> <span class="n">_get_previous_dagrun_data_interval_success</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">data_interval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">data_interval</span><span class="o">.</span><span class="n">end</span>

        <span class="k">def</span> <span class="nf">get_prev_start_date_success</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">pendulum</span><span class="o">.</span><span class="n">DateTime</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dagrun</span> <span class="o">=</span> <span class="n">_get_previous_dagrun_success</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dagrun</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">timezone</span><span class="o">.</span><span class="n">coerce_datetime</span><span class="p">(</span><span class="n">dagrun</span><span class="o">.</span><span class="n">start_date</span><span class="p">)</span>

        <span class="nd">@cache</span>
        <span class="k">def</span> <span class="nf">get_yesterday_ds</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">logical_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_yesterday_ds_nodash</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">get_yesterday_ds</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="nd">@cache</span>
        <span class="k">def</span> <span class="nf">get_tomorrow_ds</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">logical_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_tomorrow_ds_nodash</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">get_tomorrow_ds</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="nd">@cache</span>
        <span class="k">def</span> <span class="nf">get_next_execution_date</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">pendulum</span><span class="o">.</span><span class="n">DateTime</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># For manually triggered dagruns that aren&#39;t run on a schedule,</span>
            <span class="c1"># the &quot;next&quot; execution date doesn&#39;t make sense, and should be set</span>
            <span class="c1"># to execution date for consistency with how execution_date is set</span>
            <span class="c1"># for manually triggered tasks, i.e. triggered_date == execution_date.</span>
            <span class="k">if</span> <span class="n">dag_run</span><span class="o">.</span><span class="n">external_trigger</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">logical_date</span>
            <span class="k">if</span> <span class="n">dag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">next_info</span> <span class="o">=</span> <span class="n">dag</span><span class="o">.</span><span class="n">next_dagrun_info</span><span class="p">(</span><span class="n">data_interval</span><span class="p">,</span> <span class="n">restricted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">next_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">timezone</span><span class="o">.</span><span class="n">coerce_datetime</span><span class="p">(</span><span class="n">next_info</span><span class="o">.</span><span class="n">logical_date</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_next_ds</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">execution_date</span> <span class="o">=</span> <span class="n">get_next_execution_date</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">execution_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">execution_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_next_ds_nodash</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">get_next_ds</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ds</span>
            <span class="k">return</span> <span class="n">ds</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="nd">@cache</span>
        <span class="k">def</span> <span class="nf">get_prev_execution_date</span><span class="p">():</span>
            <span class="c1"># For manually triggered dagruns that aren&#39;t run on a schedule,</span>
            <span class="c1"># the &quot;previous&quot; execution date doesn&#39;t make sense, and should be set</span>
            <span class="c1"># to execution date for consistency with how execution_date is set</span>
            <span class="c1"># for manually triggered tasks, i.e. triggered_date == execution_date.</span>
            <span class="k">if</span> <span class="n">dag_run</span><span class="o">.</span><span class="n">external_trigger</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">logical_date</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">RemovedInAirflow3Warning</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">dag</span><span class="o">.</span><span class="n">previous_schedule</span><span class="p">(</span><span class="n">logical_date</span><span class="p">)</span>

        <span class="nd">@cache</span>
        <span class="k">def</span> <span class="nf">get_prev_ds</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">execution_date</span> <span class="o">=</span> <span class="n">get_prev_execution_date</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">execution_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">execution_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_prev_ds_nodash</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prev_ds</span> <span class="o">=</span> <span class="n">get_prev_ds</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">prev_ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">prev_ds</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_triggering_events</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">DatasetEvent</span><span class="p">]]:</span>
            <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="c1"># The dag_run may not be attached to the session anymore since the</span>
            <span class="c1"># code base is over-zealous with use of session.expunge_all().</span>
            <span class="c1"># Re-attach it if we get called.</span>
            <span class="k">nonlocal</span> <span class="n">dag_run</span>
            <span class="k">if</span> <span class="n">dag_run</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">dag_run</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dag_run</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">dataset_events</span> <span class="o">=</span> <span class="n">dag_run</span><span class="o">.</span><span class="n">consumed_dataset_events</span>
            <span class="n">triggering_events</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">DatasetEvent</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">dataset_events</span><span class="p">:</span>
                <span class="n">triggering_events</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">uri</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">triggering_events</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">expanded_ti_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_mapped_ti_count</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NotMapped</span><span class="p">:</span>
            <span class="n">expanded_ti_count</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># NOTE: If you add anything to this dict, make sure to also update the</span>
        <span class="c1"># definition in airflow/utils/context.pyi, and KNOWN_CONTEXT_KEYS in</span>
        <span class="c1"># airflow/utils/context.py!</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;conf&quot;</span><span class="p">:</span> <span class="n">conf</span><span class="p">,</span>
            <span class="s2">&quot;dag&quot;</span><span class="p">:</span> <span class="n">dag</span><span class="p">,</span>
            <span class="s2">&quot;dag_run&quot;</span><span class="p">:</span> <span class="n">dag_run</span><span class="p">,</span>
            <span class="s2">&quot;data_interval_end&quot;</span><span class="p">:</span> <span class="n">timezone</span><span class="o">.</span><span class="n">coerce_datetime</span><span class="p">(</span><span class="n">data_interval</span><span class="o">.</span><span class="n">end</span><span class="p">),</span>
            <span class="s2">&quot;data_interval_start&quot;</span><span class="p">:</span> <span class="n">timezone</span><span class="o">.</span><span class="n">coerce_datetime</span><span class="p">(</span><span class="n">data_interval</span><span class="o">.</span><span class="n">start</span><span class="p">),</span>
            <span class="s2">&quot;ds&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="p">,</span>
            <span class="s2">&quot;ds_nodash&quot;</span><span class="p">:</span> <span class="n">ds_nodash</span><span class="p">,</span>
            <span class="s2">&quot;execution_date&quot;</span><span class="p">:</span> <span class="n">logical_date</span><span class="p">,</span>
            <span class="s2">&quot;expanded_ti_count&quot;</span><span class="p">:</span> <span class="n">expanded_ti_count</span><span class="p">,</span>
            <span class="s2">&quot;inlets&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">inlets</span><span class="p">,</span>
            <span class="s2">&quot;logical_date&quot;</span><span class="p">:</span> <span class="n">logical_date</span><span class="p">,</span>
            <span class="s2">&quot;macros&quot;</span><span class="p">:</span> <span class="n">macros</span><span class="p">,</span>
            <span class="s2">&quot;next_ds&quot;</span><span class="p">:</span> <span class="n">get_next_ds</span><span class="p">(),</span>
            <span class="s2">&quot;next_ds_nodash&quot;</span><span class="p">:</span> <span class="n">get_next_ds_nodash</span><span class="p">(),</span>
            <span class="s2">&quot;next_execution_date&quot;</span><span class="p">:</span> <span class="n">get_next_execution_date</span><span class="p">(),</span>
            <span class="s2">&quot;outlets&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">outlets</span><span class="p">,</span>
            <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">validated_params</span><span class="p">,</span>
            <span class="s2">&quot;prev_data_interval_start_success&quot;</span><span class="p">:</span> <span class="n">get_prev_data_interval_start_success</span><span class="p">(),</span>
            <span class="s2">&quot;prev_data_interval_end_success&quot;</span><span class="p">:</span> <span class="n">get_prev_data_interval_end_success</span><span class="p">(),</span>
            <span class="s2">&quot;prev_ds&quot;</span><span class="p">:</span> <span class="n">get_prev_ds</span><span class="p">(),</span>
            <span class="s2">&quot;prev_ds_nodash&quot;</span><span class="p">:</span> <span class="n">get_prev_ds_nodash</span><span class="p">(),</span>
            <span class="s2">&quot;prev_execution_date&quot;</span><span class="p">:</span> <span class="n">get_prev_execution_date</span><span class="p">(),</span>
            <span class="s2">&quot;prev_execution_date_success&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_previous_execution_date</span><span class="p">(</span>
                <span class="n">state</span><span class="o">=</span><span class="n">DagRunState</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span>
                <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="s2">&quot;prev_start_date_success&quot;</span><span class="p">:</span> <span class="n">get_prev_start_date_success</span><span class="p">(),</span>
            <span class="s2">&quot;run_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
            <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="n">task</span><span class="p">,</span>
            <span class="s2">&quot;task_instance&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;task_instance_key_str&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">dag_id</span><span class="si">}</span><span class="s2">__</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">__</span><span class="si">{</span><span class="n">ds_nodash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;test_mode&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_mode</span><span class="p">,</span>
            <span class="s2">&quot;ti&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;tomorrow_ds&quot;</span><span class="p">:</span> <span class="n">get_tomorrow_ds</span><span class="p">(),</span>
            <span class="s2">&quot;tomorrow_ds_nodash&quot;</span><span class="p">:</span> <span class="n">get_tomorrow_ds_nodash</span><span class="p">(),</span>
            <span class="s2">&quot;triggering_dataset_events&quot;</span><span class="p">:</span> <span class="n">lazy_object_proxy</span><span class="o">.</span><span class="n">Proxy</span><span class="p">(</span><span class="n">get_triggering_events</span><span class="p">),</span>
            <span class="s2">&quot;ts&quot;</span><span class="p">:</span> <span class="n">ts</span><span class="p">,</span>
            <span class="s2">&quot;ts_nodash&quot;</span><span class="p">:</span> <span class="n">ts_nodash</span><span class="p">,</span>
            <span class="s2">&quot;ts_nodash_with_tz&quot;</span><span class="p">:</span> <span class="n">ts_nodash_with_tz</span><span class="p">,</span>
            <span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;json&quot;</span><span class="p">:</span> <span class="n">VariableAccessor</span><span class="p">(</span><span class="n">deserialize_json</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">VariableAccessor</span><span class="p">(</span><span class="n">deserialize_json</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="p">},</span>
            <span class="s2">&quot;conn&quot;</span><span class="p">:</span> <span class="n">ConnectionAccessor</span><span class="p">(),</span>
            <span class="s2">&quot;yesterday_ds&quot;</span><span class="p">:</span> <span class="n">get_yesterday_ds</span><span class="p">(),</span>
            <span class="s2">&quot;yesterday_ds_nodash&quot;</span><span class="p">:</span> <span class="n">get_yesterday_ds_nodash</span><span class="p">(),</span>
        <span class="p">}</span>
        <span class="c1"># Mypy doesn&#39;t like turning existing dicts in to a TypeDict -- and we &quot;lie&quot; in the type stub to say it</span>
        <span class="c1"># is one, but in practice it isn&#39;t. See https://github.com/python/mypy/issues/8890</span>
        <span class="k">return</span> <span class="n">Context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>  <span class="c1"># type: ignore</span></div>

    <span class="nd">@provide_session</span>
<div class="viewcode-block" id="TaskInstance.get_rendered_template_fields"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.get_rendered_template_fields">[docs]</a>    <span class="k">def</span> <span class="nf">get_rendered_template_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">NEW_SESSION</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update task with rendered template fields for presentation in UI.</span>

<span class="sd">        If task has already run, will fetch from DB; otherwise will render.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">airflow.models.renderedtifields</span> <span class="kn">import</span> <span class="n">RenderedTaskInstanceFields</span>

        <span class="n">rendered_task_instance_fields</span> <span class="o">=</span> <span class="n">RenderedTaskInstanceFields</span><span class="o">.</span><span class="n">get_templated_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rendered_task_instance_fields</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">unmap</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">rendered_value</span> <span class="ow">in</span> <span class="n">rendered_task_instance_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">rendered_value</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># If we get here, either the task hasn&#39;t run or the RTIF record was purged.</span>
            <span class="kn">from</span> <span class="nn">airflow.utils.log.secrets_masker</span> <span class="kn">import</span> <span class="n">redact</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">render_templates</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">template_fields</span><span class="p">:</span>
                <span class="n">rendered_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">redact</span><span class="p">(</span><span class="n">rendered_value</span><span class="p">,</span> <span class="n">field_name</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">TemplateAssertionError</span><span class="p">,</span> <span class="n">UndefinedError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AirflowException</span><span class="p">(</span>
                <span class="s2">&quot;Webserver does not have access to User-defined Macros or Filters &quot;</span>
                <span class="s2">&quot;when Dag Serialization is enabled. Hence for the task that have not yet &quot;</span>
                <span class="s2">&quot;started running, please use &#39;airflow tasks render&#39; for debugging the &quot;</span>
                <span class="s2">&quot;rendering of template_fields.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span></div>

<div class="viewcode-block" id="TaskInstance.overwrite_params_with_dag_run_conf"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.overwrite_params_with_dag_run_conf">[docs]</a>    <span class="k">def</span> <span class="nf">overwrite_params_with_dag_run_conf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">dag_run</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Overwrite Task Params with DagRun.conf.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dag_run</span> <span class="ow">and</span> <span class="n">dag_run</span><span class="o">.</span><span class="n">conf</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating task params (</span><span class="si">%s</span><span class="s2">) with DagRun.conf (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">dag_run</span><span class="o">.</span><span class="n">conf</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dag_run</span><span class="o">.</span><span class="n">conf</span><span class="p">)</span></div>

<div class="viewcode-block" id="TaskInstance.render_templates"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.render_templates">[docs]</a>    <span class="k">def</span> <span class="nf">render_templates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Context</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Operator</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Render templates in the operator fields.</span>

<span class="sd">        If the task was originally mapped, this may replace ``self.task`` with</span>
<span class="sd">        the unmapped, fully rendered BaseOperator. The original ``self.task``</span>
<span class="sd">        before replacement is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_template_context</span><span class="p">()</span>
        <span class="n">original_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span>

        <span class="c1"># If self.task is mapped, this call replaces self.task to point to the</span>
        <span class="c1"># unmapped BaseOperator created by this function! This is because the</span>
        <span class="c1"># MappedOperator is useless for template rendering, and we need to be</span>
        <span class="c1"># able to access the unmapped task instead.</span>
        <span class="n">original_task</span><span class="o">.</span><span class="n">render_template_fields</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">original_task</span></div>

<div class="viewcode-block" id="TaskInstance.render_k8s_pod_yaml"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.render_k8s_pod_yaml">[docs]</a>    <span class="k">def</span> <span class="nf">render_k8s_pod_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Render the k8s pod yaml.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">airflow.providers.cncf.kubernetes.template_rendering</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">render_k8s_pod_yaml</span> <span class="k">as</span> <span class="n">render_k8s_pod_yaml_from_provider</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;You need to have the `cncf.kubernetes` provider installed to use this feature. &quot;</span>
                <span class="s2">&quot;Also rather than calling it directly you should import &quot;</span>
                <span class="s2">&quot;render_k8s_pod_yaml from airflow.providers.cncf.kubernetes.template_rendering &quot;</span>
                <span class="s2">&quot;and call it with TaskInstance as the first argument.&quot;</span>
            <span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;You should not call `task_instance.render_k8s_pod_yaml` directly. This method will be removed&quot;</span>
            <span class="s2">&quot;in Airflow 3. Rather than calling it directly you should import &quot;</span>
            <span class="s2">&quot;`render_k8s_pod_yaml` from `airflow.providers.cncf.kubernetes.template_rendering` &quot;</span>
            <span class="s2">&quot;and call it with `TaskInstance` as the first argument.&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">render_k8s_pod_yaml_from_provider</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="nd">@provide_session</span>
<div class="viewcode-block" id="TaskInstance.get_rendered_k8s_spec"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.get_rendered_k8s_spec">[docs]</a>    <span class="k">def</span> <span class="nf">get_rendered_k8s_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">NEW_SESSION</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Render the k8s pod yaml.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">airflow.providers.cncf.kubernetes.template_rendering</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">get_rendered_k8s_spec</span> <span class="k">as</span> <span class="n">get_rendered_k8s_spec_from_provider</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;You need to have the `cncf.kubernetes` provider installed to use this feature. &quot;</span>
                <span class="s2">&quot;Also rather than calling it directly you should import &quot;</span>
                <span class="s2">&quot;`get_rendered_k8s_spec` from `airflow.providers.cncf.kubernetes.template_rendering` &quot;</span>
                <span class="s2">&quot;and call it with `TaskInstance` as the first argument.&quot;</span>
            <span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;You should not call `task_instance.render_k8s_pod_yaml` directly. This method will be removed&quot;</span>
            <span class="s2">&quot;in Airflow 3. Rather than calling it directly you should import &quot;</span>
            <span class="s2">&quot;`get_rendered_k8s_spec` from `airflow.providers.cncf.kubernetes.template_rendering` &quot;</span>
            <span class="s2">&quot;and call it with `TaskInstance` as the first argument.&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">get_rendered_k8s_spec_from_provider</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span></div>

<div class="viewcode-block" id="TaskInstance.get_email_subject_content"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.get_email_subject_content">[docs]</a>    <span class="k">def</span> <span class="nf">get_email_subject_content</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">BaseOperator</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the email subject content for exceptions.&quot;&quot;&quot;</span>
        <span class="c1"># For a ti from DB (without ti.task), return the default value</span>
        <span class="k">if</span> <span class="n">task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;task&quot;</span><span class="p">)</span>
        <span class="n">use_default</span> <span class="o">=</span> <span class="n">task</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">exception_html</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">)</span>

        <span class="n">default_subject</span> <span class="o">=</span> <span class="s2">&quot;Airflow alert: {{ti}}&quot;</span>
        <span class="c1"># For reporting purposes, we report based on 1-indexed,</span>
        <span class="c1"># not 0-indexed lists (i.e. Try 1 instead of</span>
        <span class="c1"># Try 0 for the first attempt).</span>
        <span class="n">default_html_content</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Try {{try_number}} out of {{max_tries + 1}}&lt;br&gt;&quot;</span>
            <span class="s2">&quot;Exception:&lt;br&gt;{{exception_html}}&lt;br&gt;&quot;</span>
            <span class="s1">&#39;Log: &lt;a href=&quot;{{ti.log_url}}&quot;&gt;Link&lt;/a&gt;&lt;br&gt;&#39;</span>
            <span class="s2">&quot;Host: {{ti.hostname}}&lt;br&gt;&quot;</span>
            <span class="s1">&#39;Mark success: &lt;a href=&quot;{{ti.mark_success_url}}&quot;&gt;Link&lt;/a&gt;&lt;br&gt;&#39;</span>
        <span class="p">)</span>

        <span class="n">default_html_content_err</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Try {{try_number}} out of {{max_tries + 1}}&lt;br&gt;&quot;</span>
            <span class="s2">&quot;Exception:&lt;br&gt;Failed attempt to attach error logs&lt;br&gt;&quot;</span>
            <span class="s1">&#39;Log: &lt;a href=&quot;{{ti.log_url}}&quot;&gt;Link&lt;/a&gt;&lt;br&gt;&#39;</span>
            <span class="s2">&quot;Host: {{ti.hostname}}&lt;br&gt;&quot;</span>
            <span class="s1">&#39;Mark success: &lt;a href=&quot;{{ti.mark_success_url}}&quot;&gt;Link&lt;/a&gt;&lt;br&gt;&#39;</span>
        <span class="p">)</span>

        <span class="c1"># This function is called after changing the state from RUNNING,</span>
        <span class="c1"># so we need to subtract 1 from self.try_number here.</span>
        <span class="n">current_try_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_number</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">additional_context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;exception&quot;</span><span class="p">:</span> <span class="n">exception</span><span class="p">,</span>
            <span class="s2">&quot;exception_html&quot;</span><span class="p">:</span> <span class="n">exception_html</span><span class="p">,</span>
            <span class="s2">&quot;try_number&quot;</span><span class="p">:</span> <span class="n">current_try_number</span><span class="p">,</span>
            <span class="s2">&quot;max_tries&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_tries</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">use_default</span><span class="p">:</span>
            <span class="n">default_context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ti&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">additional_context</span><span class="p">}</span>
            <span class="n">jinja_env</span> <span class="o">=</span> <span class="n">jinja2</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span>
                <span class="n">loader</span><span class="o">=</span><span class="n">jinja2</span><span class="o">.</span><span class="n">FileSystemLoader</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="n">autoescape</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">subject</span> <span class="o">=</span> <span class="n">jinja_env</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">default_subject</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">default_context</span><span class="p">)</span>
            <span class="n">html_content</span> <span class="o">=</span> <span class="n">jinja_env</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">default_html_content</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">default_context</span><span class="p">)</span>
            <span class="n">html_content_err</span> <span class="o">=</span> <span class="n">jinja_env</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">default_html_content_err</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">default_context</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use the DAG&#39;s get_template_env() to set force_sandboxed. Don&#39;t add</span>
            <span class="c1"># the flag to the function on task object -- that function can be</span>
            <span class="c1"># overridden, and adding a flag breaks backward compatibility.</span>
            <span class="n">dag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">get_dag</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dag</span><span class="p">:</span>
                <span class="n">jinja_env</span> <span class="o">=</span> <span class="n">dag</span><span class="o">.</span><span class="n">get_template_env</span><span class="p">(</span><span class="n">force_sandboxed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">jinja_env</span> <span class="o">=</span> <span class="n">SandboxedEnvironment</span><span class="p">(</span><span class="n">cache_size</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">jinja_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_template_context</span><span class="p">()</span>
            <span class="n">context_merge</span><span class="p">(</span><span class="n">jinja_context</span><span class="p">,</span> <span class="n">additional_context</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get_mandatory_value</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find email template file &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">!r}</span><span class="s2">&#39;. Using defaults...&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while using email template &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">!r}</span><span class="s2">&#39;. Using defaults...&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">render_template_to_string</span><span class="p">(</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">content</span><span class="p">),</span> <span class="n">jinja_context</span><span class="p">)</span>

            <span class="n">subject</span> <span class="o">=</span> <span class="n">render</span><span class="p">(</span><span class="s2">&quot;subject_template&quot;</span><span class="p">,</span> <span class="n">default_subject</span><span class="p">)</span>
            <span class="n">html_content</span> <span class="o">=</span> <span class="n">render</span><span class="p">(</span><span class="s2">&quot;html_content_template&quot;</span><span class="p">,</span> <span class="n">default_html_content</span><span class="p">)</span>
            <span class="n">html_content_err</span> <span class="o">=</span> <span class="n">render</span><span class="p">(</span><span class="s2">&quot;html_content_template&quot;</span><span class="p">,</span> <span class="n">default_html_content_err</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">subject</span><span class="p">,</span> <span class="n">html_content</span><span class="p">,</span> <span class="n">html_content_err</span></div>

<div class="viewcode-block" id="TaskInstance.email_alert"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.email_alert">[docs]</a>    <span class="k">def</span> <span class="nf">email_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">BaseOperator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send alert email with exception information.&quot;&quot;&quot;</span>
        <span class="n">subject</span><span class="p">,</span> <span class="n">html_content</span><span class="p">,</span> <span class="n">html_content_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_email_subject_content</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">task</span><span class="o">.</span><span class="n">email</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">send_email</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">html_content</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">send_email</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">html_content_err</span><span class="p">)</span></div>

<div class="viewcode-block" id="TaskInstance.set_duration"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.set_duration">[docs]</a>    <span class="k">def</span> <span class="nf">set_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set TI duration.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Task Duration set to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_record_task_map_for_downstreams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Operator</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">next</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">iter_mapped_dependants</span><span class="p">(),</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># No mapped dependants, no need to validate.</span>
            <span class="k">return</span>
        <span class="c1"># TODO: We don&#39;t push TaskMap for mapped task instances because it&#39;s not</span>
        <span class="c1"># currently possible for a downstream to depend on one individual mapped</span>
        <span class="c1"># task instance. This will change when we implement task mapping inside</span>
        <span class="c1"># a mapped task group, and we&#39;ll need to further analyze the case.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">MappedOperator</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">XComForMappingNotPushed</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_mappable_value</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UnmappableXComTypePushed</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">task_map</span> <span class="o">=</span> <span class="n">TaskMap</span><span class="o">.</span><span class="n">from_task_instance_xcom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">max_map_length</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;core&quot;</span><span class="p">,</span> <span class="s2">&quot;max_map_length&quot;</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">task_map</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">max_map_length</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnmappableXComLengthPushed</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">max_map_length</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">task_map</span><span class="p">)</span>

    <span class="nd">@provide_session</span>
<div class="viewcode-block" id="TaskInstance.xcom_push"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.xcom_push">[docs]</a>    <span class="k">def</span> <span class="nf">xcom_push</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">execution_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">NEW_SESSION</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make an XCom available for tasks to pull.</span>

<span class="sd">        :param key: Key to store the value under.</span>
<span class="sd">        :param value: Value to store. What types are possible depends on whether</span>
<span class="sd">            ``enable_xcom_pickling`` is true or not. If so, this can be any</span>
<span class="sd">            picklable object; only be JSON-serializable may be used otherwise.</span>
<span class="sd">        :param execution_date: Deprecated parameter that has no effect.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">execution_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">self_execution_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dagrun</span><span class="p">(</span><span class="n">session</span><span class="p">)</span><span class="o">.</span><span class="n">execution_date</span>
            <span class="k">if</span> <span class="n">execution_date</span> <span class="o">&lt;</span> <span class="n">self_execution_date</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;execution_date can not be in the past (current execution_date is &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">self_execution_date</span><span class="si">}</span><span class="s2">; received </span><span class="si">{</span><span class="n">execution_date</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">execution_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Passing &#39;execution_date&#39; to &#39;TaskInstance.xcom_push()&#39; is deprecated.&quot;</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">RemovedInAirflow3Warning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">XCom</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
            <span class="n">task_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
            <span class="n">dag_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="p">,</span>
            <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
            <span class="n">map_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map_index</span><span class="p">,</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="nd">@provide_session</span>
<div class="viewcode-block" id="TaskInstance.xcom_pull"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.xcom_pull">[docs]</a>    <span class="k">def</span> <span class="nf">xcom_pull</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">task_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dag_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">XCOM_RETURN_KEY</span><span class="p">,</span>
        <span class="n">include_prior_dates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">NEW_SESSION</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">map_indexes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pull XComs that optionally meet certain criteria.</span>

<span class="sd">        :param key: A key for the XCom. If provided, only XComs with matching</span>
<span class="sd">            keys will be returned. The default key is ``&#39;return_value&#39;``, also</span>
<span class="sd">            available as constant ``XCOM_RETURN_KEY``. This key is automatically</span>
<span class="sd">            given to XComs returned by tasks (as opposed to being pushed</span>
<span class="sd">            manually). To remove the filter, pass *None*.</span>
<span class="sd">        :param task_ids: Only XComs from tasks with matching ids will be</span>
<span class="sd">            pulled. Pass *None* to remove the filter.</span>
<span class="sd">        :param dag_id: If provided, only pulls XComs from this DAG. If *None*</span>
<span class="sd">            (default), the DAG of the calling task is used.</span>
<span class="sd">        :param map_indexes: If provided, only pull XComs with matching indexes.</span>
<span class="sd">            If *None* (default), this is inferred from the task(s) being pulled</span>
<span class="sd">            (see below for details).</span>
<span class="sd">        :param include_prior_dates: If False, only XComs from the current</span>
<span class="sd">            execution_date are returned. If *True*, XComs from previous dates</span>
<span class="sd">            are returned as well.</span>

<span class="sd">        When pulling one single task (``task_id`` is *None* or a str) without</span>
<span class="sd">        specifying ``map_indexes``, the return value is inferred from whether</span>
<span class="sd">        the specified task is mapped. If not, value from the one single task</span>
<span class="sd">        instance is returned. If the task to pull is mapped, an iterator (not a</span>
<span class="sd">        list) yielding XComs from mapped task instances is returned. In either</span>
<span class="sd">        case, ``default`` (*None* if not specified) is returned if no matching</span>
<span class="sd">        XComs are found.</span>

<span class="sd">        When pulling multiple tasks (i.e. either ``task_id`` or ``map_index`` is</span>
<span class="sd">        a non-str iterable), a list of matching XComs is returned. Elements in</span>
<span class="sd">        the list is ordered by item ordering in ``task_id`` and ``map_index``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dag_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dag_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">XCom</span><span class="o">.</span><span class="n">get_many</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
            <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
            <span class="n">dag_ids</span><span class="o">=</span><span class="n">dag_id</span><span class="p">,</span>
            <span class="n">task_ids</span><span class="o">=</span><span class="n">task_ids</span><span class="p">,</span>
            <span class="n">map_indexes</span><span class="o">=</span><span class="n">map_indexes</span><span class="p">,</span>
            <span class="n">include_prior_dates</span><span class="o">=</span><span class="n">include_prior_dates</span><span class="p">,</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># NOTE: Since we&#39;re only fetching the value field and not the whole</span>
        <span class="c1"># class, the @recreate annotation does not kick in. Therefore we need to</span>
        <span class="c1"># call XCom.deserialize_value() manually.</span>

        <span class="c1"># We are only pulling one single task.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">task_ids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task_ids</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">map_indexes</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">with_entities</span><span class="p">(</span>
                <span class="n">XCom</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span> <span class="n">XCom</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">XCom</span><span class="o">.</span><span class="n">dag_id</span><span class="p">,</span> <span class="n">XCom</span><span class="o">.</span><span class="n">map_index</span><span class="p">,</span> <span class="n">XCom</span><span class="o">.</span><span class="n">value</span>
            <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">first</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># No matching XCom at all.</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="k">if</span> <span class="n">map_indexes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">first</span><span class="o">.</span><span class="n">map_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">XCom</span><span class="o">.</span><span class="n">deserialize_value</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">XCom</span><span class="o">.</span><span class="n">map_index</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">LazyXComAccess</span><span class="o">.</span><span class="n">build_from_xcom_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="c1"># At this point either task_ids or map_indexes is explicitly multi-value.</span>
        <span class="c1"># Order return values to match task_ids and map_indexes ordering.</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">task_ids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task_ids</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">XCom</span><span class="o">.</span><span class="n">task_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">task_id_whens</span> <span class="o">=</span> <span class="p">{</span><span class="n">tid</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">task_ids</span><span class="p">)}</span>
            <span class="k">if</span> <span class="n">task_id_whens</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">case</span><span class="p">(</span><span class="n">task_id_whens</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">XCom</span><span class="o">.</span><span class="n">task_id</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">XCom</span><span class="o">.</span><span class="n">task_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">map_indexes</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">map_indexes</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">XCom</span><span class="o">.</span><span class="n">map_index</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">map_indexes</span><span class="p">,</span> <span class="nb">range</span><span class="p">):</span>
            <span class="n">order</span> <span class="o">=</span> <span class="n">XCom</span><span class="o">.</span><span class="n">map_index</span>
            <span class="k">if</span> <span class="n">map_indexes</span><span class="o">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">desc</span><span class="p">()</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">map_index_whens</span> <span class="o">=</span> <span class="p">{</span><span class="n">map_index</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">map_index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">map_indexes</span><span class="p">)}</span>
            <span class="k">if</span> <span class="n">map_index_whens</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">case</span><span class="p">(</span><span class="n">map_index_whens</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">XCom</span><span class="o">.</span><span class="n">map_index</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">XCom</span><span class="o">.</span><span class="n">map_index</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">LazyXComAccess</span><span class="o">.</span><span class="n">build_from_xcom_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></div>

    <span class="nd">@provide_session</span>
<div class="viewcode-block" id="TaskInstance.get_num_running_task_instances"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.get_num_running_task_instances">[docs]</a>    <span class="k">def</span> <span class="nf">get_num_running_task_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">same_dagrun</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return Number of running TIs from the DB.&quot;&quot;&quot;</span>
        <span class="c1"># .count() is inefficient</span>
        <span class="n">num_running_task_instances_query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">())</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">TaskInstance</span><span class="o">.</span><span class="n">dag_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="p">,</span>
            <span class="n">TaskInstance</span><span class="o">.</span><span class="n">task_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
            <span class="n">TaskInstance</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">same_dagrun</span><span class="p">:</span>
            <span class="n">num_running_task_instances_query</span> <span class="o">=</span> <span class="n">num_running_task_instances_query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_id</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">num_running_task_instances_query</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span></div>

<div class="viewcode-block" id="TaskInstance.init_run_context"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.init_run_context">[docs]</a>    <span class="k">def</span> <span class="nf">init_run_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the log context.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">raw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="TaskInstance.filter_for_tis"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.filter_for_tis">[docs]</a>    <span class="k">def</span> <span class="nf">filter_for_tis</span><span class="p">(</span><span class="n">tis</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">TaskInstance</span> <span class="o">|</span> <span class="n">TaskInstanceKey</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">BooleanClauseList</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return SQLAlchemy filter to query selected task instances.&quot;&quot;&quot;</span>
        <span class="c1"># DictKeys type, (what we often pass here from the scheduler) is not directly indexable :(</span>
        <span class="c1"># Or it might be a generator, but we need to be able to iterate over it more than once</span>
        <span class="n">tis</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tis</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tis</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">first</span> <span class="o">=</span> <span class="n">tis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">dag_id</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">dag_id</span>
        <span class="n">run_id</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">run_id</span>
        <span class="n">map_index</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">map_index</span>
        <span class="n">first_task_id</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">task_id</span>

        <span class="c1"># pre-compute the set of dag_id, run_id, map_indices and task_ids</span>
        <span class="n">dag_ids</span><span class="p">,</span> <span class="n">run_ids</span><span class="p">,</span> <span class="n">map_indices</span><span class="p">,</span> <span class="n">task_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tis</span><span class="p">:</span>
            <span class="n">dag_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">dag_id</span><span class="p">)</span>
            <span class="n">run_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span>
            <span class="n">map_indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">map_index</span><span class="p">)</span>
            <span class="n">task_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">task_id</span><span class="p">)</span>

        <span class="c1"># Common path optimisations: when all TIs are for the same dag_id and run_id, or same dag_id</span>
        <span class="c1"># and task_id -- this can be over 150x faster for huge numbers of TIs (20k+)</span>
        <span class="k">if</span> <span class="n">dag_ids</span> <span class="o">==</span> <span class="p">{</span><span class="n">dag_id</span><span class="p">}</span> <span class="ow">and</span> <span class="n">run_ids</span> <span class="o">==</span> <span class="p">{</span><span class="n">run_id</span><span class="p">}</span> <span class="ow">and</span> <span class="n">map_indices</span> <span class="o">==</span> <span class="p">{</span><span class="n">map_index</span><span class="p">}:</span>
            <span class="k">return</span> <span class="n">and_</span><span class="p">(</span>
                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">dag_id</span> <span class="o">==</span> <span class="n">dag_id</span><span class="p">,</span>
                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="n">run_id</span><span class="p">,</span>
                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">map_index</span> <span class="o">==</span> <span class="n">map_index</span><span class="p">,</span>
                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">task_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">task_ids</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">dag_ids</span> <span class="o">==</span> <span class="p">{</span><span class="n">dag_id</span><span class="p">}</span> <span class="ow">and</span> <span class="n">task_ids</span> <span class="o">==</span> <span class="p">{</span><span class="n">first_task_id</span><span class="p">}</span> <span class="ow">and</span> <span class="n">map_indices</span> <span class="o">==</span> <span class="p">{</span><span class="n">map_index</span><span class="p">}:</span>
            <span class="k">return</span> <span class="n">and_</span><span class="p">(</span>
                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">dag_id</span> <span class="o">==</span> <span class="n">dag_id</span><span class="p">,</span>
                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">run_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">run_ids</span><span class="p">),</span>
                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">map_index</span> <span class="o">==</span> <span class="n">map_index</span><span class="p">,</span>
                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">task_id</span> <span class="o">==</span> <span class="n">first_task_id</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">dag_ids</span> <span class="o">==</span> <span class="p">{</span><span class="n">dag_id</span><span class="p">}</span> <span class="ow">and</span> <span class="n">run_ids</span> <span class="o">==</span> <span class="p">{</span><span class="n">run_id</span><span class="p">}</span> <span class="ow">and</span> <span class="n">task_ids</span> <span class="o">==</span> <span class="p">{</span><span class="n">first_task_id</span><span class="p">}:</span>
            <span class="k">return</span> <span class="n">and_</span><span class="p">(</span>
                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">dag_id</span> <span class="o">==</span> <span class="n">dag_id</span><span class="p">,</span>
                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="n">run_id</span><span class="p">,</span>
                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">map_index</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">map_indices</span><span class="p">),</span>
                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">task_id</span> <span class="o">==</span> <span class="n">first_task_id</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">filter_condition</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># create 2 nested groups, both primarily grouped by dag_id and run_id,</span>
        <span class="c1"># and in the nested group 1 grouped by task_id the other by map_index.</span>
        <span class="n">task_id_groups</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
        <span class="n">map_index_groups</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tis</span><span class="p">:</span>
            <span class="n">task_id_groups</span><span class="p">[(</span><span class="n">t</span><span class="o">.</span><span class="n">dag_id</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">run_id</span><span class="p">)][</span><span class="n">t</span><span class="o">.</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">map_index</span><span class="p">)</span>
            <span class="n">map_index_groups</span><span class="p">[(</span><span class="n">t</span><span class="o">.</span><span class="n">dag_id</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">run_id</span><span class="p">)][</span><span class="n">t</span><span class="o">.</span><span class="n">map_index</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">task_id</span><span class="p">)</span>

        <span class="c1"># this assumes that most dags have dag_id as the largest grouping, followed by run_id. even</span>
        <span class="c1"># if its not, this is still  a significant optimization over querying for every single tuple key</span>
        <span class="k">for</span> <span class="n">cur_dag_id</span> <span class="ow">in</span> <span class="n">dag_ids</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cur_run_id</span> <span class="ow">in</span> <span class="n">run_ids</span><span class="p">:</span>
                <span class="c1"># we compare the group size between task_id and map_index and use the smaller group</span>
                <span class="n">dag_task_id_groups</span> <span class="o">=</span> <span class="n">task_id_groups</span><span class="p">[(</span><span class="n">cur_dag_id</span><span class="p">,</span> <span class="n">cur_run_id</span><span class="p">)]</span>
                <span class="n">dag_map_index_groups</span> <span class="o">=</span> <span class="n">map_index_groups</span><span class="p">[(</span><span class="n">cur_dag_id</span><span class="p">,</span> <span class="n">cur_run_id</span><span class="p">)]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dag_task_id_groups</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dag_map_index_groups</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">cur_task_id</span><span class="p">,</span> <span class="n">cur_map_indices</span> <span class="ow">in</span> <span class="n">dag_task_id_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">filter_condition</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">and_</span><span class="p">(</span>
                                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">dag_id</span> <span class="o">==</span> <span class="n">cur_dag_id</span><span class="p">,</span>
                                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="n">cur_run_id</span><span class="p">,</span>
                                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">task_id</span> <span class="o">==</span> <span class="n">cur_task_id</span><span class="p">,</span>
                                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">map_index</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">cur_map_indices</span><span class="p">),</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">cur_map_index</span><span class="p">,</span> <span class="n">cur_task_ids</span> <span class="ow">in</span> <span class="n">dag_map_index_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">filter_condition</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">and_</span><span class="p">(</span>
                                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">dag_id</span> <span class="o">==</span> <span class="n">cur_dag_id</span><span class="p">,</span>
                                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="n">cur_run_id</span><span class="p">,</span>
                                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">task_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">cur_task_ids</span><span class="p">),</span>
                                <span class="n">TaskInstance</span><span class="o">.</span><span class="n">map_index</span> <span class="o">==</span> <span class="n">cur_map_index</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

        <span class="k">return</span> <span class="n">or_</span><span class="p">(</span><span class="o">*</span><span class="n">filter_condition</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">ti_selector_condition</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">vals</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">ColumnOperators</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build an SQLAlchemy filter for a list of task_ids or tuples of (task_id,map_index).</span>

<span class="sd">        :meta private:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Compute a filter for TI.task_id and TI.map_index based on input values</span>
        <span class="c1"># For each item, it will either be a task_id, or (task_id, map_index)</span>
        <span class="n">task_id_only</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)]</span>
        <span class="n">with_map_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)]</span>

        <span class="n">filters</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ColumnOperators</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">task_id_only</span><span class="p">:</span>
            <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">task_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">task_id_only</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">with_map_index</span><span class="p">:</span>
            <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tuple_in_condition</span><span class="p">((</span><span class="bp">cls</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">map_index</span><span class="p">),</span> <span class="n">with_map_index</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">filters</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">false</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">or_</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">)</span>

    <span class="nd">@Sentry</span><span class="o">.</span><span class="n">enrich_errors</span>
    <span class="nd">@provide_session</span>
<div class="viewcode-block" id="TaskInstance.schedule_downstream_tasks"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.schedule_downstream_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_downstream_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">NEW_SESSION</span><span class="p">,</span> <span class="n">max_tis_per_query</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Schedule downstream tasks of this task instance.</span>

<span class="sd">        :meta: private</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">OperationalError</span>

        <span class="kn">from</span> <span class="nn">airflow.models</span> <span class="kn">import</span> <span class="n">DagRun</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Re-select the row with a lock</span>
            <span class="n">dag_run</span> <span class="o">=</span> <span class="n">with_row_locks</span><span class="p">(</span>
                <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DagRun</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
                    <span class="n">dag_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="p">,</span>
                    <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>

            <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span>
            <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">task</span><span class="o">.</span><span class="n">dag</span>

            <span class="c1"># Get a partial DAG with just the specific tasks we want to examine.</span>
            <span class="c1"># In order for dep checks to work correctly, we include ourself (so</span>
            <span class="c1"># TriggerRuleDep can check the state of the task we just executed).</span>
            <span class="n">partial_dag</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">partial_subset</span><span class="p">(</span>
                <span class="n">task</span><span class="o">.</span><span class="n">downstream_task_ids</span><span class="p">,</span>
                <span class="n">include_downstream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">include_upstream</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">include_direct_upstream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">dag_run</span><span class="o">.</span><span class="n">dag</span> <span class="o">=</span> <span class="n">partial_dag</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">dag_run</span><span class="o">.</span><span class="n">task_instance_scheduling_decisions</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

            <span class="n">skippable_task_ids</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">task_id</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">partial_dag</span><span class="o">.</span><span class="n">task_ids</span> <span class="k">if</span> <span class="n">task_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">downstream_task_ids</span>
            <span class="p">}</span>

            <span class="n">schedulable_tis</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ti</span>
                <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">schedulable_tis</span>
                <span class="k">if</span> <span class="n">ti</span><span class="o">.</span><span class="n">task_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skippable_task_ids</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
                    <span class="n">ti</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">inherits_from_empty_operator</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">ti</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">on_execute_callback</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">ti</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">on_success_callback</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">ti</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">outlets</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">schedulable_ti</span> <span class="ow">in</span> <span class="n">schedulable_tis</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">schedulable_ti</span><span class="p">,</span> <span class="s2">&quot;task&quot;</span><span class="p">):</span>
                    <span class="n">schedulable_ti</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">get_task</span><span class="p">(</span><span class="n">schedulable_ti</span><span class="o">.</span><span class="n">task_id</span><span class="p">)</span>

            <span class="n">num</span> <span class="o">=</span> <span class="n">dag_run</span><span class="o">.</span><span class="n">schedule_tis</span><span class="p">(</span><span class="n">schedulable_tis</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">max_tis_per_query</span><span class="o">=</span><span class="n">max_tis_per_query</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> downstream tasks scheduled from follow-on schedule check&quot;</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>

            <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">except</span> <span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Any kind of DB error here is _non fatal_ as this block is just an optimisation.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Skipping mini scheduling run due to exception: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">e</span><span class="o">.</span><span class="n">statement</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span></div>

<div class="viewcode-block" id="TaskInstance.get_relevant_upstream_map_indexes"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.get_relevant_upstream_map_indexes">[docs]</a>    <span class="k">def</span> <span class="nf">get_relevant_upstream_map_indexes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">upstream</span><span class="p">:</span> <span class="n">Operator</span><span class="p">,</span>
        <span class="n">ti_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">range</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Infer the map indexes of an upstream &quot;relevant&quot; to this ti.</span>

<span class="sd">        The bulk of the logic mainly exists to solve the problem described by</span>
<span class="sd">        the following example, where &#39;val&#39; must resolve to different values,</span>
<span class="sd">        depending on where the reference is being used::</span>

<span class="sd">            @task</span>
<span class="sd">            def this_task(v):  # This is self.task.</span>
<span class="sd">                return v * 2</span>

<span class="sd">            @task_group</span>
<span class="sd">            def tg1(inp):</span>
<span class="sd">                val = upstream(inp)  # This is the upstream task.</span>
<span class="sd">                this_task(val)  # When inp is 1, val here should resolve to 2.</span>
<span class="sd">                return val</span>

<span class="sd">            # This val is the same object returned by tg1.</span>
<span class="sd">            val = tg1.expand(inp=[1, 2, 3])</span>

<span class="sd">            @task_group</span>
<span class="sd">            def tg2(inp):</span>
<span class="sd">                another_task(inp, val)  # val here should resolve to [2, 4, 6].</span>

<span class="sd">            tg2.expand(inp=[&quot;a&quot;, &quot;b&quot;])</span>

<span class="sd">        The surrounding mapped task groups of ``upstream`` and ``self.task`` are</span>
<span class="sd">        inspected to find a common &quot;ancestor&quot;. If such an ancestor is found,</span>
<span class="sd">        we need to return specific map indexes to pull a partial value from</span>
<span class="sd">        upstream XCom.</span>

<span class="sd">        :param upstream: The referenced upstream task.</span>
<span class="sd">        :param ti_count: The total count of task instance this task was expanded</span>
<span class="sd">            by the scheduler, i.e. ``expanded_ti_count`` in the template context.</span>
<span class="sd">        :return: Specific map index or map indexes to pull, or ``None`` if we</span>
<span class="sd">            want to &quot;whole&quot; return value (i.e. no mapped task groups involved).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This value should never be None since we already know the current task</span>
        <span class="c1"># is in a mapped task group, and should have been expanded, despite that,</span>
        <span class="c1"># we need to check that it is not None to satisfy Mypy.</span>
        <span class="c1"># But this value can be 0 when we expand an empty list, for that it is</span>
        <span class="c1"># necessary to check that ti_count is not 0 to avoid dividing by 0.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ti_count</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Find the innermost common mapped task group between the current task</span>
        <span class="c1"># If the current task and the referenced task does not have a common</span>
        <span class="c1"># mapped task group, the two are in different task mapping contexts</span>
        <span class="c1"># (like another_task above), and we should use the &quot;whole&quot; value.</span>
        <span class="n">common_ancestor</span> <span class="o">=</span> <span class="n">_find_common_ancestor_mapped_group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="n">upstream</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">common_ancestor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># At this point we know the two tasks share a mapped task group, and we</span>
        <span class="c1"># should use a &quot;partial&quot; value. Let&#39;s break down the mapped ti count</span>
        <span class="c1"># between the ancestor and further expansion happened inside it.</span>
        <span class="n">ancestor_ti_count</span> <span class="o">=</span> <span class="n">common_ancestor</span><span class="o">.</span><span class="n">get_mapped_ti_count</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
        <span class="n">ancestor_map_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_index</span> <span class="o">*</span> <span class="n">ancestor_ti_count</span> <span class="o">//</span> <span class="n">ti_count</span>

        <span class="c1"># If the task is NOT further expanded inside the common ancestor, we</span>
        <span class="c1"># only want to reference one single ti. We must walk the actual DAG,</span>
        <span class="c1"># and &quot;ti_count == ancestor_ti_count&quot; does not work, since the further</span>
        <span class="c1"># expansion may be of length 1.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_further_mapped_inside</span><span class="p">(</span><span class="n">upstream</span><span class="p">,</span> <span class="n">common_ancestor</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ancestor_map_index</span>

        <span class="c1"># Otherwise we need a partial aggregation for values from selected task</span>
        <span class="c1"># instances in the ancestor&#39;s expansion context.</span>
        <span class="n">further_count</span> <span class="o">=</span> <span class="n">ti_count</span> <span class="o">//</span> <span class="n">ancestor_ti_count</span>
        <span class="n">map_index_start</span> <span class="o">=</span> <span class="n">ancestor_map_index</span> <span class="o">*</span> <span class="n">further_count</span>
        <span class="k">return</span> <span class="nb">range</span><span class="p">(</span><span class="n">map_index_start</span><span class="p">,</span> <span class="n">map_index_start</span> <span class="o">+</span> <span class="n">further_count</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">clear_db_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear db tables that have a reference to this instance.</span>

<span class="sd">        :param session: ORM Session</span>

<span class="sd">        :meta private:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">airflow.models.renderedtifields</span> <span class="kn">import</span> <span class="n">RenderedTaskInstanceFields</span>

        <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="n">TaskFail</span><span class="p">,</span> <span class="n">TaskInstanceNote</span><span class="p">,</span> <span class="n">TaskReschedule</span><span class="p">,</span> <span class="n">XCom</span><span class="p">,</span> <span class="n">RenderedTaskInstanceFields</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">delete</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">dag_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="p">,</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">task_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">map_index</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_index</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_find_common_ancestor_mapped_group</span><span class="p">(</span><span class="n">node1</span><span class="p">:</span> <span class="n">Operator</span><span class="p">,</span> <span class="n">node2</span><span class="p">:</span> <span class="n">Operator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappedTaskGroup</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given two operators, find their innermost common mapped task group.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">node1</span><span class="o">.</span><span class="n">dag</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">node2</span><span class="o">.</span><span class="n">dag</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">node1</span><span class="o">.</span><span class="n">dag_id</span> <span class="o">!=</span> <span class="n">node2</span><span class="o">.</span><span class="n">dag_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">parent_group_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">g</span><span class="o">.</span><span class="n">group_id</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">node1</span><span class="o">.</span><span class="n">iter_mapped_task_groups</span><span class="p">()}</span>
    <span class="n">common_groups</span> <span class="o">=</span> <span class="p">(</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">node2</span><span class="o">.</span><span class="n">iter_mapped_task_groups</span><span class="p">()</span> <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">group_id</span> <span class="ow">in</span> <span class="n">parent_group_ids</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">common_groups</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_is_further_mapped_inside</span><span class="p">(</span><span class="n">operator</span><span class="p">:</span> <span class="n">Operator</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="n">TaskGroup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Whether given operator is *further* mapped inside a task group.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operator</span><span class="p">,</span> <span class="n">MappedOperator</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="n">task_group</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">task_group</span>
    <span class="k">while</span> <span class="n">task_group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">task_group</span><span class="o">.</span><span class="n">group_id</span> <span class="o">!=</span> <span class="n">container</span><span class="o">.</span><span class="n">group_id</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task_group</span><span class="p">,</span> <span class="n">MappedTaskGroup</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">task_group</span> <span class="o">=</span> <span class="n">task_group</span><span class="o">.</span><span class="n">parent_group</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="c1"># State of the task instance.</span>
<span class="c1"># Stores string version of the task state.</span>
<div class="viewcode-block" id="TaskInstanceStateType"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstanceStateType">[docs]</a><span class="n">TaskInstanceStateType</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">TaskInstanceKey</span><span class="p">,</span> <span class="n">TaskInstanceState</span><span class="p">]</span></div>


<div class="viewcode-block" id="SimpleTaskInstance"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.SimpleTaskInstance">[docs]</a><span class="k">class</span> <span class="nc">SimpleTaskInstance</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simplified Task Instance.</span>

<span class="sd">    Used to send data between processes via Queues.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dag_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">try_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">map_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">executor_config</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">pool</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">queue</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">TaskInstanceKey</span><span class="p">,</span>
        <span class="n">run_as_user</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">priority_weight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span> <span class="o">=</span> <span class="n">dag_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">task_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_id</span> <span class="o">=</span> <span class="n">run_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_index</span> <span class="o">=</span> <span class="n">map_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">=</span> <span class="n">end_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">try_number</span> <span class="o">=</span> <span class="n">try_number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor_config</span> <span class="o">=</span> <span class="n">executor_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_as_user</span> <span class="o">=</span> <span class="n">run_as_user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">pool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority_weight</span> <span class="o">=</span> <span class="n">priority_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>

<div class="viewcode-block" id="SimpleTaskInstance.__eq__"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.SimpleTaskInstance.__eq__">[docs]</a>    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span></div>

<div class="viewcode-block" id="SimpleTaskInstance.as_dict"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.SimpleTaskInstance.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;This method is deprecated. Use BaseSerialization.serialize.&quot;</span><span class="p">,</span>
            <span class="n">RemovedInAirflow3Warning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">new_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">,</span> <span class="s2">&quot;end_date&quot;</span><span class="p">]:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">new_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()})</span>
        <span class="k">return</span> <span class="n">new_dict</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="SimpleTaskInstance.from_ti"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.SimpleTaskInstance.from_ti">[docs]</a>    <span class="k">def</span> <span class="nf">from_ti</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ti</span><span class="p">:</span> <span class="n">TaskInstance</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SimpleTaskInstance</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">dag_id</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">dag_id</span><span class="p">,</span>
            <span class="n">task_id</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
            <span class="n">run_id</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
            <span class="n">map_index</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">map_index</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">start_date</span><span class="p">,</span>
            <span class="n">end_date</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">end_date</span><span class="p">,</span>
            <span class="n">try_number</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">try_number</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
            <span class="n">executor_config</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">executor_config</span><span class="p">,</span>
            <span class="n">pool</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">pool</span><span class="p">,</span>
            <span class="n">queue</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
            <span class="n">run_as_user</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">run_as_user</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="s2">&quot;run_as_user&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">priority_weight</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">priority_weight</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="s2">&quot;priority_weight&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="SimpleTaskInstance.from_dict"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.SimpleTaskInstance.from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SimpleTaskInstance</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;This method is deprecated. Use BaseSerialization.deserialize.&quot;</span><span class="p">,</span>
            <span class="n">RemovedInAirflow3Warning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ti_key</span> <span class="o">=</span> <span class="n">TaskInstanceKey</span><span class="p">(</span><span class="o">*</span><span class="n">obj_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">))</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">start_date_str</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">obj_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;start_date&quot;</span><span class="p">)</span>
        <span class="n">end_date_str</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">obj_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;end_date&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start_date_str</span><span class="p">:</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">start_date_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">end_date_str</span><span class="p">:</span>
            <span class="n">end_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">end_date_str</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">obj_dict</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">ti_key</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TaskInstanceNote"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstanceNote">[docs]</a><span class="k">class</span> <span class="nc">TaskInstanceNote</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;For storage of arbitrary notes concerning the task instance.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TaskInstanceNote.__tablename__"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstanceNote.__tablename__">[docs]</a>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;task_instance_note&quot;</span></div>

<div class="viewcode-block" id="TaskInstanceNote.user_id"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstanceNote.user_id">[docs]</a>    <span class="n">user_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;ab_user.id&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;task_instance_note_user_fkey&quot;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstanceNote.task_id"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstanceNote.task_id">[docs]</a>    <span class="n">task_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">StringID</span><span class="p">(),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstanceNote.dag_id"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstanceNote.dag_id">[docs]</a>    <span class="n">dag_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">StringID</span><span class="p">(),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstanceNote.run_id"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstanceNote.run_id">[docs]</a>    <span class="n">run_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">StringID</span><span class="p">(),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstanceNote.map_index"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstanceNote.map_index">[docs]</a>    <span class="n">map_index</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstanceNote.content"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstanceNote.content">[docs]</a>    <span class="n">content</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">with_variant</span><span class="p">(</span><span class="n">Text</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span> <span class="s2">&quot;mysql&quot;</span><span class="p">))</span></div>
<div class="viewcode-block" id="TaskInstanceNote.created_at"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstanceNote.created_at">[docs]</a>    <span class="n">created_at</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UtcDateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskInstanceNote.updated_at"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstanceNote.updated_at">[docs]</a>    <span class="n">updated_at</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UtcDateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">,</span> <span class="n">onupdate</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="TaskInstanceNote.task_instance"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstanceNote.task_instance">[docs]</a>    <span class="n">task_instance</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;TaskInstance&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;task_instance_note&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TaskInstanceNote.__table_args__"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstanceNote.__table_args__">[docs]</a>    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">PrimaryKeyConstraint</span><span class="p">(</span>
            <span class="s2">&quot;task_id&quot;</span><span class="p">,</span> <span class="s2">&quot;dag_id&quot;</span><span class="p">,</span> <span class="s2">&quot;run_id&quot;</span><span class="p">,</span> <span class="s2">&quot;map_index&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;task_instance_note_pkey&quot;</span><span class="p">,</span> <span class="n">mssql_clustered</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">),</span>
        <span class="n">ForeignKeyConstraint</span><span class="p">(</span>
            <span class="p">(</span><span class="n">dag_id</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">map_index</span><span class="p">),</span>
            <span class="p">[</span>
                <span class="s2">&quot;task_instance.dag_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;task_instance.task_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;task_instance.run_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;task_instance.map_index&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;task_instance_note_ti_fkey&quot;</span><span class="p">,</span>
            <span class="n">ondelete</span><span class="o">=</span><span class="s2">&quot;CASCADE&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span>

<div class="viewcode-block" id="TaskInstanceNote.__repr__"><a class="viewcode-back" href="../../../_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstanceNote.__repr__">[docs]</a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dag_id</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">run_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; map_index=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">map_index</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span></div></div>


<span class="n">STATICA_HACK</span> <span class="o">=</span> <span class="kc">True</span>
<span class="nb">globals</span><span class="p">()[</span><span class="s2">&quot;kcah_acitats&quot;</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">if</span> <span class="n">STATICA_HACK</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="kn">from</span> <span class="nn">airflow.jobs.job</span> <span class="kn">import</span> <span class="n">Job</span>

    <span class="n">TaskInstance</span><span class="o">.</span><span class="n">queued_by_job</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">Job</span><span class="p">)</span>
</pre></div>

    <div class="pager" role="navigation" aria-label="related navigation"><button class="btn-hollow btn-blue bodytext__medium--cerulean-blue" disabled>Previous</button><button class="btn-hollow btn-blue bodytext__medium--cerulean-blue" disabled>Next</button>
    </div>
                                    </div>

                                </div>
                            </div>
                    </div>
                </div>
    <div class="rating-container">
        <p class="bodytext__medium--greyish-brown font-weight-500">Was this entry helpful?</p>
        <div class="rating">

            <div id="rate-star-5" class="rate-star">
                <svg xmlns="http://www.w3.org/2000/svg" width="21.05" height="20.02" viewBox="0 0 21.05 20.02">
                    <g id="Group_806" data-name="Group 806" transform="translate(-774.404 -13.178)">
                        <path id="Path_715" d="M791.434 33.2l-6.5-3.42-6.5 3.42 1.242-7.243-5.262-5.13 7.273-1.057 3.252-6.59 3.252 6.59 7.273 1.057-5.262 5.13z" fill="#017cee" data-name="Path 715"></path>
                    </g>
                </svg>

            </div>

            <div id="rate-star-4" class="rate-star">
                <svg xmlns="http://www.w3.org/2000/svg" width="21.05" height="20.02" viewBox="0 0 21.05 20.02">
                    <g id="Group_806" data-name="Group 806" transform="translate(-774.404 -13.178)">
                        <path id="Path_715" d="M791.434 33.2l-6.5-3.42-6.5 3.42 1.242-7.243-5.262-5.13 7.273-1.057 3.252-6.59 3.252 6.59 7.273 1.057-5.262 5.13z" fill="#017cee" data-name="Path 715"></path>
                    </g>
                </svg>

            </div>

            <div id="rate-star-3" class="rate-star">
                <svg xmlns="http://www.w3.org/2000/svg" width="21.05" height="20.02" viewBox="0 0 21.05 20.02">
                    <g id="Group_806" data-name="Group 806" transform="translate(-774.404 -13.178)">
                        <path id="Path_715" d="M791.434 33.2l-6.5-3.42-6.5 3.42 1.242-7.243-5.262-5.13 7.273-1.057 3.252-6.59 3.252 6.59 7.273 1.057-5.262 5.13z" fill="#017cee" data-name="Path 715"></path>
                    </g>
                </svg>

            </div>

            <div id="rate-star-2" class="rate-star">
                <svg xmlns="http://www.w3.org/2000/svg" width="21.05" height="20.02" viewBox="0 0 21.05 20.02">
                    <g id="Group_806" data-name="Group 806" transform="translate(-774.404 -13.178)">
                        <path id="Path_715" d="M791.434 33.2l-6.5-3.42-6.5 3.42 1.242-7.243-5.262-5.13 7.273-1.057 3.252-6.59 3.252 6.59 7.273 1.057-5.262 5.13z" fill="#017cee" data-name="Path 715"></path>
                    </g>
                </svg>

            </div>

            <div id="rate-star-1" class="rate-star">
                <svg xmlns="http://www.w3.org/2000/svg" width="21.05" height="20.02" viewBox="0 0 21.05 20.02">
                    <g id="Group_806" data-name="Group 806" transform="translate(-774.404 -13.178)">
                        <path id="Path_715" d="M791.434 33.2l-6.5-3.42-6.5 3.42 1.242-7.243-5.262-5.13 7.273-1.057 3.252-6.59 3.252 6.59 7.273 1.057-5.262 5.13z" fill="#017cee" data-name="Path 715"></path>
                    </g>
                </svg>

            </div>

        </div>
    </div>
                
            </main>
            

            
            
    <nav class="wy-nav-side-toc">
        <div class="wy-menu-vertical">
            
        </div>
    </nav>
            
        </div>
        


    







    </div>


    

<footer>
    <div class="footer-section footer-section__media-section">
        <div class="d-flex align-items-center">

            <a class="footer-section__media-section--link" target="_blank" href="https://github.com/apache/airflow">
                <svg xmlns="http://www.w3.org/2000/svg" width="46.14" height="45" viewBox="0 0 46.14 45">
                    <path id="Path_207" d="M228.962 1078.578a23.072 23.072 0 0 0-7.29 44.96c1.154.212 1.574-.5 1.574-1.112 0-.548-.02-2-.031-3.924-6.417 1.394-7.771-3.093-7.771-3.093a6.109 6.109 0 0 0-2.562-3.375c-2.095-1.431.159-1.4.159-1.4a4.846 4.846 0 0 1 3.533 2.377c2.058 3.525 5.4 2.507 6.714 1.917a4.926 4.926 0 0 1 1.464-3.084c-5.123-.582-10.508-2.562-10.508-11.4a8.919 8.919 0 0 1 2.374-6.191 8.3 8.3 0 0 1 .226-6.105s1.937-.62 6.344 2.365a21.857 21.857 0 0 1 11.551 0c4.4-2.985 6.338-2.365 6.338-2.365a8.284 8.284 0 0 1 .23 6.105 8.9 8.9 0 0 1 2.371 6.191c0 8.862-5.393 10.812-10.533 11.384a5.506 5.506 0 0 1 1.566 4.272c0 3.084-.028 5.572-.028 6.329 0 .617.415 1.334 1.586 1.109a23.073 23.073 0 0 0-7.308-44.958z" fill="#fff" fill-rule="evenodd" data-name="Path 207" transform="translate(-205.894 -1078.578)"></path>
                </svg>

            </a>

            <a class="footer-section__media-section--link" target="_blank" href="https://github.com/apache/airflow/issues">
                <svg xmlns="http://www.w3.org/2000/svg" width="45" height="45" viewBox="0 0 45 45">
                    <g id="Group_210" data-name="Group 210" transform="translate(-339.789 -1315.282)">
                        <path id="Path_218" d="M394.82 1315.282h-21.671a9.784 9.784 0 0 0 9.784 9.778h3.986v3.857a9.784 9.784 0 0 0 9.784 9.771v-21.523a1.884 1.884 0 0 0-1.883-1.883z" fill="#fff" data-name="Path 218" transform="translate(-11.914)"></path>
                        <path id="Path_219" d="M378.14 1332.072h-21.671a9.778 9.778 0 0 0 9.778 9.778h4.018v3.857a9.784 9.784 0 0 0 9.752 9.778v-21.536a1.877 1.877 0 0 0-1.877-1.877z" fill="#fff" data-name="Path 219" transform="translate(-5.957 -5.996)"></path>
                        <path id="Path_220" d="M361.46 1348.862h-21.671a9.778 9.778 0 0 0 9.778 9.778h3.992v3.857a9.778 9.778 0 0 0 9.778 9.778v-21.529a1.883 1.883 0 0 0-1.877-1.884z" fill="#fff" data-name="Path 220" transform="translate(0 -11.993)"></path>
                    </g>
                </svg>

            </a>

            <a class="footer-section__media-section--link" target="_blank" href="https://s.apache.org/airflow-slack">
                <svg xmlns="http://www.w3.org/2000/svg" width="45.073" height="45.073" viewBox="0 0 45.073 45.073">
                    <g id="Group_208" data-name="Group 208" transform="translate(-661.145 -806.287)">
                        <g id="Group_204" data-name="Group 204" transform="translate(661.145 830.01)">
                            <path id="Path_208" d="M670.634 856.859a4.744 4.744 0 1 1-4.744-4.744h4.744z" fill="#fff" data-name="Path 208" transform="translate(-661.145 -852.115)"></path>
                            <path id="Path_209" d="M684.059 856.859a4.744 4.744 0 0 1 9.489 0v11.861a4.744 4.744 0 1 1-9.489 0z" fill="#fff" data-name="Path 209" transform="translate(-672.198 -852.115)"></path>
                        </g>
                        <g id="Group_205" data-name="Group 205" transform="translate(661.145 806.287)">
                            <path id="Path_210" d="M688.8 815.776a4.744 4.744 0 1 1 4.744-4.745v4.745z" fill="#fff" data-name="Path 210" transform="translate(-672.198 -806.287)"></path>
                            <path id="Path_211" d="M677.751 829.2a4.744 4.744 0 0 1 0 9.489H665.89a4.744 4.744 0 1 1 0-9.489z" fill="#fff" data-name="Path 211" transform="translate(-661.145 -817.34)"></path>
                        </g>
                        <g id="Group_206" data-name="Group 206" transform="translate(684.868 806.287)">
                            <path id="Path_212" d="M729.887 833.945a4.744 4.744 0 1 1 4.745 4.745h-4.745z" fill="#fff" data-name="Path 212" transform="translate(-718.026 -817.34)"></path>
                            <path id="Path_213" d="M716.462 822.893a4.744 4.744 0 1 1-9.489 0v-11.862a4.744 4.744 0 0 1 9.489 0z" fill="#fff" data-name="Path 213" transform="translate(-706.973 -806.287)"></path>
                        </g>
                        <g id="Group_207" data-name="Group 207" transform="translate(684.868 830.01)">
                            <path id="Path_214" d="M711.718 875.029a4.744 4.744 0 1 1-4.745 4.744v-4.744z" fill="#fff" data-name="Path 214" transform="translate(-706.973 -863.168)"></path>
                            <path id="Path_215" d="M711.718 861.6a4.744 4.744 0 1 1 0-9.489h11.861a4.744 4.744 0 0 1 0 9.489z" fill="#fff" data-name="Path 215" transform="translate(-706.973 -852.115)"></path>
                        </g>
                    </g>
                </svg>

            </a>

            <a class="footer-section__media-section--link" target="_blank" href="https://stackoverflow.com/questions/tagged/airflow">
                <svg xmlns="http://www.w3.org/2000/svg" width="37.647" height="44.6" viewBox="0 0 37.647 44.6">
                    <g id="Group_209" data-name="Group 209" transform="translate(-645.2 -975.455)">
                        <path id="Path_216" d="M677.028 1043.1v-11.948h3.966v15.914H645.2v-15.914h3.966v11.948z" fill="#fff" data-name="Path 216" transform="translate(0 -27.014)"></path>
                        <path id="Path_217" d="M661.012 1003.008l19.467 4.069.824-3.914-19.467-4.069zm2.575-9.27l18.025 8.395 1.648-3.605-18.025-8.446zm5-8.858l15.3 12.721 2.524-3.039-15.3-12.721zm9.888-9.425l-3.193 2.369 11.845 15.965 3.193-2.369zm-17.875 36.617h19.879v-3.966H660.6z" fill="#fff" data-name="Path 217" transform="translate(-7.469)"></path>
                    </g>
                </svg>

            </a>

            <a class="footer-section__media-section--link" target="_blank" href="https://twitter.com/ApacheAirflow">
                <svg xmlns="http://www.w3.org/2000/svg" width="44.355" height="44.355" viewBox="0 0 44.355 44.355">
                    <g id="Group_211" data-name="Group 211" transform="translate(-503 -1382.2)">
                        <path id="Path_221" d="M541.811 1382.2h-33.267a5.546 5.546 0 0 0-5.544 5.544v33.266a5.547 5.547 0 0 0 5.544 5.545h33.267a5.546 5.546 0 0 0 5.544-5.545v-33.266a5.546 5.546 0 0 0-5.544-5.544zm-5.611 16.533c.011.244.011.488.011.732 0 7.507-5.722 16.178-16.179 16.178a16.173 16.173 0 0 1-8.7-2.539 10.92 10.92 0 0 0 1.353.078 11.4 11.4 0 0 0 7.064-2.44 5.685 5.685 0 0 1-5.311-3.947 5.725 5.725 0 0 0 2.561-.1 5.7 5.7 0 0 1-4.557-5.578v-.078a5.752 5.752 0 0 0 2.572.71 5.709 5.709 0 0 1-1.763-7.6 16.146 16.146 0 0 0 11.721 5.944 6.282 6.282 0 0 1-.144-1.3 5.688 5.688 0 0 1 9.836-3.892 11.3 11.3 0 0 0 3.615-1.375 5.721 5.721 0 0 1-2.506 3.149 11.538 11.538 0 0 0 3.271-.9 11.585 11.585 0 0 1-2.844 2.958z" fill="#fff" data-name="Path 221"></path>
                    </g>
                </svg>

            </a>

            <a class="footer-section__media-section--link" target="_blank" href="https://www.youtube.com/channel/UCSXwxpWZQ7XZ1WL3wqevChA">
                <svg xmlns="http://www.w3.org/2000/svg" width="49.594" height="34.941" viewBox="0 0 49.594 34.941">
                    <path id="Path_223" d="M1124.557 1230a6.232 6.232 0 0 0-4.385-4.413c-3.867-1.043-19.376-1.043-19.376-1.043s-15.508 0-19.376 1.043a6.232 6.232 0 0 0-4.385 4.413c-1.036 3.893-1.036 12.014-1.036 12.014s0 8.122 1.036 12.015a6.232 6.232 0 0 0 4.385 4.413c3.867 1.043 19.376 1.043 19.376 1.043s15.509 0 19.376-1.043a6.232 6.232 0 0 0 4.385-4.413c1.036-3.893 1.036-12.015 1.036-12.015s.001-8.123-1.036-12.014zm-28.833 19.388v-14.748l12.962 7.374z" fill="#fff" data-name="Path 223" transform="translate(-1076 -1224.542)"></path>
                </svg>

            </a>

        </div>
        

        <div class="footer-section__media-section--button-with-text">
            <span class="footer-section__media-section--text">Want to be a part of Apache Airflow?</span>
            <a href="/community">

                <button id="" class="btn-filled bodytext__medium--white ">Join community</button>

            </a>
        </div>
        

    </div>
    <div class="footer-section footer-section__policies-section">
        <div class="footer-section">
            <span>© The Apache Software Foundation <script>document.write(new Date().getFullYear())</script></span>
            <div class="footer-section__policies-section--policies">

                <a href="https://www.apache.org/licenses/" class="footer-section__policies-section--policy-item">
                    <span>License</span>
                </a>

                <a href="https://www.apache.org/foundation/sponsorship.html" class="footer-section__policies-section--policy-item">
                    <span>Donate</span>
                </a>

                <a href="https://www.apache.org/foundation/thanks.html" class="footer-section__policies-section--policy-item">
                    <span>Thanks</span>
                </a>

                <a href="https://www.apache.org/security/" class="footer-section__policies-section--policy-item">
                    <span>Security</span>
                </a>
                

            </div>
        </div>
        <span class="footer-section__policies-section--disclaimer">
            Apache Airflow, Apache, Airflow, the Airflow logo, and the Apache feather logo are either registered trademarks or trademarks of The Apache Software Foundation.
            All other products or name brands are trademarks of their respective holders, including The Apache Software Foundation.
        </span>
    </div>
</footer>
    <script type="text/javascript" src="../../../_static/_gen/js/docs.js"></script>
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script src="../../../_static/js/globaltoc.js"></script>
        <script src="../../../_static/gh-jira-links.js"></script>
</body>
</html>