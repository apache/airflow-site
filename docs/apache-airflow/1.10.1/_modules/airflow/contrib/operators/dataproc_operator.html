

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>airflow.contrib.operators.dataproc_operator &mdash; Airflow Documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>
<!-- Matomo -->
<script>
  var _paq = window._paq = window._paq || [];
  _paq.push(['disableCookies']);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="https://analytics.apache.org/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '13']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo -->
</head>


<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../index.html" class="icon icon-home"> Airflow
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../project.html">Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../howto/index.html">How-to Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ui.html">UI / Screenshots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../profiling.html">Data Profiling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cli.html">Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../scheduler.html">Scheduling &amp; Triggers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../timezone.html">Time zones</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api.html">Experimental Rest API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../integration.html">Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lineage.html">Lineage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../code.html">API Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Airflow</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>airflow.contrib.operators.dataproc_operator</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for airflow.contrib.operators.dataproc_operator</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#</span>
<span class="c1"># Licensed to the Apache Software Foundation (ASF) under one</span>
<span class="c1"># or more contributor license agreements.  See the NOTICE file</span>
<span class="c1"># distributed with this work for additional information</span>
<span class="c1"># regarding copyright ownership.  The ASF licenses this file</span>
<span class="c1"># to you under the Apache License, Version 2.0 (the</span>
<span class="c1"># &quot;License&quot;); you may not use this file except in compliance</span>
<span class="c1"># with the License.  You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#   http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing,</span>
<span class="c1"># software distributed under the License is distributed on an</span>
<span class="c1"># &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span>
<span class="c1"># KIND, either express or implied.  See the License for the</span>
<span class="c1"># specific language governing permissions and limitations</span>
<span class="c1"># under the License.</span>
<span class="c1">#</span>

<span class="kn">import</span> <span class="nn">ntpath</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">timedelta</span>

<span class="kn">from</span> <span class="nn">airflow.contrib.hooks.gcp_dataproc_hook</span> <span class="k">import</span> <span class="n">DataProcHook</span>
<span class="kn">from</span> <span class="nn">airflow.contrib.hooks.gcs_hook</span> <span class="k">import</span> <span class="n">GoogleCloudStorageHook</span>
<span class="kn">from</span> <span class="nn">airflow.exceptions</span> <span class="k">import</span> <span class="n">AirflowException</span>
<span class="kn">from</span> <span class="nn">airflow.models</span> <span class="k">import</span> <span class="n">BaseOperator</span>
<span class="kn">from</span> <span class="nn">airflow.utils.decorators</span> <span class="k">import</span> <span class="n">apply_defaults</span>
<span class="kn">from</span> <span class="nn">airflow.version</span> <span class="k">import</span> <span class="n">version</span>
<span class="kn">from</span> <span class="nn">googleapiclient.errors</span> <span class="k">import</span> <span class="n">HttpError</span>
<span class="kn">from</span> <span class="nn">airflow.utils</span> <span class="k">import</span> <span class="n">timezone</span>


<div class="viewcode-block" id="DataprocClusterCreateOperator"><a class="viewcode-back" href="../../../../integration.html#airflow.contrib.operators.dataproc_operator.DataprocClusterCreateOperator">[docs]</a><span class="k">class</span> <span class="nc">DataprocClusterCreateOperator</span><span class="p">(</span><span class="n">BaseOperator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a new cluster on Google Cloud Dataproc. The operator will wait until the</span>
<span class="sd">    creation is successful or an error occurs in the creation process.</span>

<span class="sd">    The parameters allow to configure the cluster. Please refer to</span>

<span class="sd">    https://cloud.google.com/dataproc/docs/reference/rest/v1/projects.regions.clusters</span>

<span class="sd">    for a detailed explanation on the different parameters. Most of the configuration</span>
<span class="sd">    parameters detailed in the link are available as a parameter to this operator.</span>

<span class="sd">    :param cluster_name: The name of the DataProc cluster to create. (templated)</span>
<span class="sd">    :type cluster_name: string</span>
<span class="sd">    :param project_id: The ID of the google cloud project in which</span>
<span class="sd">        to create the cluster. (templated)</span>
<span class="sd">    :type project_id: str</span>
<span class="sd">    :param num_workers: The # of workers to spin up. If set to zero will</span>
<span class="sd">        spin up cluster in a single node mode</span>
<span class="sd">    :type num_workers: int</span>
<span class="sd">    :param storage_bucket: The storage bucket to use, setting to None lets dataproc</span>
<span class="sd">        generate a custom one for you</span>
<span class="sd">    :type storage_bucket: string</span>
<span class="sd">    :param init_actions_uris: List of GCS uri&#39;s containing</span>
<span class="sd">        dataproc initialization scripts</span>
<span class="sd">    :type init_actions_uris: list[string]</span>
<span class="sd">    :param init_action_timeout: Amount of time executable scripts in</span>
<span class="sd">        init_actions_uris has to complete</span>
<span class="sd">    :type init_action_timeout: string</span>
<span class="sd">    :param metadata: dict of key-value google compute engine metadata entries</span>
<span class="sd">        to add to all instances</span>
<span class="sd">    :type metadata: dict</span>
<span class="sd">    :param image_version: the version of software inside the Dataproc cluster</span>
<span class="sd">    :type image_version: string</span>
<span class="sd">    :param custom_image: custom Dataproc image for more info see</span>
<span class="sd">        https://cloud.google.com/dataproc/docs/guides/dataproc-images</span>
<span class="sd">    :type: custom_image: string</span>
<span class="sd">    :param properties: dict of properties to set on</span>
<span class="sd">        config files (e.g. spark-defaults.conf), see</span>
<span class="sd">        https://cloud.google.com/dataproc/docs/reference/rest/v1/ \</span>
<span class="sd">        projects.regions.clusters#SoftwareConfig</span>
<span class="sd">    :type properties: dict</span>
<span class="sd">    :param master_machine_type: Compute engine machine type to use for the master node</span>
<span class="sd">    :type master_machine_type: string</span>
<span class="sd">    :param master_disk_type: Type of the boot disk for the master node</span>
<span class="sd">        (default is ``pd-standard``).</span>
<span class="sd">        Valid values: ``pd-ssd`` (Persistent Disk Solid State Drive) or</span>
<span class="sd">        ``pd-standard`` (Persistent Disk Hard Disk Drive).</span>
<span class="sd">    :type master_disk_type: string</span>
<span class="sd">    :param master_disk_size: Disk size for the master node</span>
<span class="sd">    :type master_disk_size: int</span>
<span class="sd">    :param worker_machine_type: Compute engine machine type to use for the worker nodes</span>
<span class="sd">    :type worker_machine_type: string</span>
<span class="sd">    :param worker_disk_type: Type of the boot disk for the worker node</span>
<span class="sd">        (default is ``pd-standard``).</span>
<span class="sd">        Valid values: ``pd-ssd`` (Persistent Disk Solid State Drive) or</span>
<span class="sd">        ``pd-standard`` (Persistent Disk Hard Disk Drive).</span>
<span class="sd">    :type worker_disk_type: string</span>
<span class="sd">    :param worker_disk_size: Disk size for the worker nodes</span>
<span class="sd">    :type worker_disk_size: int</span>
<span class="sd">    :param num_preemptible_workers: The # of preemptible worker nodes to spin up</span>
<span class="sd">    :type num_preemptible_workers: int</span>
<span class="sd">    :param labels: dict of labels to add to the cluster</span>
<span class="sd">    :type labels: dict</span>
<span class="sd">    :param zone: The zone where the cluster will be located. (templated)</span>
<span class="sd">    :type zone: string</span>
<span class="sd">    :param network_uri: The network uri to be used for machine communication, cannot be</span>
<span class="sd">        specified with subnetwork_uri</span>
<span class="sd">    :type network_uri: string</span>
<span class="sd">    :param subnetwork_uri: The subnetwork uri to be used for machine communication,</span>
<span class="sd">        cannot be specified with network_uri</span>
<span class="sd">    :type subnetwork_uri: string</span>
<span class="sd">    :param internal_ip_only: If true, all instances in the cluster will only</span>
<span class="sd">        have internal IP addresses. This can only be enabled for subnetwork</span>
<span class="sd">        enabled networks</span>
<span class="sd">    :type internal_ip_only: bool</span>
<span class="sd">    :param tags: The GCE tags to add to all instances</span>
<span class="sd">    :type tags: list[string]</span>
<span class="sd">    :param region: leave as &#39;global&#39;, might become relevant in the future. (templated)</span>
<span class="sd">    :param gcp_conn_id: The connection ID to use connecting to Google Cloud Platform.</span>
<span class="sd">    :type gcp_conn_id: string</span>
<span class="sd">    :param delegate_to: The account to impersonate, if any.</span>
<span class="sd">        For this to work, the service account making the request must have domain-wide</span>
<span class="sd">        delegation enabled.</span>
<span class="sd">    :type delegate_to: string</span>
<span class="sd">    :param service_account: The service account of the dataproc instances.</span>
<span class="sd">    :type service_account: string</span>
<span class="sd">    :param service_account_scopes: The URIs of service account scopes to be included.</span>
<span class="sd">    :type service_account_scopes: list[string]</span>
<span class="sd">    :param idle_delete_ttl: The longest duration that cluster would keep alive while</span>
<span class="sd">        staying idle. Passing this threshold will cause cluster to be auto-deleted.</span>
<span class="sd">        A duration in seconds.</span>
<span class="sd">    :type idle_delete_ttl: int</span>
<span class="sd">    :param auto_delete_time:  The time when cluster will be auto-deleted.</span>
<span class="sd">    :type auto_delete_time: datetime.datetime</span>
<span class="sd">    :param auto_delete_ttl: The life duration of cluster, the cluster will be</span>
<span class="sd">        auto-deleted at the end of this duration.</span>
<span class="sd">        A duration in seconds. (If auto_delete_time is set this parameter will be ignored)</span>
<span class="sd">    :type auto_delete_ttl: int</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cluster_name&#39;</span><span class="p">,</span> <span class="s1">&#39;project_id&#39;</span><span class="p">,</span> <span class="s1">&#39;zone&#39;</span><span class="p">,</span> <span class="s1">&#39;region&#39;</span><span class="p">]</span>

    <span class="nd">@apply_defaults</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">cluster_name</span><span class="p">,</span>
                 <span class="n">project_id</span><span class="p">,</span>
                 <span class="n">num_workers</span><span class="p">,</span>
                 <span class="n">zone</span><span class="p">,</span>
                 <span class="n">network_uri</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">subnetwork_uri</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">internal_ip_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">storage_bucket</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">init_actions_uris</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">init_action_timeout</span><span class="o">=</span><span class="s2">&quot;10m&quot;</span><span class="p">,</span>
                 <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">custom_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">image_version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">master_machine_type</span><span class="o">=</span><span class="s1">&#39;n1-standard-4&#39;</span><span class="p">,</span>
                 <span class="n">master_disk_type</span><span class="o">=</span><span class="s1">&#39;pd-standard&#39;</span><span class="p">,</span>
                 <span class="n">master_disk_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                 <span class="n">worker_machine_type</span><span class="o">=</span><span class="s1">&#39;n1-standard-4&#39;</span><span class="p">,</span>
                 <span class="n">worker_disk_type</span><span class="o">=</span><span class="s1">&#39;pd-standard&#39;</span><span class="p">,</span>
                 <span class="n">worker_disk_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                 <span class="n">num_preemptible_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">region</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span>
                 <span class="n">gcp_conn_id</span><span class="o">=</span><span class="s1">&#39;google_cloud_default&#39;</span><span class="p">,</span>
                 <span class="n">delegate_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">service_account</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">service_account_scopes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">idle_delete_ttl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">auto_delete_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">auto_delete_ttl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">DataprocClusterCreateOperator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gcp_conn_id</span> <span class="o">=</span> <span class="n">gcp_conn_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delegate_to</span> <span class="o">=</span> <span class="n">delegate_to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span> <span class="o">=</span> <span class="n">cluster_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="n">project_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="o">=</span> <span class="n">num_workers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_preemptible_workers</span> <span class="o">=</span> <span class="n">num_preemptible_workers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_bucket</span> <span class="o">=</span> <span class="n">storage_bucket</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_actions_uris</span> <span class="o">=</span> <span class="n">init_actions_uris</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_action_timeout</span> <span class="o">=</span> <span class="n">init_action_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_image</span> <span class="o">=</span> <span class="n">custom_image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_version</span> <span class="o">=</span> <span class="n">image_version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">properties</span> <span class="ow">or</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_machine_type</span> <span class="o">=</span> <span class="n">master_machine_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_disk_type</span> <span class="o">=</span> <span class="n">master_disk_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_disk_size</span> <span class="o">=</span> <span class="n">master_disk_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_machine_type</span> <span class="o">=</span> <span class="n">worker_machine_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_disk_type</span> <span class="o">=</span> <span class="n">worker_disk_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_disk_size</span> <span class="o">=</span> <span class="n">worker_disk_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zone</span> <span class="o">=</span> <span class="n">zone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_uri</span> <span class="o">=</span> <span class="n">network_uri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subnetwork_uri</span> <span class="o">=</span> <span class="n">subnetwork_uri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">internal_ip_only</span> <span class="o">=</span> <span class="n">internal_ip_only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_account</span> <span class="o">=</span> <span class="n">service_account</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_account_scopes</span> <span class="o">=</span> <span class="n">service_account_scopes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idle_delete_ttl</span> <span class="o">=</span> <span class="n">idle_delete_ttl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_delete_time</span> <span class="o">=</span> <span class="n">auto_delete_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_delete_ttl</span> <span class="o">=</span> <span class="n">auto_delete_ttl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">single_node</span> <span class="o">=</span> <span class="n">num_workers</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_image</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_version</span><span class="p">),</span> \
            <span class="s2">&quot;custom_image and image_version can&#39;t be both set&quot;</span>

        <span class="k">assert</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_node</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">single_node</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_preemptible_workers</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="p">)</span>
        <span class="p">),</span> <span class="s2">&quot;num_workers == 0 means single node mode - no preemptibles allowed&quot;</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_image</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_version</span><span class="p">),</span> \
            <span class="s2">&quot;custom_image and image_version can&#39;t be both set&quot;</span>

    <span class="k">def</span> <span class="nf">_get_cluster_list_for_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">projects</span><span class="p">()</span><span class="o">.</span><span class="n">regions</span><span class="p">()</span><span class="o">.</span><span class="n">clusters</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
            <span class="n">projectId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span>
            <span class="n">region</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span>
        <span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;clusters&#39;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">_get_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service</span><span class="p">):</span>
        <span class="n">cluster_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster_list_for_project</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
        <span class="n">cluster</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cluster_list</span> <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;clusterName&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cluster</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cluster</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_cluster_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service</span><span class="p">):</span>
        <span class="n">cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;status&#39;</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cluster</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">][</span><span class="s1">&#39;state&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_cluster_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">service</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;RUNNING&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;ERROR&#39;</span><span class="p">:</span>
            <span class="n">cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">error_details</span> <span class="o">=</span> <span class="n">cluster</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">][</span><span class="s1">&#39;details&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">error_details</span> <span class="o">=</span> <span class="s1">&#39;Unknown error in cluster creation, &#39;</span> \
                                <span class="s1">&#39;check Google Cloud console for details.&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_details</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_wait_for_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster_state</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No state for cluster &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;State for cluster &#39;</span><span class="si">%s</span><span class="s2">&#39; is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_ready</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">service</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Cluster &#39;</span><span class="si">%s</span><span class="s2">&#39; successfully created&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span>
                    <span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_init_action_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(\d+)(s|m)$&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_action_timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_action_timeout</span>
            <span class="k">elif</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;m&quot;</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="p">)</span>

        <span class="k">raise</span> <span class="n">AirflowException</span><span class="p">(</span>
            <span class="s2">&quot;DataprocClusterCreateOperator init_action_timeout&quot;</span>
            <span class="s2">&quot; should be expressed in minutes or seconds. i.e. 10m, 30s&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_cluster_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">zone_uri</span> <span class="o">=</span> \
            <span class="s1">&#39;https://www.googleapis.com/compute/v1/projects/</span><span class="si">{}</span><span class="s1">/zones/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zone</span>
            <span class="p">)</span>
        <span class="n">master_type_uri</span> <span class="o">=</span> \
            <span class="s2">&quot;https://www.googleapis.com/compute/v1/projects/</span><span class="si">{}</span><span class="s2">/zones/</span><span class="si">{}</span><span class="s2">/machineTypes/</span><span class="si">{}</span><span class="s2">&quot;</span>\
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zone</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_machine_type</span><span class="p">)</span>
        <span class="n">worker_type_uri</span> <span class="o">=</span> \
            <span class="s2">&quot;https://www.googleapis.com/compute/v1/projects/</span><span class="si">{}</span><span class="s2">/zones/</span><span class="si">{}</span><span class="s2">/machineTypes/</span><span class="si">{}</span><span class="s2">&quot;</span>\
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zone</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_machine_type</span><span class="p">)</span>

        <span class="n">cluster_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;projectId&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span>
            <span class="s1">&#39;clusterName&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">,</span>
            <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;gceClusterConfig&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;zoneUri&#39;</span><span class="p">:</span> <span class="n">zone_uri</span>
                <span class="p">},</span>
                <span class="s1">&#39;masterConfig&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;numInstances&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;machineTypeUri&#39;</span><span class="p">:</span> <span class="n">master_type_uri</span><span class="p">,</span>
                    <span class="s1">&#39;diskConfig&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;bootDiskType&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_disk_type</span><span class="p">,</span>
                        <span class="s1">&#39;bootDiskSizeGb&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_disk_size</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="s1">&#39;workerConfig&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;numInstances&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
                    <span class="s1">&#39;machineTypeUri&#39;</span><span class="p">:</span> <span class="n">worker_type_uri</span><span class="p">,</span>
                    <span class="s1">&#39;diskConfig&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;bootDiskType&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_disk_type</span><span class="p">,</span>
                        <span class="s1">&#39;bootDiskSizeGb&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_disk_size</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="s1">&#39;secondaryWorkerConfig&#39;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s1">&#39;softwareConfig&#39;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s1">&#39;lifecycleConfig&#39;</span><span class="p">:</span> <span class="p">{}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_preemptible_workers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cluster_data</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;secondaryWorkerConfig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;numInstances&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_preemptible_workers</span><span class="p">,</span>
                <span class="s1">&#39;machineTypeUri&#39;</span><span class="p">:</span> <span class="n">worker_type_uri</span><span class="p">,</span>
                <span class="s1">&#39;diskConfig&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;bootDiskType&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_disk_type</span><span class="p">,</span>
                    <span class="s1">&#39;bootDiskSizeGb&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_disk_size</span>
                <span class="p">},</span>
                <span class="s1">&#39;isPreemptible&#39;</span><span class="p">:</span> <span class="kc">True</span>
            <span class="p">}</span>

        <span class="n">cluster_data</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="c1"># Dataproc labels must conform to the following regex:</span>
        <span class="c1"># [a-z]([-a-z0-9]*[a-z0-9])? (current airflow version string follows</span>
        <span class="c1"># semantic versioning spec: x.y.z).</span>
        <span class="n">cluster_data</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;airflow-version&#39;</span><span class="p">:</span>
                                       <span class="s1">&#39;v&#39;</span> <span class="o">+</span> <span class="n">version</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_bucket</span><span class="p">:</span>
            <span class="n">cluster_data</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;configBucket&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_bucket</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
            <span class="n">cluster_data</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;gceClusterConfig&#39;</span><span class="p">][</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_uri</span><span class="p">:</span>
            <span class="n">cluster_data</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;gceClusterConfig&#39;</span><span class="p">][</span><span class="s1">&#39;networkUri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_uri</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subnetwork_uri</span><span class="p">:</span>
            <span class="n">cluster_data</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;gceClusterConfig&#39;</span><span class="p">][</span><span class="s1">&#39;subnetworkUri&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">subnetwork_uri</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_ip_only</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">subnetwork_uri</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AirflowException</span><span class="p">(</span><span class="s2">&quot;Set internal_ip_only to true only when&quot;</span>
                                       <span class="s2">&quot; you pass a subnetwork_uri.&quot;</span><span class="p">)</span>
            <span class="n">cluster_data</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;gceClusterConfig&#39;</span><span class="p">][</span><span class="s1">&#39;internalIpOnly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="n">cluster_data</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;gceClusterConfig&#39;</span><span class="p">][</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_version</span><span class="p">:</span>
            <span class="n">cluster_data</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;softwareConfig&#39;</span><span class="p">][</span><span class="s1">&#39;imageVersion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_version</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_image</span><span class="p">:</span>
            <span class="n">custom_image_url</span> <span class="o">=</span> <span class="s1">&#39;https://www.googleapis.com/compute/beta/projects/&#39;</span> \
                               <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/global/images/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">custom_image</span><span class="p">)</span>
            <span class="n">cluster_data</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;masterConfig&#39;</span><span class="p">][</span><span class="s1">&#39;imageUri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">custom_image_url</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_node</span><span class="p">:</span>
                <span class="n">cluster_data</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;workerConfig&#39;</span><span class="p">][</span><span class="s1">&#39;imageUri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">custom_image_url</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_node</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;dataproc:dataproc.allow.zero.workers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="n">cluster_data</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;softwareConfig&#39;</span><span class="p">][</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">idle_delete_ttl</span><span class="p">:</span>
            <span class="n">cluster_data</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;lifecycleConfig&#39;</span><span class="p">][</span><span class="s1">&#39;idleDeleteTtl&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idle_delete_ttl</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_delete_time</span><span class="p">:</span>
            <span class="n">utc_auto_delete_time</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">convert_to_utc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_delete_time</span><span class="p">)</span>
            <span class="n">cluster_data</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;lifecycleConfig&#39;</span><span class="p">][</span><span class="s1">&#39;autoDeleteTime&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">utc_auto_delete_time</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.</span><span class="si">%f</span><span class="s1">Z&#39;</span><span class="p">,</span> <span class="n">formatter</span><span class="o">=</span><span class="s1">&#39;classic&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_delete_ttl</span><span class="p">:</span>
            <span class="n">cluster_data</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;lifecycleConfig&#39;</span><span class="p">][</span><span class="s1">&#39;autoDeleteTtl&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_delete_ttl</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_actions_uris</span><span class="p">:</span>
            <span class="n">init_actions_dict</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;executableFile&#39;</span><span class="p">:</span> <span class="n">uri</span><span class="p">,</span>
                    <span class="s1">&#39;executionTimeout&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_init_action_timeout</span><span class="p">()</span>
                <span class="p">}</span> <span class="k">for</span> <span class="n">uri</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_actions_uris</span>
            <span class="p">]</span>
            <span class="n">cluster_data</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;initializationActions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">init_actions_dict</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_account</span><span class="p">:</span>
            <span class="n">cluster_data</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;gceClusterConfig&#39;</span><span class="p">][</span><span class="s1">&#39;serviceAccount&#39;</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">service_account</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_account_scopes</span><span class="p">:</span>
            <span class="n">cluster_data</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;gceClusterConfig&#39;</span><span class="p">][</span><span class="s1">&#39;serviceAccountScopes&#39;</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">service_account_scopes</span>
        <span class="k">return</span> <span class="n">cluster_data</span>

<div class="viewcode-block" id="DataprocClusterCreateOperator.execute"><a class="viewcode-back" href="../../../../integration.html#airflow.contrib.operators.dataproc_operator.DataprocClusterCreateOperator.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating cluster: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">)</span>
        <span class="n">hook</span> <span class="o">=</span> <span class="n">DataProcHook</span><span class="p">(</span>
            <span class="n">gcp_conn_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gcp_conn_id</span><span class="p">,</span>
            <span class="n">delegate_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delegate_to</span>
        <span class="p">)</span>
        <span class="n">service</span> <span class="o">=</span> <span class="n">hook</span><span class="o">.</span><span class="n">get_conn</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster</span><span class="p">(</span><span class="n">service</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Cluster </span><span class="si">%s</span><span class="s1"> already exists... Checking status...&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_done</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">cluster_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_cluster_data</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">service</span><span class="o">.</span><span class="n">projects</span><span class="p">()</span><span class="o">.</span><span class="n">regions</span><span class="p">()</span><span class="o">.</span><span class="n">clusters</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">projectId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span>
                <span class="n">region</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span>
                <span class="n">body</span><span class="o">=</span><span class="n">cluster_data</span>
            <span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># probably two cluster start commands at the same time</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster</span><span class="p">(</span><span class="n">service</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Cluster </span><span class="si">{}</span><span class="s1"> already exists... Checking status...&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_done</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_done</span><span class="p">(</span><span class="n">service</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DataprocClusterScaleOperator"><a class="viewcode-back" href="../../../../integration.html#airflow.contrib.operators.dataproc_operator.DataprocClusterScaleOperator">[docs]</a><span class="k">class</span> <span class="nc">DataprocClusterScaleOperator</span><span class="p">(</span><span class="n">BaseOperator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scale, up or down, a cluster on Google Cloud Dataproc.</span>
<span class="sd">    The operator will wait until the cluster is re-scaled.</span>

<span class="sd">    **Example**: ::</span>

<span class="sd">        t1 = DataprocClusterScaleOperator(</span>
<span class="sd">                task_id=&#39;dataproc_scale&#39;,</span>
<span class="sd">                project_id=&#39;my-project&#39;,</span>
<span class="sd">                cluster_name=&#39;cluster-1&#39;,</span>
<span class="sd">                num_workers=10,</span>
<span class="sd">                num_preemptible_workers=10,</span>
<span class="sd">                graceful_decommission_timeout=&#39;1h&#39;,</span>
<span class="sd">                dag=dag)</span>

<span class="sd">    .. seealso::</span>
<span class="sd">        For more detail on about scaling clusters have a look at the reference:</span>
<span class="sd">        https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/scaling-clusters</span>

<span class="sd">    :param cluster_name: The name of the cluster to scale. (templated)</span>
<span class="sd">    :type cluster_name: string</span>
<span class="sd">    :param project_id: The ID of the google cloud project in which</span>
<span class="sd">        the cluster runs. (templated)</span>
<span class="sd">    :type project_id: string</span>
<span class="sd">    :param region: The region for the dataproc cluster. (templated)</span>
<span class="sd">    :type region: string</span>
<span class="sd">    :param gcp_conn_id: The connection ID to use connecting to Google Cloud Platform.</span>
<span class="sd">    :type gcp_conn_id: string</span>
<span class="sd">    :param num_workers: The new number of workers</span>
<span class="sd">    :type num_workers: int</span>
<span class="sd">    :param num_preemptible_workers: The new number of preemptible workers</span>
<span class="sd">    :type num_preemptible_workers: int</span>
<span class="sd">    :param graceful_decommission_timeout: Timeout for graceful YARN decomissioning.</span>
<span class="sd">        Maximum value is 1d</span>
<span class="sd">    :type graceful_decommission_timeout: string</span>
<span class="sd">    :param delegate_to: The account to impersonate, if any.</span>
<span class="sd">        For this to work, the service account making the request must have domain-wide</span>
<span class="sd">        delegation enabled.</span>
<span class="sd">    :type delegate_to: string</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cluster_name&#39;</span><span class="p">,</span> <span class="s1">&#39;project_id&#39;</span><span class="p">,</span> <span class="s1">&#39;region&#39;</span><span class="p">]</span>

    <span class="nd">@apply_defaults</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">cluster_name</span><span class="p">,</span>
                 <span class="n">project_id</span><span class="p">,</span>
                 <span class="n">region</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span>
                 <span class="n">gcp_conn_id</span><span class="o">=</span><span class="s1">&#39;google_cloud_default&#39;</span><span class="p">,</span>
                 <span class="n">delegate_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                 <span class="n">num_preemptible_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">graceful_decommission_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DataprocClusterScaleOperator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gcp_conn_id</span> <span class="o">=</span> <span class="n">gcp_conn_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delegate_to</span> <span class="o">=</span> <span class="n">delegate_to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span> <span class="o">=</span> <span class="n">cluster_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="n">project_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="o">=</span> <span class="n">num_workers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_preemptible_workers</span> <span class="o">=</span> <span class="n">num_preemptible_workers</span>

        <span class="c1"># Optional</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optional_arguments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">graceful_decommission_timeout</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optional_arguments</span><span class="p">[</span><span class="s1">&#39;gracefulDecommissionTimeout&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_graceful_decommission_timeout</span><span class="p">(</span>
                    <span class="n">graceful_decommission_timeout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_wait_for_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">operation_name</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">projects</span><span class="p">()</span><span class="o">.</span><span class="n">regions</span><span class="p">()</span><span class="o">.</span><span class="n">operations</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">operation_name</span>
                <span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

                <span class="k">if</span> <span class="s1">&#39;done&#39;</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;done&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Operation not found.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">e</span>

    <span class="k">def</span> <span class="nf">_build_scale_cluster_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">scale_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;workerConfig&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;numInstances&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span>
                <span class="p">},</span>
                <span class="s1">&#39;secondaryWorkerConfig&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;numInstances&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_preemptible_workers</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">scale_data</span>

    <span class="k">def</span> <span class="nf">_get_graceful_decommission_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(\d+)(s|m|h|d)$&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">timeout</span>
            <span class="k">elif</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;m&quot;</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;h&quot;</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="p">)</span>

        <span class="k">raise</span> <span class="n">AirflowException</span><span class="p">(</span>
            <span class="s2">&quot;DataprocClusterScaleOperator &quot;</span>
            <span class="s2">&quot; should be expressed in day, hours, minutes or seconds. &quot;</span>
            <span class="s2">&quot; i.e. 1d, 4h, 10m, 30s&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="DataprocClusterScaleOperator.execute"><a class="viewcode-back" href="../../../../integration.html#airflow.contrib.operators.dataproc_operator.DataprocClusterScaleOperator.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Scaling cluster: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">)</span>
        <span class="n">hook</span> <span class="o">=</span> <span class="n">DataProcHook</span><span class="p">(</span>
            <span class="n">gcp_conn_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gcp_conn_id</span><span class="p">,</span>
            <span class="n">delegate_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delegate_to</span>
        <span class="p">)</span>
        <span class="n">service</span> <span class="o">=</span> <span class="n">hook</span><span class="o">.</span><span class="n">get_conn</span><span class="p">()</span>

        <span class="n">update_mask</span> <span class="o">=</span> <span class="s2">&quot;config.worker_config.num_instances,&quot;</span> \
                      <span class="o">+</span> <span class="s2">&quot;config.secondary_worker_config.num_instances&quot;</span>
        <span class="n">scaling_cluster_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_scale_cluster_data</span><span class="p">()</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">projects</span><span class="p">()</span><span class="o">.</span><span class="n">regions</span><span class="p">()</span><span class="o">.</span><span class="n">clusters</span><span class="p">()</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span>
            <span class="n">projectId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span>
            <span class="n">region</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span>
            <span class="n">clusterName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">,</span>
            <span class="n">updateMask</span><span class="o">=</span><span class="n">update_mask</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="n">scaling_cluster_data</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">optional_arguments</span>
        <span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="n">operation_name</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cluster scale operation name: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">operation_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_done</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">operation_name</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DataprocClusterDeleteOperator"><a class="viewcode-back" href="../../../../integration.html#airflow.contrib.operators.dataproc_operator.DataprocClusterDeleteOperator">[docs]</a><span class="k">class</span> <span class="nc">DataprocClusterDeleteOperator</span><span class="p">(</span><span class="n">BaseOperator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete a cluster on Google Cloud Dataproc. The operator will wait until the</span>
<span class="sd">    cluster is destroyed.</span>

<span class="sd">    :param cluster_name: The name of the cluster to create. (templated)</span>
<span class="sd">    :type cluster_name: string</span>
<span class="sd">    :param project_id: The ID of the google cloud project in which</span>
<span class="sd">        the cluster runs. (templated)</span>
<span class="sd">    :type project_id: string</span>
<span class="sd">    :param region: leave as &#39;global&#39;, might become relevant in the future. (templated)</span>
<span class="sd">    :type region: string</span>
<span class="sd">    :param gcp_conn_id: The connection ID to use connecting to Google Cloud Platform.</span>
<span class="sd">    :type gcp_conn_id: string</span>
<span class="sd">    :param delegate_to: The account to impersonate, if any.</span>
<span class="sd">        For this to work, the service account making the request must have domain-wide</span>
<span class="sd">        delegation enabled.</span>
<span class="sd">    :type delegate_to: string</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cluster_name&#39;</span><span class="p">,</span> <span class="s1">&#39;project_id&#39;</span><span class="p">,</span> <span class="s1">&#39;region&#39;</span><span class="p">]</span>

    <span class="nd">@apply_defaults</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">cluster_name</span><span class="p">,</span>
                 <span class="n">project_id</span><span class="p">,</span>
                 <span class="n">region</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span>
                 <span class="n">gcp_conn_id</span><span class="o">=</span><span class="s1">&#39;google_cloud_default&#39;</span><span class="p">,</span>
                 <span class="n">delegate_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">DataprocClusterDeleteOperator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gcp_conn_id</span> <span class="o">=</span> <span class="n">gcp_conn_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delegate_to</span> <span class="o">=</span> <span class="n">delegate_to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span> <span class="o">=</span> <span class="n">cluster_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="n">project_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region</span>

    <span class="k">def</span> <span class="nf">_wait_for_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">operation_name</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">projects</span><span class="p">()</span><span class="o">.</span><span class="n">regions</span><span class="p">()</span><span class="o">.</span><span class="n">operations</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">operation_name</span>
            <span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

            <span class="k">if</span> <span class="s1">&#39;done&#39;</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;done&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>

<div class="viewcode-block" id="DataprocClusterDeleteOperator.execute"><a class="viewcode-back" href="../../../../integration.html#airflow.contrib.operators.dataproc_operator.DataprocClusterDeleteOperator.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting cluster: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">)</span>
        <span class="n">hook</span> <span class="o">=</span> <span class="n">DataProcHook</span><span class="p">(</span>
            <span class="n">gcp_conn_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gcp_conn_id</span><span class="p">,</span>
            <span class="n">delegate_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delegate_to</span>
        <span class="p">)</span>
        <span class="n">service</span> <span class="o">=</span> <span class="n">hook</span><span class="o">.</span><span class="n">get_conn</span><span class="p">()</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">projects</span><span class="p">()</span><span class="o">.</span><span class="n">regions</span><span class="p">()</span><span class="o">.</span><span class="n">clusters</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
            <span class="n">projectId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span>
            <span class="n">region</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span>
            <span class="n">clusterName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span>
        <span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="n">operation_name</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cluster delete operation name: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">operation_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_done</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">operation_name</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DataProcPigOperator"><a class="viewcode-back" href="../../../../integration.html#airflow.contrib.operators.dataproc_operator.DataProcPigOperator">[docs]</a><span class="k">class</span> <span class="nc">DataProcPigOperator</span><span class="p">(</span><span class="n">BaseOperator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start a Pig query Job on a Cloud DataProc cluster. The parameters of the operation</span>
<span class="sd">    will be passed to the cluster.</span>

<span class="sd">    It&#39;s a good practice to define dataproc_* parameters in the default_args of the dag</span>
<span class="sd">    like the cluster name and UDFs.</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        default_args = {</span>
<span class="sd">            &#39;cluster_name&#39;: &#39;cluster-1&#39;,</span>
<span class="sd">            &#39;dataproc_pig_jars&#39;: [</span>
<span class="sd">                &#39;gs://example/udf/jar/datafu/1.2.0/datafu.jar&#39;,</span>
<span class="sd">                &#39;gs://example/udf/jar/gpig/1.2/gpig.jar&#39;</span>
<span class="sd">            ]</span>
<span class="sd">        }</span>

<span class="sd">    You can pass a pig script as string or file reference. Use variables to pass on</span>
<span class="sd">    variables for the pig script to be resolved on the cluster or use the parameters to</span>
<span class="sd">    be resolved in the script as template parameters.</span>

<span class="sd">    **Example**: ::</span>

<span class="sd">        t1 = DataProcPigOperator(</span>
<span class="sd">                task_id=&#39;dataproc_pig&#39;,</span>
<span class="sd">                query=&#39;a_pig_script.pig&#39;,</span>
<span class="sd">                variables={&#39;out&#39;: &#39;gs://example/output/{{ds}}&#39;},</span>
<span class="sd">                dag=dag)</span>

<span class="sd">    .. seealso::</span>
<span class="sd">        For more detail on about job submission have a look at the reference:</span>
<span class="sd">        https://cloud.google.com/dataproc/reference/rest/v1/projects.regions.jobs</span>

<span class="sd">    :param query: The query or reference to the query</span>
<span class="sd">        file (pg or pig extension). (templated)</span>
<span class="sd">    :type query: string</span>
<span class="sd">    :param query_uri: The uri of a pig script on Cloud Storage.</span>
<span class="sd">    :type query_uri: string</span>
<span class="sd">    :param variables: Map of named parameters for the query. (templated)</span>
<span class="sd">    :type variables: dict</span>
<span class="sd">    :param job_name: The job name used in the DataProc cluster. This</span>
<span class="sd">        name by default is the task_id appended with the execution data, but can</span>
<span class="sd">        be templated. The name will always be appended with a random number to</span>
<span class="sd">        avoid name clashes. (templated)</span>
<span class="sd">    :type job_name: string</span>
<span class="sd">    :param cluster_name: The name of the DataProc cluster. (templated)</span>
<span class="sd">    :type cluster_name: string</span>
<span class="sd">    :param dataproc_pig_properties: Map for the Pig properties. Ideal to put in</span>
<span class="sd">        default arguments</span>
<span class="sd">    :type dataproc_pig_properties: dict</span>
<span class="sd">    :param dataproc_pig_jars: URIs to jars provisioned in Cloud Storage (example: for</span>
<span class="sd">        UDFs and libs) and are ideal to put in default arguments.</span>
<span class="sd">    :type dataproc_pig_jars: list</span>
<span class="sd">    :param gcp_conn_id: The connection ID to use connecting to Google Cloud Platform.</span>
<span class="sd">    :type gcp_conn_id: string</span>
<span class="sd">    :param delegate_to: The account to impersonate, if any.</span>
<span class="sd">        For this to work, the service account making the request must have domain-wide</span>
<span class="sd">        delegation enabled.</span>
<span class="sd">    :type delegate_to: string</span>
<span class="sd">    :param region: The specified region where the dataproc cluster is created.</span>
<span class="sd">    :type region: string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;variables&#39;</span><span class="p">,</span> <span class="s1">&#39;job_name&#39;</span><span class="p">,</span> <span class="s1">&#39;cluster_name&#39;</span><span class="p">,</span> <span class="s1">&#39;dataproc_jars&#39;</span><span class="p">]</span>
    <span class="n">template_ext</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;.pg&#39;</span><span class="p">,</span> <span class="s1">&#39;.pig&#39;</span><span class="p">,)</span>
    <span class="n">ui_color</span> <span class="o">=</span> <span class="s1">&#39;#0273d4&#39;</span>

    <span class="nd">@apply_defaults</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">query_uri</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">job_name</span><span class="o">=</span><span class="s1">&#39;{{task.task_id}}_{{ds_nodash}}&#39;</span><span class="p">,</span>
            <span class="n">cluster_name</span><span class="o">=</span><span class="s1">&#39;cluster-1&#39;</span><span class="p">,</span>
            <span class="n">dataproc_pig_properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">dataproc_pig_jars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">gcp_conn_id</span><span class="o">=</span><span class="s1">&#39;google_cloud_default&#39;</span><span class="p">,</span>
            <span class="n">delegate_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">region</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">DataProcPigOperator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gcp_conn_id</span> <span class="o">=</span> <span class="n">gcp_conn_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delegate_to</span> <span class="o">=</span> <span class="n">delegate_to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_uri</span> <span class="o">=</span> <span class="n">query_uri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="n">variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span> <span class="o">=</span> <span class="n">job_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span> <span class="o">=</span> <span class="n">cluster_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataproc_properties</span> <span class="o">=</span> <span class="n">dataproc_pig_properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataproc_jars</span> <span class="o">=</span> <span class="n">dataproc_pig_jars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region</span>

<div class="viewcode-block" id="DataProcPigOperator.execute"><a class="viewcode-back" href="../../../../integration.html#airflow.contrib.operators.dataproc_operator.DataProcPigOperator.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">hook</span> <span class="o">=</span> <span class="n">DataProcHook</span><span class="p">(</span><span class="n">gcp_conn_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gcp_conn_id</span><span class="p">,</span>
                            <span class="n">delegate_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delegate_to</span><span class="p">)</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">hook</span><span class="o">.</span><span class="n">create_job_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">,</span> <span class="s2">&quot;pigJob&quot;</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">dataproc_properties</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">add_query_uri</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_uri</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">add_query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">add_variables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">add_jar_file_uris</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataproc_jars</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">set_job_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">)</span>

        <span class="n">hook</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">hook</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">build</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DataProcHiveOperator"><a class="viewcode-back" href="../../../../integration.html#airflow.contrib.operators.dataproc_operator.DataProcHiveOperator">[docs]</a><span class="k">class</span> <span class="nc">DataProcHiveOperator</span><span class="p">(</span><span class="n">BaseOperator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start a Hive query Job on a Cloud DataProc cluster.</span>

<span class="sd">    :param query: The query or reference to the query file (q extension).</span>
<span class="sd">    :type query: string</span>
<span class="sd">    :param query_uri: The uri of a hive script on Cloud Storage.</span>
<span class="sd">    :type query_uri: string</span>
<span class="sd">    :param variables: Map of named parameters for the query.</span>
<span class="sd">    :type variables: dict</span>
<span class="sd">    :param job_name: The job name used in the DataProc cluster. This name by default</span>
<span class="sd">        is the task_id appended with the execution data, but can be templated. The</span>
<span class="sd">        name will always be appended with a random number to avoid name clashes.</span>
<span class="sd">    :type job_name: string</span>
<span class="sd">    :param cluster_name: The name of the DataProc cluster.</span>
<span class="sd">    :type cluster_name: string</span>
<span class="sd">    :param dataproc_hive_properties: Map for the Pig properties. Ideal to put in</span>
<span class="sd">        default arguments</span>
<span class="sd">    :type dataproc_hive_properties: dict</span>
<span class="sd">    :param dataproc_hive_jars: URIs to jars provisioned in Cloud Storage (example: for</span>
<span class="sd">        UDFs and libs) and are ideal to put in default arguments.</span>
<span class="sd">    :type dataproc_hive_jars: list</span>
<span class="sd">    :param gcp_conn_id: The connection ID to use connecting to Google Cloud Platform.</span>
<span class="sd">    :type gcp_conn_id: string</span>
<span class="sd">    :param delegate_to: The account to impersonate, if any.</span>
<span class="sd">        For this to work, the service account making the request must have domain-wide</span>
<span class="sd">        delegation enabled.</span>
<span class="sd">    :type delegate_to: string</span>
<span class="sd">    :param region: The specified region where the dataproc cluster is created.</span>
<span class="sd">    :type region: string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;variables&#39;</span><span class="p">,</span> <span class="s1">&#39;job_name&#39;</span><span class="p">,</span> <span class="s1">&#39;cluster_name&#39;</span><span class="p">,</span> <span class="s1">&#39;dataproc_jars&#39;</span><span class="p">]</span>
    <span class="n">template_ext</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;.q&#39;</span><span class="p">,)</span>
    <span class="n">ui_color</span> <span class="o">=</span> <span class="s1">&#39;#0273d4&#39;</span>

    <span class="nd">@apply_defaults</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">query_uri</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">job_name</span><span class="o">=</span><span class="s1">&#39;{{task.task_id}}_{{ds_nodash}}&#39;</span><span class="p">,</span>
            <span class="n">cluster_name</span><span class="o">=</span><span class="s1">&#39;cluster-1&#39;</span><span class="p">,</span>
            <span class="n">dataproc_hive_properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">dataproc_hive_jars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">gcp_conn_id</span><span class="o">=</span><span class="s1">&#39;google_cloud_default&#39;</span><span class="p">,</span>
            <span class="n">delegate_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">region</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">DataProcHiveOperator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gcp_conn_id</span> <span class="o">=</span> <span class="n">gcp_conn_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delegate_to</span> <span class="o">=</span> <span class="n">delegate_to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_uri</span> <span class="o">=</span> <span class="n">query_uri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="n">variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span> <span class="o">=</span> <span class="n">job_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span> <span class="o">=</span> <span class="n">cluster_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataproc_properties</span> <span class="o">=</span> <span class="n">dataproc_hive_properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataproc_jars</span> <span class="o">=</span> <span class="n">dataproc_hive_jars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region</span>

<div class="viewcode-block" id="DataProcHiveOperator.execute"><a class="viewcode-back" href="../../../../integration.html#airflow.contrib.operators.dataproc_operator.DataProcHiveOperator.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">hook</span> <span class="o">=</span> <span class="n">DataProcHook</span><span class="p">(</span><span class="n">gcp_conn_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gcp_conn_id</span><span class="p">,</span>
                            <span class="n">delegate_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delegate_to</span><span class="p">)</span>

        <span class="n">job</span> <span class="o">=</span> <span class="n">hook</span><span class="o">.</span><span class="n">create_job_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">,</span> <span class="s2">&quot;hiveJob&quot;</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">dataproc_properties</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">add_query_uri</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_uri</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">add_query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">add_variables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">add_jar_file_uris</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataproc_jars</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">set_job_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">)</span>

        <span class="n">hook</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">hook</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">build</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DataProcSparkSqlOperator"><a class="viewcode-back" href="../../../../integration.html#airflow.contrib.operators.dataproc_operator.DataProcSparkSqlOperator">[docs]</a><span class="k">class</span> <span class="nc">DataProcSparkSqlOperator</span><span class="p">(</span><span class="n">BaseOperator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start a Spark SQL query Job on a Cloud DataProc cluster.</span>

<span class="sd">    :param query: The query or reference to the query file (q extension). (templated)</span>
<span class="sd">    :type query: string</span>
<span class="sd">    :param query_uri: The uri of a spark sql script on Cloud Storage.</span>
<span class="sd">    :type query_uri: string</span>
<span class="sd">    :param variables: Map of named parameters for the query. (templated)</span>
<span class="sd">    :type variables: dict</span>
<span class="sd">    :param job_name: The job name used in the DataProc cluster. This</span>
<span class="sd">        name by default is the task_id appended with the execution data, but can</span>
<span class="sd">        be templated. The name will always be appended with a random number to</span>
<span class="sd">        avoid name clashes. (templated)</span>
<span class="sd">    :type job_name: string</span>
<span class="sd">    :param cluster_name: The name of the DataProc cluster. (templated)</span>
<span class="sd">    :type cluster_name: string</span>
<span class="sd">    :param dataproc_spark_properties: Map for the Pig properties. Ideal to put in</span>
<span class="sd">        default arguments</span>
<span class="sd">    :type dataproc_spark_properties: dict</span>
<span class="sd">    :param dataproc_spark_jars: URIs to jars provisioned in Cloud Storage (example:</span>
<span class="sd">        for UDFs and libs) and are ideal to put in default arguments.</span>
<span class="sd">    :type dataproc_spark_jars: list</span>
<span class="sd">    :param gcp_conn_id: The connection ID to use connecting to Google Cloud Platform.</span>
<span class="sd">    :type gcp_conn_id: string</span>
<span class="sd">    :param delegate_to: The account to impersonate, if any.</span>
<span class="sd">        For this to work, the service account making the request must have domain-wide</span>
<span class="sd">        delegation enabled.</span>
<span class="sd">    :type delegate_to: string</span>
<span class="sd">    :param region: The specified region where the dataproc cluster is created.</span>
<span class="sd">    :type region: string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;variables&#39;</span><span class="p">,</span> <span class="s1">&#39;job_name&#39;</span><span class="p">,</span> <span class="s1">&#39;cluster_name&#39;</span><span class="p">,</span> <span class="s1">&#39;dataproc_jars&#39;</span><span class="p">]</span>
    <span class="n">template_ext</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;.q&#39;</span><span class="p">,)</span>
    <span class="n">ui_color</span> <span class="o">=</span> <span class="s1">&#39;#0273d4&#39;</span>

    <span class="nd">@apply_defaults</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">query_uri</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">job_name</span><span class="o">=</span><span class="s1">&#39;{{task.task_id}}_{{ds_nodash}}&#39;</span><span class="p">,</span>
            <span class="n">cluster_name</span><span class="o">=</span><span class="s1">&#39;cluster-1&#39;</span><span class="p">,</span>
            <span class="n">dataproc_spark_properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">dataproc_spark_jars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">gcp_conn_id</span><span class="o">=</span><span class="s1">&#39;google_cloud_default&#39;</span><span class="p">,</span>
            <span class="n">delegate_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">region</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">DataProcSparkSqlOperator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gcp_conn_id</span> <span class="o">=</span> <span class="n">gcp_conn_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delegate_to</span> <span class="o">=</span> <span class="n">delegate_to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_uri</span> <span class="o">=</span> <span class="n">query_uri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="n">variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span> <span class="o">=</span> <span class="n">job_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span> <span class="o">=</span> <span class="n">cluster_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataproc_properties</span> <span class="o">=</span> <span class="n">dataproc_spark_properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataproc_jars</span> <span class="o">=</span> <span class="n">dataproc_spark_jars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region</span>

<div class="viewcode-block" id="DataProcSparkSqlOperator.execute"><a class="viewcode-back" href="../../../../integration.html#airflow.contrib.operators.dataproc_operator.DataProcSparkSqlOperator.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">hook</span> <span class="o">=</span> <span class="n">DataProcHook</span><span class="p">(</span><span class="n">gcp_conn_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gcp_conn_id</span><span class="p">,</span>
                            <span class="n">delegate_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delegate_to</span><span class="p">)</span>

        <span class="n">job</span> <span class="o">=</span> <span class="n">hook</span><span class="o">.</span><span class="n">create_job_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">,</span> <span class="s2">&quot;sparkSqlJob&quot;</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">dataproc_properties</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">add_query_uri</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_uri</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">add_query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">add_variables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">add_jar_file_uris</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataproc_jars</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">set_job_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">)</span>

        <span class="n">hook</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">hook</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">build</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DataProcSparkOperator"><a class="viewcode-back" href="../../../../integration.html#airflow.contrib.operators.dataproc_operator.DataProcSparkOperator">[docs]</a><span class="k">class</span> <span class="nc">DataProcSparkOperator</span><span class="p">(</span><span class="n">BaseOperator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start a Spark Job on a Cloud DataProc cluster.</span>

<span class="sd">    :param main_jar: URI of the job jar provisioned on Cloud Storage. (use this or</span>
<span class="sd">            the main_class, not both together).</span>
<span class="sd">    :type main_jar: string</span>
<span class="sd">    :param main_class: Name of the job class. (use this or the main_jar, not both</span>
<span class="sd">        together).</span>
<span class="sd">    :type main_class: string</span>
<span class="sd">    :param arguments: Arguments for the job. (templated)</span>
<span class="sd">    :type arguments: list</span>
<span class="sd">    :param archives: List of archived files that will be unpacked in the work</span>
<span class="sd">        directory. Should be stored in Cloud Storage.</span>
<span class="sd">    :type archives: list</span>
<span class="sd">    :param files: List of files to be copied to the working directory</span>
<span class="sd">    :type files: list</span>
<span class="sd">    :param job_name: The job name used in the DataProc cluster. This</span>
<span class="sd">        name by default is the task_id appended with the execution data, but can</span>
<span class="sd">        be templated. The name will always be appended with a random number to</span>
<span class="sd">        avoid name clashes. (templated)</span>
<span class="sd">    :type job_name: string</span>
<span class="sd">    :param cluster_name: The name of the DataProc cluster. (templated)</span>
<span class="sd">    :type cluster_name: string</span>
<span class="sd">    :param dataproc_spark_properties: Map for the Pig properties. Ideal to put in</span>
<span class="sd">        default arguments</span>
<span class="sd">    :type dataproc_spark_properties: dict</span>
<span class="sd">    :param dataproc_spark_jars: URIs to jars provisioned in Cloud Storage (example:</span>
<span class="sd">        for UDFs and libs) and are ideal to put in default arguments.</span>
<span class="sd">    :type dataproc_spark_jars: list</span>
<span class="sd">    :param gcp_conn_id: The connection ID to use connecting to Google Cloud Platform.</span>
<span class="sd">    :type gcp_conn_id: string</span>
<span class="sd">    :param delegate_to: The account to impersonate, if any.</span>
<span class="sd">        For this to work, the service account making the request must have domain-wide</span>
<span class="sd">        delegation enabled.</span>
<span class="sd">    :type delegate_to: string</span>
<span class="sd">    :param region: The specified region where the dataproc cluster is created.</span>
<span class="sd">    :type region: string</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;arguments&#39;</span><span class="p">,</span> <span class="s1">&#39;job_name&#39;</span><span class="p">,</span> <span class="s1">&#39;cluster_name&#39;</span><span class="p">,</span> <span class="s1">&#39;dataproc_jars&#39;</span><span class="p">]</span>
    <span class="n">ui_color</span> <span class="o">=</span> <span class="s1">&#39;#0273d4&#39;</span>

    <span class="nd">@apply_defaults</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">main_jar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">main_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">arguments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">archives</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">job_name</span><span class="o">=</span><span class="s1">&#39;{{task.task_id}}_{{ds_nodash}}&#39;</span><span class="p">,</span>
            <span class="n">cluster_name</span><span class="o">=</span><span class="s1">&#39;cluster-1&#39;</span><span class="p">,</span>
            <span class="n">dataproc_spark_properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">dataproc_spark_jars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">gcp_conn_id</span><span class="o">=</span><span class="s1">&#39;google_cloud_default&#39;</span><span class="p">,</span>
            <span class="n">delegate_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">region</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">DataProcSparkOperator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gcp_conn_id</span> <span class="o">=</span> <span class="n">gcp_conn_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delegate_to</span> <span class="o">=</span> <span class="n">delegate_to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_jar</span> <span class="o">=</span> <span class="n">main_jar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_class</span> <span class="o">=</span> <span class="n">main_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="n">arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">archives</span> <span class="o">=</span> <span class="n">archives</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span> <span class="o">=</span> <span class="n">job_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span> <span class="o">=</span> <span class="n">cluster_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataproc_properties</span> <span class="o">=</span> <span class="n">dataproc_spark_properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataproc_jars</span> <span class="o">=</span> <span class="n">dataproc_spark_jars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region</span>

<div class="viewcode-block" id="DataProcSparkOperator.execute"><a class="viewcode-back" href="../../../../integration.html#airflow.contrib.operators.dataproc_operator.DataProcSparkOperator.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">hook</span> <span class="o">=</span> <span class="n">DataProcHook</span><span class="p">(</span><span class="n">gcp_conn_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gcp_conn_id</span><span class="p">,</span>
                            <span class="n">delegate_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delegate_to</span><span class="p">)</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">hook</span><span class="o">.</span><span class="n">create_job_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">,</span> <span class="s2">&quot;sparkJob&quot;</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">dataproc_properties</span><span class="p">)</span>

        <span class="n">job</span><span class="o">.</span><span class="n">set_main</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_jar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_class</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">add_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">add_jar_file_uris</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataproc_jars</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">add_archive_uris</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archives</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">add_file_uris</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">set_job_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">)</span>

        <span class="n">hook</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">hook</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">build</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DataProcHadoopOperator"><a class="viewcode-back" href="../../../../integration.html#airflow.contrib.operators.dataproc_operator.DataProcHadoopOperator">[docs]</a><span class="k">class</span> <span class="nc">DataProcHadoopOperator</span><span class="p">(</span><span class="n">BaseOperator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start a Hadoop Job on a Cloud DataProc cluster.</span>

<span class="sd">    :param main_jar: URI of the job jar provisioned on Cloud Storage. (use this or</span>
<span class="sd">            the main_class, not both together).</span>
<span class="sd">    :type main_jar: string</span>
<span class="sd">    :param main_class: Name of the job class. (use this or the main_jar, not both</span>
<span class="sd">        together).</span>
<span class="sd">    :type main_class: string</span>
<span class="sd">    :param arguments: Arguments for the job. (templated)</span>
<span class="sd">    :type arguments: list</span>
<span class="sd">    :param archives: List of archived files that will be unpacked in the work</span>
<span class="sd">        directory. Should be stored in Cloud Storage.</span>
<span class="sd">    :type archives: list</span>
<span class="sd">    :param files: List of files to be copied to the working directory</span>
<span class="sd">    :type files: list</span>
<span class="sd">    :param job_name: The job name used in the DataProc cluster. This</span>
<span class="sd">        name by default is the task_id appended with the execution data, but can</span>
<span class="sd">        be templated. The name will always be appended with a random number to</span>
<span class="sd">        avoid name clashes. (templated)</span>
<span class="sd">    :type job_name: string</span>
<span class="sd">    :param cluster_name: The name of the DataProc cluster. (templated)</span>
<span class="sd">    :type cluster_name: string</span>
<span class="sd">    :param dataproc_hadoop_properties: Map for the Pig properties. Ideal to put in</span>
<span class="sd">        default arguments</span>
<span class="sd">    :type dataproc_hadoop_properties: dict</span>
<span class="sd">    :param dataproc_hadoop_jars: URIs to jars provisioned in Cloud Storage (example:</span>
<span class="sd">        for UDFs and libs) and are ideal to put in default arguments.</span>
<span class="sd">    :type dataproc_hadoop_jars: list</span>
<span class="sd">    :param gcp_conn_id: The connection ID to use connecting to Google Cloud Platform.</span>
<span class="sd">    :type gcp_conn_id: string</span>
<span class="sd">    :param delegate_to: The account to impersonate, if any.</span>
<span class="sd">        For this to work, the service account making the request must have domain-wide</span>
<span class="sd">        delegation enabled.</span>
<span class="sd">    :type delegate_to: string</span>
<span class="sd">    :param region: The specified region where the dataproc cluster is created.</span>
<span class="sd">    :type region: string</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;arguments&#39;</span><span class="p">,</span> <span class="s1">&#39;job_name&#39;</span><span class="p">,</span> <span class="s1">&#39;cluster_name&#39;</span><span class="p">,</span> <span class="s1">&#39;dataproc_jars&#39;</span><span class="p">]</span>
    <span class="n">ui_color</span> <span class="o">=</span> <span class="s1">&#39;#0273d4&#39;</span>

    <span class="nd">@apply_defaults</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">main_jar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">main_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">arguments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">archives</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">job_name</span><span class="o">=</span><span class="s1">&#39;{{task.task_id}}_{{ds_nodash}}&#39;</span><span class="p">,</span>
            <span class="n">cluster_name</span><span class="o">=</span><span class="s1">&#39;cluster-1&#39;</span><span class="p">,</span>
            <span class="n">dataproc_hadoop_properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">dataproc_hadoop_jars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">gcp_conn_id</span><span class="o">=</span><span class="s1">&#39;google_cloud_default&#39;</span><span class="p">,</span>
            <span class="n">delegate_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">region</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">DataProcHadoopOperator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gcp_conn_id</span> <span class="o">=</span> <span class="n">gcp_conn_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delegate_to</span> <span class="o">=</span> <span class="n">delegate_to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_jar</span> <span class="o">=</span> <span class="n">main_jar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_class</span> <span class="o">=</span> <span class="n">main_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="n">arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">archives</span> <span class="o">=</span> <span class="n">archives</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span> <span class="o">=</span> <span class="n">job_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span> <span class="o">=</span> <span class="n">cluster_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataproc_properties</span> <span class="o">=</span> <span class="n">dataproc_hadoop_properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataproc_jars</span> <span class="o">=</span> <span class="n">dataproc_hadoop_jars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region</span>

<div class="viewcode-block" id="DataProcHadoopOperator.execute"><a class="viewcode-back" href="../../../../integration.html#airflow.contrib.operators.dataproc_operator.DataProcHadoopOperator.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">hook</span> <span class="o">=</span> <span class="n">DataProcHook</span><span class="p">(</span><span class="n">gcp_conn_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gcp_conn_id</span><span class="p">,</span>
                            <span class="n">delegate_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delegate_to</span><span class="p">)</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">hook</span><span class="o">.</span><span class="n">create_job_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">,</span> <span class="s2">&quot;hadoopJob&quot;</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">dataproc_properties</span><span class="p">)</span>

        <span class="n">job</span><span class="o">.</span><span class="n">set_main</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_jar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_class</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">add_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">add_jar_file_uris</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataproc_jars</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">add_archive_uris</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archives</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">add_file_uris</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">set_job_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">)</span>

        <span class="n">hook</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">hook</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">build</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DataProcPySparkOperator"><a class="viewcode-back" href="../../../../integration.html#airflow.contrib.operators.dataproc_operator.DataProcPySparkOperator">[docs]</a><span class="k">class</span> <span class="nc">DataProcPySparkOperator</span><span class="p">(</span><span class="n">BaseOperator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start a PySpark Job on a Cloud DataProc cluster.</span>

<span class="sd">    :param main: [Required] The Hadoop Compatible Filesystem (HCFS) URI of the main</span>
<span class="sd">            Python file to use as the driver. Must be a .py file.</span>
<span class="sd">    :type main: string</span>
<span class="sd">    :param arguments: Arguments for the job. (templated)</span>
<span class="sd">    :type arguments: list</span>
<span class="sd">    :param archives: List of archived files that will be unpacked in the work</span>
<span class="sd">        directory. Should be stored in Cloud Storage.</span>
<span class="sd">    :type archives: list</span>
<span class="sd">    :param files: List of files to be copied to the working directory</span>
<span class="sd">    :type files: list</span>
<span class="sd">    :param pyfiles: List of Python files to pass to the PySpark framework.</span>
<span class="sd">        Supported file types: .py, .egg, and .zip</span>
<span class="sd">    :type pyfiles: list</span>
<span class="sd">    :param job_name: The job name used in the DataProc cluster. This</span>
<span class="sd">        name by default is the task_id appended with the execution data, but can</span>
<span class="sd">        be templated. The name will always be appended with a random number to</span>
<span class="sd">        avoid name clashes. (templated)</span>
<span class="sd">    :type job_name: string</span>
<span class="sd">    :param cluster_name: The name of the DataProc cluster.</span>
<span class="sd">    :type cluster_name: string</span>
<span class="sd">    :param dataproc_pyspark_properties: Map for the Pig properties. Ideal to put in</span>
<span class="sd">        default arguments</span>
<span class="sd">    :type dataproc_pyspark_properties: dict</span>
<span class="sd">    :param dataproc_pyspark_jars: URIs to jars provisioned in Cloud Storage (example:</span>
<span class="sd">        for UDFs and libs) and are ideal to put in default arguments.</span>
<span class="sd">    :type dataproc_pyspark_jars: list</span>
<span class="sd">    :param gcp_conn_id: The connection ID to use connecting to Google Cloud Platform.</span>
<span class="sd">    :type gcp_conn_id: string</span>
<span class="sd">    :param delegate_to: The account to impersonate, if any.</span>
<span class="sd">        For this to work, the service account making the request must have</span>
<span class="sd">        domain-wide delegation enabled.</span>
<span class="sd">    :type delegate_to: string</span>
<span class="sd">    :param region: The specified region where the dataproc cluster is created.</span>
<span class="sd">    :type region: string</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;arguments&#39;</span><span class="p">,</span> <span class="s1">&#39;job_name&#39;</span><span class="p">,</span> <span class="s1">&#39;cluster_name&#39;</span><span class="p">,</span> <span class="s1">&#39;dataproc_jars&#39;</span><span class="p">]</span>
    <span class="n">ui_color</span> <span class="o">=</span> <span class="s1">&#39;#0273d4&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_generate_temp_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">())[:</span><span class="mi">8</span><span class="p">],</span> <span class="n">ntpath</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Upload a local file to a Google Cloud Storage bucket</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_upload_file_temp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">local_file</span><span class="p">):</span>
        <span class="n">temp_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_temp_filename</span><span class="p">(</span><span class="n">local_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bucket</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AirflowException</span><span class="p">(</span>
                <span class="s2">&quot;If you want Airflow to upload the local file to a temporary bucket, set &quot;</span>
                <span class="s2">&quot;the &#39;temp_bucket&#39; key in the connection string&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Uploading </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">temp_filename</span><span class="p">)</span>

        <span class="n">GoogleCloudStorageHook</span><span class="p">(</span>
            <span class="n">google_cloud_storage_conn_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gcp_conn_id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span>
            <span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span>
            <span class="nb">object</span><span class="o">=</span><span class="n">temp_filename</span><span class="p">,</span>
            <span class="n">mime_type</span><span class="o">=</span><span class="s1">&#39;application/x-python&#39;</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">local_file</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;gs://</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">temp_filename</span><span class="p">)</span>

    <span class="nd">@apply_defaults</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">main</span><span class="p">,</span>
            <span class="n">arguments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">archives</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">pyfiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">job_name</span><span class="o">=</span><span class="s1">&#39;{{task.task_id}}_{{ds_nodash}}&#39;</span><span class="p">,</span>
            <span class="n">cluster_name</span><span class="o">=</span><span class="s1">&#39;cluster-1&#39;</span><span class="p">,</span>
            <span class="n">dataproc_pyspark_properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">dataproc_pyspark_jars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">gcp_conn_id</span><span class="o">=</span><span class="s1">&#39;google_cloud_default&#39;</span><span class="p">,</span>
            <span class="n">delegate_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">region</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">DataProcPySparkOperator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gcp_conn_id</span> <span class="o">=</span> <span class="n">gcp_conn_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delegate_to</span> <span class="o">=</span> <span class="n">delegate_to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main</span> <span class="o">=</span> <span class="n">main</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="n">arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">archives</span> <span class="o">=</span> <span class="n">archives</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pyfiles</span> <span class="o">=</span> <span class="n">pyfiles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span> <span class="o">=</span> <span class="n">job_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span> <span class="o">=</span> <span class="n">cluster_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataproc_properties</span> <span class="o">=</span> <span class="n">dataproc_pyspark_properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataproc_jars</span> <span class="o">=</span> <span class="n">dataproc_pyspark_jars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region</span>

<div class="viewcode-block" id="DataProcPySparkOperator.execute"><a class="viewcode-back" href="../../../../integration.html#airflow.contrib.operators.dataproc_operator.DataProcPySparkOperator.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">hook</span> <span class="o">=</span> <span class="n">DataProcHook</span><span class="p">(</span>
            <span class="n">gcp_conn_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gcp_conn_id</span><span class="p">,</span>
            <span class="n">delegate_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delegate_to</span>
        <span class="p">)</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">hook</span><span class="o">.</span><span class="n">create_job_template</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">,</span> <span class="s2">&quot;pysparkJob&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataproc_properties</span><span class="p">)</span>

        <span class="c1">#  Check if the file is local, if that is the case, upload it to a bucket</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">):</span>
            <span class="n">cluster_info</span> <span class="o">=</span> <span class="n">hook</span><span class="o">.</span><span class="n">get_cluster</span><span class="p">(</span>
                <span class="n">project_id</span><span class="o">=</span><span class="n">hook</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span>
                <span class="n">region</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span>
                <span class="n">cluster_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span>
            <span class="p">)</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="n">cluster_info</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;configBucket&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upload_file_temp</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">set_python_main</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">)</span>

        <span class="n">job</span><span class="o">.</span><span class="n">add_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">add_jar_file_uris</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataproc_jars</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">add_archive_uris</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archives</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">add_file_uris</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">add_python_file_uris</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pyfiles</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">set_job_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">)</span>

        <span class="n">hook</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">hook</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">build</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DataprocWorkflowTemplateBaseOperator"><a class="viewcode-back" href="../../../../code.html#airflow.contrib.operators.dataproc_operator.DataprocWorkflowTemplateBaseOperator">[docs]</a><span class="k">class</span> <span class="nc">DataprocWorkflowTemplateBaseOperator</span><span class="p">(</span><span class="n">BaseOperator</span><span class="p">):</span>
    <span class="nd">@apply_defaults</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">project_id</span><span class="p">,</span>
                 <span class="n">region</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span>
                 <span class="n">gcp_conn_id</span><span class="o">=</span><span class="s1">&#39;google_cloud_default&#39;</span><span class="p">,</span>
                 <span class="n">delegate_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DataprocWorkflowTemplateBaseOperator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gcp_conn_id</span> <span class="o">=</span> <span class="n">gcp_conn_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delegate_to</span> <span class="o">=</span> <span class="n">delegate_to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="n">project_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hook</span> <span class="o">=</span> <span class="n">DataProcHook</span><span class="p">(</span>
            <span class="n">gcp_conn_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gcp_conn_id</span><span class="p">,</span>
            <span class="n">delegate_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delegate_to</span><span class="p">,</span>
            <span class="n">api_version</span><span class="o">=</span><span class="s1">&#39;v1beta2&#39;</span>
        <span class="p">)</span>

<div class="viewcode-block" id="DataprocWorkflowTemplateBaseOperator.execute"><a class="viewcode-back" href="../../../../code.html#airflow.contrib.operators.dataproc_operator.DataprocWorkflowTemplateBaseOperator.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">AirflowException</span><span class="p">(</span><span class="s1">&#39;plese start a workflow operation&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DataprocWorkflowTemplateInstantiateOperator"><a class="viewcode-back" href="../../../../integration.html#airflow.contrib.operators.dataproc_operator.DataprocWorkflowTemplateInstantiateOperator">[docs]</a><span class="k">class</span> <span class="nc">DataprocWorkflowTemplateInstantiateOperator</span><span class="p">(</span><span class="n">DataprocWorkflowTemplateBaseOperator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Instantiate a WorkflowTemplate on Google Cloud Dataproc. The operator will wait</span>
<span class="sd">    until the WorkflowTemplate is finished executing.</span>

<span class="sd">    .. seealso::</span>
<span class="sd">        Please refer to:</span>
<span class="sd">        https://cloud.google.com/dataproc/docs/reference/rest/v1beta2/projects.regions.workflowTemplates/instantiate</span>

<span class="sd">    :param template_id: The id of the template. (templated)</span>
<span class="sd">    :type template_id: string</span>
<span class="sd">    :param project_id: The ID of the google cloud project in which</span>
<span class="sd">        the template runs</span>
<span class="sd">    :type project_id: string</span>
<span class="sd">    :param region: leave as &#39;global&#39;, might become relevant in the future</span>
<span class="sd">    :type region: string</span>
<span class="sd">    :param gcp_conn_id: The connection ID to use connecting to Google Cloud Platform.</span>
<span class="sd">    :type gcp_conn_id: string</span>
<span class="sd">    :param delegate_to: The account to impersonate, if any.</span>
<span class="sd">        For this to work, the service account making the request must have domain-wide</span>
<span class="sd">        delegation enabled.</span>
<span class="sd">    :type delegate_to: string</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;template_id&#39;</span><span class="p">]</span>

    <span class="nd">@apply_defaults</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_id</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">DataprocWorkflowTemplateInstantiateOperator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_id</span> <span class="o">=</span> <span class="n">template_id</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Instantiating Template: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">get_conn</span><span class="p">()</span><span class="o">.</span><span class="n">projects</span><span class="p">()</span><span class="o">.</span><span class="n">regions</span><span class="p">()</span><span class="o">.</span><span class="n">workflowTemplates</span><span class="p">()</span>
            <span class="o">.</span><span class="n">instantiate</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;projects/</span><span class="si">%s</span><span class="s1">/regions/</span><span class="si">%s</span><span class="s1">/workflowTemplates/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_id</span><span class="p">)),</span>
                <span class="n">body</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;instanceId&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">())})</span>
            <span class="o">.</span><span class="n">execute</span><span class="p">())</span></div>


<div class="viewcode-block" id="DataprocWorkflowTemplateInstantiateInlineOperator"><a class="viewcode-back" href="../../../../integration.html#airflow.contrib.operators.dataproc_operator.DataprocWorkflowTemplateInstantiateInlineOperator">[docs]</a><span class="k">class</span> <span class="nc">DataprocWorkflowTemplateInstantiateInlineOperator</span><span class="p">(</span>
        <span class="n">DataprocWorkflowTemplateBaseOperator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Instantiate a WorkflowTemplate Inline on Google Cloud Dataproc. The operator will</span>
<span class="sd">    wait until the WorkflowTemplate is finished executing.</span>

<span class="sd">    .. seealso::</span>
<span class="sd">        Please refer to:</span>
<span class="sd">        https://cloud.google.com/dataproc/docs/reference/rest/v1beta2/projects.regions.workflowTemplates/instantiateInline</span>

<span class="sd">    :param template: The template contents. (templated)</span>
<span class="sd">    :type template: map</span>
<span class="sd">    :param project_id: The ID of the google cloud project in which</span>
<span class="sd">        the template runs</span>
<span class="sd">    :type project_id: string</span>
<span class="sd">    :param region: leave as &#39;global&#39;, might become relevant in the future</span>
<span class="sd">    :type region: string</span>
<span class="sd">    :param gcp_conn_id: The connection ID to use connecting to Google Cloud Platform.</span>
<span class="sd">    :type gcp_conn_id: string</span>
<span class="sd">    :param delegate_to: The account to impersonate, if any.</span>
<span class="sd">        For this to work, the service account making the request must have domain-wide</span>
<span class="sd">        delegation enabled.</span>
<span class="sd">    :type delegate_to: string</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span>

    <span class="nd">@apply_defaults</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">DataprocWorkflowTemplateInstantiateInlineOperator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">template</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Instantiating Inline Template&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">get_conn</span><span class="p">()</span><span class="o">.</span><span class="n">projects</span><span class="p">()</span><span class="o">.</span><span class="n">regions</span><span class="p">()</span><span class="o">.</span><span class="n">workflowTemplates</span><span class="p">()</span>
            <span class="o">.</span><span class="n">instantiateInline</span><span class="p">(</span>
                <span class="n">parent</span><span class="o">=</span><span class="s1">&#39;projects/</span><span class="si">%s</span><span class="s1">/regions/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">),</span>
                <span class="n">instanceId</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">()),</span>
                <span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">)</span>
            <span class="o">.</span><span class="n">execute</span><span class="p">())</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>
